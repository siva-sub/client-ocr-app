<!DOCTYPE html>
<html>
<head>
    <title>PDF OCR Test - Compare with Tesseract</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .header {
            background: #3f51b5;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .pdf-viewer {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #pdfCanvas {
            border: 1px solid #ddd;
            max-width: 100%;
            height: auto;
        }
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .result-section {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-section h3 {
            margin-top: 0;
            padding: 10px;
            border-radius: 4px;
            color: white;
            text-align: center;
        }
        .tesseract h3 { background: #4CAF50; }
        .paddle h3 { background: #2196F3; }
        .results {
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .structure-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        .structure-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        .heading-1 { font-weight: bold; font-size: 16px; color: #1976d2; }
        .heading-2 { font-weight: bold; font-size: 14px; color: #1565c0; margin-left: 20px; }
        .heading-3 { font-weight: bold; font-size: 13px; color: #0d47a1; margin-left: 40px; }
        .paragraph { margin-left: 10px; }
        .list-item { margin-left: 30px; font-style: italic; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .metric {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
        .metric-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .info { background: #d1ecf1; color: #0c5460; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .page-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .search-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .search-results {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .search-result {
            padding: 8px;
            margin: 5px 0;
            background: #fffbdd;
            border: 1px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-result:hover {
            background: #fff9c4;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        .better { background: #c8e6c9; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÑ PDF OCR Test - Structure Extraction & Search</h1>
        <p>Test PDF-optimized OCR configuration against Tesseract baseline</p>
    </div>
    
    <div class="controls">
        <h3>Load PDF Document</h3>
        <input type="file" id="fileInput" accept="application/pdf,image/*">
        <button id="processBtn" disabled>üöÄ Process with Both Engines</button>
        <button id="clearBtn">üóëÔ∏è Clear Results</button>
    </div>
    
    <div id="status" class="status info">Initializing OCR engines...</div>
    
    <div class="pdf-viewer" id="pdfViewer" style="display: none;">
        <h3>PDF Preview</h3>
        <div class="page-controls">
            <button id="prevPage">‚Üê Previous</button>
            <span>Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button id="nextPage">Next ‚Üí</button>
            <button id="processAllPages">Process All Pages</button>
        </div>
        <canvas id="pdfCanvas"></canvas>
    </div>
    
    <div class="results-container" id="resultsContainer" style="display: none;">
        <div class="result-section tesseract">
            <h3>Tesseract OCR Results</h3>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-label">Time</div>
                    <div class="metric-value" id="tesseractTime">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Regions</div>
                    <div class="metric-value" id="tesseractRegions">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Words</div>
                    <div class="metric-value" id="tesseractWords">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Confidence</div>
                    <div class="metric-value" id="tesseractConfidence">-</div>
                </div>
            </div>
            <div class="results" id="tesseractResults">No results yet</div>
        </div>
        
        <div class="result-section paddle">
            <h3>PaddleOCR PDF Mode Results</h3>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-label">Time</div>
                    <div class="metric-value" id="paddleTime">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Regions</div>
                    <div class="metric-value" id="paddleRegions">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Words</div>
                    <div class="metric-value" id="paddleWords">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Confidence</div>
                    <div class="metric-value" id="paddleConfidence">-</div>
                </div>
            </div>
            <div class="results" id="paddleResults">No results yet</div>
            <div class="structure-section" id="paddleStructure" style="display: none;">
                <h4>Extracted Structure:</h4>
                <div id="structureContent"></div>
            </div>
        </div>
    </div>
    
    <div class="search-section" id="searchSection" style="display: none;">
        <h3>üîç Search in PDF (PaddleOCR Results)</h3>
        <input type="text" class="search-input" id="searchInput" placeholder="Search for text in the PDF...">
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <div class="comparison-table" id="comparisonSection" style="display: none;">
        <h3>üìä Comparison Summary</h3>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Tesseract</th>
                    <th>PaddleOCR PDF Mode</th>
                    <th>Winner</th>
                </tr>
            </thead>
            <tbody id="comparisonBody"></tbody>
        </table>
        <div id="recommendation" style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 4px;"></div>
    </div>

    <script type="module">
        import { ppOCRImprovedEngine } from './src/ppocr-improved-engine.js';
        import { tesseractOCREngine } from './src/tesseract-ocr-engine.js';
        import { 
            PDF_OCR_CONFIG, 
            updatePaddleOCRForPDF,
            extractPDFStructure,
            createPDFSearchHighlighter 
        } from './src/pdf-ocr-config.js';
        import * as pdfjsLib from 'pdfjs-dist';
        
        // Configure PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = '/client-ocr-app/pdf.worker.min.js';
        
        let currentPDF = null;
        let currentPage = 1;
        let totalPages = 0;
        let currentImage = null;
        let searchHighlighter = null;
        let allPaddleResults = [];
        
        // Initialize OCR engines
        async function initializeOCR() {
            setStatus('Initializing OCR engines...', 'info');
            try {
                await Promise.all([
                    ppOCRImprovedEngine.initialize((progress) => {
                        console.log('PaddleOCR:', progress.message);
                    }),
                    tesseractOCREngine.initialize((progress) => {
                        console.log('Tesseract:', progress.message);
                    })
                ]);
                setStatus('OCR engines ready! Load a PDF or image to begin.', 'success');
                document.getElementById('processBtn').disabled = false;
            } catch (error) {
                setStatus('Failed to initialize OCR: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.type === 'application/pdf') {
                await loadPDF(file);
            } else if (file.type.startsWith('image/')) {
                await loadImage(file);
            } else {
                setStatus('Please select a PDF or image file', 'error');
            }
        });
        
        // Load PDF
        async function loadPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                currentPDF = await pdfjsLib.getDocument(arrayBuffer).promise;
                totalPages = currentPDF.numPages;
                currentPage = 1;
                
                document.getElementById('totalPages').textContent = totalPages;
                document.getElementById('pdfViewer').style.display = 'block';
                
                await renderPDFPage(currentPage);
                setStatus(`PDF loaded: ${totalPages} pages. Click "Process with Both Engines" to OCR current page.`, 'success');
            } catch (error) {
                setStatus('Failed to load PDF: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Render PDF page
        async function renderPDFPage(pageNumber) {
            const page = await currentPDF.getPage(pageNumber);
            const canvas = document.getElementById('pdfCanvas');
            const ctx = canvas.getContext('2d');
            
            const viewport = page.getViewport({ scale: 1.5 });
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
            
            document.getElementById('currentPage').textContent = pageNumber;
            
            // Convert canvas to image for OCR
            canvas.toBlob((blob) => {
                currentImage = blob;
            });
        }
        
        // Load image
        async function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('pdfCanvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    document.getElementById('pdfViewer').style.display = 'block';
                    document.querySelector('.page-controls').style.display = 'none';
                    
                    canvas.toBlob((blob) => {
                        currentImage = blob;
                        setStatus('Image loaded. Click "Process with Both Engines" to begin OCR.', 'success');
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Page navigation
        document.getElementById('prevPage').addEventListener('click', async () => {
            if (currentPage > 1) {
                currentPage--;
                await renderPDFPage(currentPage);
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', async () => {
            if (currentPage < totalPages) {
                currentPage++;
                await renderPDFPage(currentPage);
            }
        });
        
        // Process current page
        document.getElementById('processBtn').addEventListener('click', async () => {
            if (!currentImage) {
                setStatus('Please load a PDF or image first', 'error');
                return;
            }
            
            setStatus('Processing with both OCR engines...', 'info');
            document.getElementById('resultsContainer').style.display = 'grid';
            document.getElementById('searchSection').style.display = 'none';
            
            try {
                // Process with Tesseract
                const tesseractStart = Date.now();
                const tesseractResults = await tesseractOCREngine.process(currentImage);
                const tesseractTime = Date.now() - tesseractStart;
                
                // Process with PaddleOCR in PDF mode
                updatePaddleOCRForPDF(ppOCRImprovedEngine);
                const paddleStart = Date.now();
                const paddleResults = await ppOCRImprovedEngine.process(currentImage);
                const paddleTime = Date.now() - paddleStart;
                
                // Display results
                displayTesseractResults(tesseractResults, tesseractTime);
                displayPaddleResults(paddleResults, paddleTime);
                
                // Show comparison
                showComparison(tesseractResults, paddleResults, tesseractTime, paddleTime);
                
                setStatus('Processing complete!', 'success');
            } catch (error) {
                setStatus('Processing failed: ' + error.message, 'error');
                console.error(error);
            }
        });
        
        // Display Tesseract results
        function displayTesseractResults(results, processingTime) {
            const metrics = calculateMetrics(results);
            
            document.getElementById('tesseractTime').textContent = `${processingTime}ms`;
            document.getElementById('tesseractRegions').textContent = metrics.regions;
            document.getElementById('tesseractWords').textContent = metrics.words;
            document.getElementById('tesseractConfidence').textContent = `${metrics.confidence}%`;
            
            const resultsDiv = document.getElementById('tesseractResults');
            if (!results || results.length === 0) {
                resultsDiv.textContent = 'No text detected';
                return;
            }
            
            let output = '=== Tesseract OCR Results ===\n\n';
            const text = results.map(r => r.text).join('\n');
            output += text;
            
            resultsDiv.textContent = output;
        }
        
        // Display PaddleOCR results
        function displayPaddleResults(results, processingTime) {
            allPaddleResults = results;
            const metrics = calculateMetrics(results);
            
            document.getElementById('paddleTime').textContent = `${processingTime}ms`;
            document.getElementById('paddleRegions').textContent = metrics.regions;
            document.getElementById('paddleWords').textContent = metrics.words;
            document.getElementById('paddleConfidence').textContent = `${metrics.confidence}%`;
            
            const resultsDiv = document.getElementById('paddleResults');
            if (!results || results.length === 0) {
                resultsDiv.textContent = 'No text detected';
                return;
            }
            
            // Extract structure
            const structure = extractPDFStructure(results, currentPage);
            
            let output = '=== PaddleOCR PDF Mode Results ===\n\n';
            
            // Sort results by position
            const sortedResults = [...results].sort((a, b) => {
                const aY = a.box ? Math.min(...a.box.map(p => p[1])) : 0;
                const bY = b.box ? Math.min(...b.box.map(p => p[1])) : 0;
                return aY - bY;
            });
            
            sortedResults.forEach(result => {
                output += result.text + '\n';
            });
            
            resultsDiv.textContent = output;
            
            // Display structure
            displayStructure(structure);
            
            // Enable search
            setupSearch(results);
        }
        
        // Display extracted structure
        function displayStructure(structure) {
            const structureDiv = document.getElementById('paddleStructure');
            const contentDiv = document.getElementById('structureContent');
            
            structureDiv.style.display = 'block';
            contentDiv.innerHTML = '';
            
            // Headings
            if (structure.headings.length > 0) {
                const headingsDiv = document.createElement('div');
                headingsDiv.innerHTML = '<h5>Headings:</h5>';
                structure.headings.forEach(heading => {
                    const div = document.createElement('div');
                    div.className = `structure-item heading-${heading.level}`;
                    div.textContent = heading.text;
                    headingsDiv.appendChild(div);
                });
                contentDiv.appendChild(headingsDiv);
            }
            
            // Lists
            if (structure.lists.length > 0) {
                const listsDiv = document.createElement('div');
                listsDiv.innerHTML = '<h5>List Items:</h5>';
                structure.lists.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'structure-item list-item';
                    div.textContent = `${item.type}: ${item.text}`;
                    listsDiv.appendChild(div);
                });
                contentDiv.appendChild(listsDiv);
            }
            
            // Page info
            if (structure.pageNumber) {
                const pageDiv = document.createElement('div');
                pageDiv.innerHTML = `<h5>Page Number: ${structure.pageNumber}</h5>`;
                contentDiv.appendChild(pageDiv);
            }
        }
        
        // Setup search functionality
        function setupSearch(results) {
            const searchSection = document.getElementById('searchSection');
            searchSection.style.display = 'block';
            
            searchHighlighter = createPDFSearchHighlighter(results);
            
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (!query) {
                    document.getElementById('searchResults').innerHTML = '';
                    return;
                }
                
                const matches = searchHighlighter.search(query);
                displaySearchResults(matches);
            });
        }
        
        // Display search results
        function displaySearchResults(matches) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">No matches found</div>';
                return;
            }
            
            resultsDiv.innerHTML = `<div style="padding: 10px; font-weight: bold;">${matches.length} matches found:</div>`;
            
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'search-result';
                div.textContent = match.originalText;
                div.onclick = () => highlightResult(match);
                resultsDiv.appendChild(div);
            });
        }
        
        // Highlight search result
        function highlightResult(match) {
            // In a real implementation, this would highlight the text on the canvas
            console.log('Highlighting:', match);
            alert(`Found: "${match.originalText}"\n\nIn a full implementation, this would highlight the text on the PDF canvas.`);
        }
        
        // Calculate metrics
        function calculateMetrics(results) {
            if (!results || results.length === 0) {
                return { regions: 0, words: 0, confidence: 0 };
            }
            
            const allText = results.map(r => r.text).join(' ');
            const words = allText.split(/\s+/).filter(w => w.length > 0).length;
            const totalConfidence = results.reduce((sum, r) => sum + (r.confidence || 0), 0);
            const avgConfidence = Math.round((totalConfidence / results.length) * 100);
            
            return {
                regions: results.length,
                words,
                confidence: avgConfidence
            };
        }
        
        // Show comparison
        function showComparison(tesseractResults, paddleResults, tesseractTime, paddleTime) {
            const compSection = document.getElementById('comparisonSection');
            compSection.style.display = 'block';
            
            const tesseractMetrics = calculateMetrics(tesseractResults);
            const paddleMetrics = calculateMetrics(paddleResults);
            
            const tbody = document.getElementById('comparisonBody');
            tbody.innerHTML = '';
            
            // Processing time
            addComparisonRow('Processing Time', `${tesseractTime}ms`, `${paddleTime}ms`, 
                            tesseractTime < paddleTime ? 'Tesseract' : 'PaddleOCR');
            
            // Regions detected
            addComparisonRow('Regions Detected', tesseractMetrics.regions, paddleMetrics.regions,
                            tesseractMetrics.regions > paddleMetrics.regions ? 'Tesseract' : 'PaddleOCR');
            
            // Words extracted
            addComparisonRow('Words Extracted', tesseractMetrics.words, paddleMetrics.words,
                            tesseractMetrics.words > paddleMetrics.words ? 'Tesseract' : 'PaddleOCR');
            
            // Confidence
            addComparisonRow('Average Confidence', `${tesseractMetrics.confidence}%`, `${paddleMetrics.confidence}%`,
                            tesseractMetrics.confidence > paddleMetrics.confidence ? 'Tesseract' : 'PaddleOCR');
            
            // Generate recommendation
            generateRecommendation(tesseractMetrics, paddleMetrics, tesseractTime, paddleTime);
        }
        
        // Add comparison row
        function addComparisonRow(metric, tesseractValue, paddleValue, winner) {
            const tbody = document.getElementById('comparisonBody');
            const row = document.createElement('tr');
            
            const tesseractClass = winner === 'Tesseract' ? 'better' : '';
            const paddleClass = winner === 'PaddleOCR' ? 'better' : '';
            
            row.innerHTML = `
                <td>${metric}</td>
                <td class="${tesseractClass}">${tesseractValue}</td>
                <td class="${paddleClass}">${paddleValue}</td>
                <td>${winner}</td>
            `;
            
            tbody.appendChild(row);
        }
        
        // Generate recommendation
        function generateRecommendation(tesseractMetrics, paddleMetrics, tesseractTime, paddleTime) {
            const recDiv = document.getElementById('recommendation');
            
            let recommendation = '<h4>üí° Recommendation:</h4>';
            
            const paddleScore = paddleMetrics.words * 2 + paddleMetrics.confidence - (paddleTime / 10);
            const tesseractScore = tesseractMetrics.words * 2 + tesseractMetrics.confidence - (tesseractTime / 10);
            
            if (paddleScore > tesseractScore * 1.1) {
                recommendation += `<p><strong>PaddleOCR PDF Mode</strong> is recommended for this document. `;
                recommendation += `It extracted ${((paddleMetrics.words - tesseractMetrics.words) / tesseractMetrics.words * 100).toFixed(1)}% more words `;
                recommendation += `and provides structure extraction and search capabilities.</p>`;
            } else if (tesseractScore > paddleScore * 1.1) {
                recommendation += `<p><strong>Tesseract</strong> performs better on this document with `;
                recommendation += `${tesseractMetrics.confidence}% confidence and faster processing.</p>`;
            } else {
                recommendation += `<p>Both engines show similar performance. <strong>PaddleOCR PDF Mode</strong> `;
                recommendation += `offers additional features like structure extraction and search, making it a good choice for PDFs.</p>`;
            }
            
            recDiv.innerHTML = recommendation;
        }
        
        // Clear results
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('comparisonSection').style.display = 'none';
            allPaddleResults = [];
            searchHighlighter = null;
            setStatus('Results cleared', 'info');
        });
        
        // Process all pages (placeholder)
        document.getElementById('processAllPages').addEventListener('click', () => {
            alert('Processing all pages would iterate through each page and aggregate results. This is a placeholder for the demo.');
        });
        
        // Set status
        function setStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // Initialize on load
        window.addEventListener('load', initializeOCR);
    </script>
</body>
</html>