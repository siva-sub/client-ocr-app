<!DOCTYPE html>
<html>
<head>
    <title>Receipt OCR Direct Comparison - PaddleOCR vs Tesseract</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            background: #4CAF50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            padding: 15px 30px;
            margin: 10px;
            cursor: pointer;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
        }
        .image-preview {
            text-align: center;
            margin: 20px 0;
        }
        #receiptImage {
            max-width: 600px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result-card h3 {
            margin-top: 0;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            color: white;
            text-align: center;
        }
        .tesseract h3 { background: #607D8B; }
        .paddle-receipt h3 { background: #4CAF50; }
        .paddle-pdf h3 { background: #FF9800; }
        .metrics {
            margin: 15px 0;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .metric-value {
            font-weight: bold;
        }
        .better { color: #4CAF50; }
        .worse { color: #F44336; }
        .text-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .summary {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }
        .winner {
            font-size: 28px;
            font-weight: bold;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .winner.success {
            background: #d4edda;
            color: #155724;
        }
        .winner.failure {
            background: #f8d7da;
            color: #721c24;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
            font-size: 16px;
        }
        .info { background: #d1ecf1; color: #0c5460; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧾 Receipt OCR Performance Test</h1>
            <p>Testing PaddleOCR Receipt & PDF optimizations against Tesseract baseline</p>
            <p>Receipt: wynnsw_20221210_011.pdf (converted to PNG)</p>
        </div>
        
        <div class="controls">
            <button id="runTest">🔬 Run OCR Comparison Test</button>
            <div class="image-preview">
                <img id="receiptImage" src="receipt-test.png" alt="Receipt">
            </div>
        </div>
        
        <div id="status" class="status info">Initializing OCR engines...</div>
        
        <div id="results" style="display: none;">
            <div class="results-container" id="resultsContainer"></div>
            <div class="summary" id="summary"></div>
        </div>
    </div>

    <script type="module">
        import { ppOCRImprovedEngine } from './src/ppocr-improved-engine.js';
        import { tesseractOCREngine } from './src/tesseract-ocr-engine.js';
        import { RECEIPT_OCR_CONFIG, updatePaddleOCRForDocuments } from './src/document-ocr-config.js';
        import { PDF_OCR_CONFIG, updatePaddleOCRForPDF } from './src/pdf-ocr-config.js';
        
        let isInitialized = false;
        
        // Initialize OCR engines
        async function initializeOCR() {
            setStatus('Initializing OCR engines...', 'info');
            try {
                await Promise.all([
                    ppOCRImprovedEngine.initialize((progress) => {
                        console.log('PaddleOCR:', progress.message);
                    }),
                    tesseractOCREngine.initialize((progress) => {
                        console.log('Tesseract:', progress.message);
                    })
                ]);
                isInitialized = true;
                setStatus('✅ OCR engines ready! Click "Run OCR Comparison Test" to start.', 'success');
                document.getElementById('runTest').disabled = false;
            } catch (error) {
                setStatus('Failed to initialize OCR: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Process image with OCR
        async function processWithOCR(imageUrl, engineName, engine, configFunction = null) {
            // Apply configuration if provided
            if (configFunction) {
                configFunction();
            }
            
            // Fetch image
            const response = await fetch(imageUrl);
            const blob = await response.blob();
            
            const startTime = Date.now();
            let results = [];
            
            try {
                results = await engine.process(blob);
            } catch (error) {
                console.error(`${engineName} error:`, error);
                results = [];
            }
            
            const processingTime = Date.now() - startTime;
            
            // Extract text and calculate metrics
            const allText = results.map(r => r.text).join(' ');
            const lines = results.map(r => r.text);
            
            // Look for receipt-specific elements
            const pricePattern = /\$?\d+\.\d{2}/g;
            const prices = allText.match(pricePattern) || [];
            const itemLines = lines.filter(line => line.length > 3);
            const totalLines = lines.filter(line => 
                line.toLowerCase().includes('total') || 
                line.toLowerCase().includes('amount') ||
                line.toLowerCase().includes('balance')
            );
            const avgConfidence = results.reduce((sum, r) => sum + (r.confidence || 0), 0) / (results.length || 1);
            
            return {
                engineName,
                processingTime,
                totalChars: allText.length,
                lineCount: lines.length,
                wordCount: allText.split(/\s+/).filter(w => w.length > 0).length,
                priceCount: prices.length,
                itemCount: itemLines.length,
                foundTotal: totalLines.length > 0,
                avgConfidence,
                fullText: allText,
                prices: prices.slice(0, 20), // First 20 prices
                totalLines,
                lines,
                regionCount: results.length
            };
        }
        
        // Run comparison test
        async function runComparisonTest() {
            if (!isInitialized) {
                setStatus('OCR engines not ready yet!', 'error');
                return;
            }
            
            setStatus('🔄 Running OCR comparison test...', 'info');
            document.getElementById('results').style.display = 'block';
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('runTest').disabled = true;
            
            try {
                // Test with Tesseract
                setStatus('Processing with Tesseract...', 'info');
                const tesseractResult = await processWithOCR('receipt-test.png', 'Tesseract (Baseline)', tesseractOCREngine);
                displayResult(tesseractResult, 'tesseract');
                
                // Test with PaddleOCR Receipt config
                setStatus('Processing with PaddleOCR Receipt Optimized...', 'info');
                const paddleReceiptResult = await processWithOCR(
                    'receipt-test.png', 
                    'PaddleOCR Receipt Optimized', 
                    ppOCRImprovedEngine,
                    () => updatePaddleOCRForDocuments(ppOCRImprovedEngine, 'receipt')
                );
                displayResult(paddleReceiptResult, 'paddle-receipt');
                
                // Test with PaddleOCR PDF config
                setStatus('Processing with PaddleOCR PDF Optimized...', 'info');
                const paddlePDFResult = await processWithOCR(
                    'receipt-test.png', 
                    'PaddleOCR PDF Optimized', 
                    ppOCRImprovedEngine,
                    () => updatePaddleOCRForPDF(ppOCRImprovedEngine)
                );
                displayResult(paddlePDFResult, 'paddle-pdf');
                
                // Show comparison summary
                showSummary(tesseractResult, paddleReceiptResult, paddlePDFResult);
                
            } catch (error) {
                setStatus('Test failed: ' + error.message, 'error');
                console.error(error);
            } finally {
                document.getElementById('runTest').disabled = false;
            }
        }
        
        // Display individual result
        function displayResult(result, className) {
            const card = document.createElement('div');
            card.className = `result-card ${className}`;
            
            const pricesList = result.prices.length > 10 
                ? result.prices.slice(0, 10).join(', ') + '... (and ' + (result.prices.length - 10) + ' more)'
                : result.prices.join(', ') || 'None';
            
            const html = `
                <h3>${result.engineName}</h3>
                <div class="metrics">
                    <div class="metric">
                        <span>Processing Time:</span>
                        <span class="metric-value">${result.processingTime}ms</span>
                    </div>
                    <div class="metric">
                        <span>Total Characters:</span>
                        <span class="metric-value">${result.totalChars}</span>
                    </div>
                    <div class="metric">
                        <span>Text Regions:</span>
                        <span class="metric-value">${result.regionCount}</span>
                    </div>
                    <div class="metric">
                        <span>Lines Detected:</span>
                        <span class="metric-value">${result.lineCount}</span>
                    </div>
                    <div class="metric">
                        <span>Words Detected:</span>
                        <span class="metric-value">${result.wordCount}</span>
                    </div>
                    <div class="metric">
                        <span>Prices Found:</span>
                        <span class="metric-value">${result.priceCount}</span>
                    </div>
                    <div class="metric">
                        <span>Total Lines:</span>
                        <span class="metric-value">${result.totalLines.length}</span>
                    </div>
                    <div class="metric">
                        <span>Confidence:</span>
                        <span class="metric-value">${(result.avgConfidence * 100).toFixed(1)}%</span>
                    </div>
                </div>
                <div class="text-preview">
                    <strong>💰 Detected Prices:</strong><br>
                    ${pricesList}
                    <br><br>
                    <strong>📄 First 10 Lines:</strong><br>
                    ${result.lines.slice(0, 10).map((line, i) => `${i+1}. ${line}`).join('\n')}
                </div>
            `;
            
            card.innerHTML = html;
            document.getElementById('resultsContainer').appendChild(card);
        }
        
        // Show summary and determine winner
        function showSummary(tesseract, paddleReceipt, paddlePDF) {
            const summary = document.getElementById('summary');
            
            // Calculate improvements
            const receiptCharImprovement = ((paddleReceipt.totalChars - tesseract.totalChars) / Math.max(tesseract.totalChars, 1) * 100).toFixed(1);
            const receiptPriceImprovement = ((paddleReceipt.priceCount - tesseract.priceCount) / Math.max(tesseract.priceCount, 1) * 100).toFixed(1);
            const receiptLineImprovement = ((paddleReceipt.lineCount - tesseract.lineCount) / Math.max(tesseract.lineCount, 1) * 100).toFixed(1);
            
            const pdfCharImprovement = ((paddlePDF.totalChars - tesseract.totalChars) / Math.max(tesseract.totalChars, 1) * 100).toFixed(1);
            const pdfPriceImprovement = ((paddlePDF.priceCount - tesseract.priceCount) / Math.max(tesseract.priceCount, 1) * 100).toFixed(1);
            const pdfLineImprovement = ((paddlePDF.lineCount - tesseract.lineCount) / Math.max(tesseract.lineCount, 1) * 100).toFixed(1);
            
            // Determine winner based on key metrics
            const paddleBestChars = Math.max(paddleReceipt.totalChars, paddlePDF.totalChars);
            const paddleBestPrices = Math.max(paddleReceipt.priceCount, paddlePDF.priceCount);
            const paddleBestLines = Math.max(paddleReceipt.lineCount, paddlePDF.lineCount);
            
            // Score calculation (weighted)
            let tesseractScore = 0;
            let paddleReceiptScore = 0;
            let paddlePDFScore = 0;
            
            // Character detection (weight: 2)
            if (tesseract.totalChars > 0) {
                if (paddleReceipt.totalChars > tesseract.totalChars) paddleReceiptScore += 2;
                else tesseractScore += 2;
                
                if (paddlePDF.totalChars > tesseract.totalChars) paddlePDFScore += 2;
                else if (paddlePDF.totalChars < tesseract.totalChars) tesseractScore += 2;
            }
            
            // Price detection (weight: 3 - most important for receipts)
            if (paddleReceipt.priceCount > tesseract.priceCount) paddleReceiptScore += 3;
            else if (paddleReceipt.priceCount < tesseract.priceCount) tesseractScore += 3;
            
            if (paddlePDF.priceCount > tesseract.priceCount) paddlePDFScore += 3;
            else if (paddlePDF.priceCount < tesseract.priceCount) tesseractScore += 3;
            
            // Line detection (weight: 1)
            if (paddleReceipt.lineCount > tesseract.lineCount) paddleReceiptScore += 1;
            else if (paddleReceipt.lineCount < tesseract.lineCount) tesseractScore += 1;
            
            if (paddlePDF.lineCount > tesseract.lineCount) paddlePDFScore += 1;
            else if (paddlePDF.lineCount < tesseract.lineCount) tesseractScore += 1;
            
            const isWinner = paddleReceiptScore > tesseractScore || paddlePDFScore > tesseractScore;
            const bestPaddleConfig = paddleReceiptScore >= paddlePDFScore ? 'Receipt Optimized' : 'PDF Optimized';
            
            let html = '<h2>📊 Performance Comparison Summary</h2>';
            
            html += '<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">';
            html += '<tr style="background: #f8f9fa;"><th style="padding: 10px; border: 1px solid #dee2e6;">Metric</th><th style="padding: 10px; border: 1px solid #dee2e6;">Tesseract</th><th style="padding: 10px; border: 1px solid #dee2e6;">PaddleOCR Receipt</th><th style="padding: 10px; border: 1px solid #dee2e6;">PaddleOCR PDF</th></tr>';
            
            // Characters row
            html += '<tr>';
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>Characters</strong></td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${tesseract.totalChars}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddleReceipt.totalChars > tesseract.totalChars ? 'better' : 'worse'}">${paddleReceipt.totalChars} (${receiptCharImprovement > 0 ? '+' : ''}${receiptCharImprovement}%)</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddlePDF.totalChars > tesseract.totalChars ? 'better' : 'worse'}">${paddlePDF.totalChars} (${pdfCharImprovement > 0 ? '+' : ''}${pdfCharImprovement}%)</td>`;
            html += '</tr>';
            
            // Prices row
            html += '<tr style="background: #f8f9fa;">';
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>Prices Detected</strong></td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${tesseract.priceCount}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddleReceipt.priceCount > tesseract.priceCount ? 'better' : 'worse'}">${paddleReceipt.priceCount} (${receiptPriceImprovement > 0 ? '+' : ''}${receiptPriceImprovement}%)</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddlePDF.priceCount > tesseract.priceCount ? 'better' : 'worse'}">${paddlePDF.priceCount} (${pdfPriceImprovement > 0 ? '+' : ''}${pdfPriceImprovement}%)</td>`;
            html += '</tr>';
            
            // Lines row
            html += '<tr>';
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>Lines</strong></td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${tesseract.lineCount}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddleReceipt.lineCount > tesseract.lineCount ? 'better' : 'worse'}">${paddleReceipt.lineCount} (${receiptLineImprovement > 0 ? '+' : ''}${receiptLineImprovement}%)</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddlePDF.lineCount > tesseract.lineCount ? 'better' : 'worse'}">${paddlePDF.lineCount} (${pdfLineImprovement > 0 ? '+' : ''}${pdfLineImprovement}%)</td>`;
            html += '</tr>';
            
            // Time row
            html += '<tr style="background: #f8f9fa;">';
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>Processing Time</strong></td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${tesseract.processingTime}ms</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddleReceipt.processingTime < tesseract.processingTime ? 'better' : 'worse'}">${paddleReceipt.processingTime}ms</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;" class="${paddlePDF.processingTime < tesseract.processingTime ? 'better' : 'worse'}">${paddlePDF.processingTime}ms</td>`;
            html += '</tr>';
            
            html += '</table>';
            
            if (isWinner) {
                html += '<div class="winner success">✅ PaddleOCR OUTPERFORMS Tesseract!</div>';
                html += `<p style="font-size: 18px;"><strong>Best Configuration:</strong> PaddleOCR ${bestPaddleConfig}</p>`;
                html += `<p>Key improvements: ${Math.max(receiptCharImprovement, pdfCharImprovement)}% more characters detected, ${Math.max(receiptPriceImprovement, pdfPriceImprovement)}% more prices found</p>`;
                setStatus('✅ Success! PaddleOCR outperforms Tesseract for receipt processing.', 'success');
            } else {
                html += '<div class="winner failure">❌ Tesseract performs better</div>';
                html += '<p>PaddleOCR configurations need further optimization to beat Tesseract baseline.</p>';
                setStatus('❌ PaddleOCR needs further optimization to beat Tesseract.', 'error');
            }
            
            summary.innerHTML = html;
        }
        
        // Set status
        function setStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // Event listeners
        document.getElementById('runTest').addEventListener('click', runComparisonTest);
        
        // Initialize on load
        window.addEventListener('load', initializeOCR);
    </script>
</body>
</html>