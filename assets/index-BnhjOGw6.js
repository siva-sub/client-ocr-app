import{b as ge,F as ue,H as pe}from"./onnxruntime-CqRzMC93.js";import{p as J,c as ke,g as Ye}from"./pdfjs-BhC3vFUT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=t(o);fetch(o.href,r)}})();J.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";ge.wasm.wasmPaths="/client-ocr-app/assets/";ge.wasm.numThreads=1;const we="/client-ocr-app/models/",A={det_limit_side_len:1280,det_db_thresh:.05,det_db_box_thresh:.1,det_db_unclip_ratio:2.5,det_db_min_size:2,det_db_max_candidates:2e3,rec_image_height:48,rec_image_width:320,rec_batch_num:6,drop_score:.05,det_mean:[.485,.456,.406],det_std:[.229,.224,.225],rec_mean:.5,rec_std:.5,min_area_thresh:2,vertical_gap_threshold:.5,grid_size:16};class He{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"PP-OCRv5_mobile_rec_infer.onnx",dictionary:"ppocr_keys_v1.txt"}}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release(),this.detectionSession=await ue.create(we+this.modelConfig.detection,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Detection model loaded:",this.detectionSession.inputNames,this.detectionSession.outputNames);const n=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${n}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release(),this.recognitionSession=await ue.create(we+this.modelConfig.recognition,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Recognition model loaded:",this.recognitionSession.inputNames,this.recognitionSession.outputNames),this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR ready!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(we+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.blobToImage(e),n=await this.detectText(t),o=await this.recognizeText(t,n);return this.mergeTextLines(o)}async detectText(e){if(!this.detectionSession)throw new Error("Detection model not loaded");const{resizedImage:t,ratio:n}=await this.resizeForDetection(e),o=await this.preprocessForDetection(t),r={[this.detectionSession.inputNames[0]]:o},a=await this.detectionSession.run(r),d=await this.postprocessDetection(a[this.detectionSession.outputNames[0]],t.width,t.height,n);return this.sortBoxes(d)}async resizeForDetection(e){const t=A.det_limit_side_len;let n=e.width,o=e.height,r=1;Math.max(o,n)>t&&(r=o>n?t/o:t/n),n=Math.round(n*r),o=Math.round(o*r);const a=A.grid_size,d=Math.round(n/a)*a,s=Math.round(o/a)*a;await this.preprocessImage(e,d,s);const l=new Image;return new Promise(m=>{this.canvas.toBlob(c=>{const u=URL.createObjectURL(c);l.onload=()=>{URL.revokeObjectURL(u),m({resizedImage:l,ratio:r})},l.src=u})})}async preprocessImage(e,t,n){this.canvas.width=t,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,t,n),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high";const o=Math.min(t/e.width,n/e.height),r=e.width*o,a=e.height*o,d=(t-r)/2,s=(n-a)/2;this.ctx.drawImage(e,d,s,r,a);const l=this.ctx.getImageData(0,0,t,n),m=l.data,c=new Array(256).fill(0),u=[];for(let b=0;b<m.length;b+=4){const M=Math.round(.299*m[b]+.587*m[b+1]+.114*m[b+2]);u.push(M),c[M]++}let f=0,x=0,w=0,R=0,_=0;for(let b=0;b<256;b++)f+=b*c[b];let L=0,S=128;for(let b=0;b<256;b++){x=0,w=0,R=0,_=0;for(let B=0;B<256;B++)B<=b?(x+=B*c[B],w+=c[B]):(R+=B*c[B],_+=c[B]);if(w===0||_===0)continue;const M=x/w,O=R/_,T=w*_*Math.pow(M-O,2);T>L&&(L=T,S=b)}for(let b=0;b<m.length;b+=4){const M=Math.floor(b/4);let O=u[M];O<S?O=Math.pow(O/S,2.2)*S:O=S+Math.pow((O-S)/(255-S),.45)*(255-S);let T=O;if(T>S+20)T=255;else if(T<S-20)T=0;else{const B=(T-S)/20;T=S+127*(1/(1+Math.exp(-B)))}T=Math.max(0,Math.min(255,T)),m[b]=T,m[b+1]=T,m[b+2]=T}return this.ctx.putImageData(l,0,0),this.ctx.filter="blur(0.5px)",this.ctx.drawImage(this.canvas,0,0),this.ctx.filter="none",this.canvas}async preprocessForDetection(e){this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data,o=e.width*e.height,r=new Float32Array(3*o);for(let a=0;a<o;a++){const d=a*4;r[a]=(n[d]/255-A.det_mean[0])/A.det_std[0],r[o+a]=(n[d+1]/255-A.det_mean[1])/A.det_std[1],r[2*o+a]=(n[d+2]/255-A.det_mean[2])/A.det_std[2]}return new pe("float32",r,[1,3,e.height,e.width])}async postprocessDetection(e,t,n,o){const[r,a,d,s]=e.dims,l=e.data,m=new Float32Array(d*s);for(let w=0;w<d*s;w++)m[w]=1/(1+Math.exp(-l[w]));const c=new Uint8Array(d*s);for(let w=0;w<d*s;w++)c[w]=m[w]>A.det_db_thresh?255:0;const u=[],f=new Set;let x=0;for(let w=0;w<d&&x<A.det_db_max_candidates;w++)for(let R=0;R<s&&x<A.det_db_max_candidates;R++){const _=w*s+R;if(c[_]===255&&!f.has(_)){const L=this.findConnectedComponent(c,s,d,R,w,f,m);L&&L.score>=A.det_db_box_thresh&&(L.points=L.points.map(b=>[Math.round(b[0]/o),Math.round(b[1]/o)]),this.calculatePolygonArea(L.points)>A.min_area_thresh&&(u.push(L),x++))}}return u}findConnectedComponent(e,t,n,o,r,a,d){const s=[[o,r]],l=[];let m=0,c=0;const u=5e4,f=r*t+o;if(a.has(f)||e[f]!==255)return null;for(;s.length>0&&l.length<u;){const[O,T]=s.pop(),B=T*t+O;if(!a.has(B)&&(a.add(B),e[B]===255)){l.push([O,T]),m+=d[B],c++;for(let D=-1;D<=1;D++)for(let H=-1;H<=1;H++){if(H===0&&D===0)continue;const N=O+H,X=T+D;if(N>=0&&N<t&&X>=0&&X<n){const V=X*t+N;!a.has(V)&&e[V]===255&&s.push([N,X])}}}}if(l.length<A.det_db_min_size)return null;const x=l.map(O=>O[0]),w=l.map(O=>O[1]);let R=Math.min(...x),_=Math.max(...x),L=Math.min(...w),S=Math.max(...w);const b=A.det_db_unclip_ratio,M=Math.max(_-R,S-L)*(b-1)/2;return R=Math.max(0,R-M),_=Math.min(t-1,_+M),L=Math.max(0,L-M),S=Math.min(n-1,S+M),{points:[[R,L],[_,L],[_,S],[R,S]],score:m/c}}calculatePolygonArea(e){let t=0;const n=e.length;for(let o=0;o<n;o++){const r=(o+1)%n;t+=e[o][0]*e[r][1],t-=e[r][0]*e[o][1]}return Math.abs(t)/2}sortBoxes(e){if(e.length===0)return e;e.sort((t,n)=>{const o=t.points[0][1],r=n.points[0][1];return o-r});for(let t=e.length-1;t>0;t--)for(let n=t-1;n>=0&&(Math.abs(e[n+1].points[0][1]-e[n].points[0][1])<10&&e[n+1].points[0][0]<e[n].points[0][0]);n--){const o=e[n];e[n]=e[n+1],e[n+1]=o}return e}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[],o=A.rec_batch_num;for(let r=0;r<t.length;r+=o){const a=t.slice(r,Math.min(r+o,t.length)),d=await this.processBatch(e,a);n.push(...d)}return n}async processBatch(e,t){const n=[],o=[],r=[];for(const d of t){const s=await this.getRotateCropImage(e,d),l=s.width/s.height;o.push(s),r.push(l)}const a=Array.from({length:t.length},(d,s)=>s).sort((d,s)=>r[d]-r[s]);for(const d of a){const s=o[d],l=t[d],m=await this.preprocessForRecognition(s),c={[this.recognitionSession.inputNames[0]]:m},u=await this.recognitionSession.run(c),f=await this.decodeRecognition(u[this.recognitionSession.outputNames[0]]);f.score>=A.drop_score&&n.push({text:f.text,confidence:f.score,box:l.points})}return n}async getRotateCropImage(e,t){const n=t.points;Math.sqrt(Math.pow(n[0][0]-n[1][0],2)+Math.pow(n[0][1]-n[1][1],2)),Math.sqrt(Math.pow(n[2][0]-n[3][0],2)+Math.pow(n[2][1]-n[3][1],2)),Math.sqrt(Math.pow(n[0][0]-n[3][0],2)+Math.pow(n[0][1]-n[3][1],2)),Math.sqrt(Math.pow(n[1][0]-n[2][0],2)+Math.pow(n[1][1]-n[2][1],2));const o=Math.min(...n.map(c=>c[0])),r=Math.max(...n.map(c=>c[0])),a=Math.min(...n.map(c=>c[1])),d=Math.max(...n.map(c=>c[1])),s=r-o,l=d-a;if(this.canvas.width=s,this.canvas.height=l,this.ctx.drawImage(e,o,a,s,l,0,0,s,l),l*1/s>=1.5){const c=document.createElement("canvas"),u=c.getContext("2d",{willReadFrequently:!0});c.width=l,c.height=s,u.translate(l/2,s/2),u.rotate(Math.PI/2),u.drawImage(this.canvas,-s/2,-l/2),this.canvas.width=l,this.canvas.height=s,this.ctx.drawImage(c,0,0)}const m=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const f=URL.createObjectURL(u);m.onload=()=>{URL.revokeObjectURL(f),c(m)},m.src=f})})}async preprocessForRecognition(e){const n=A.rec_image_height,o=A.rec_image_width,r=e.height,d=e.width/r;let s;Math.ceil(n*d)>o?s=o:s=Math.ceil(n*d),this.canvas.width=s,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,s,n),this.ctx.drawImage(e,0,0,s,n);const m=this.ctx.getImageData(0,0,s,n).data,c=new Float32Array(3*n*o);for(let u=0;u<3;u++)for(let f=0;f<n;f++)for(let x=0;x<s;x++){const w=(f*s+x)*4+u,R=u*n*o+f*o+x;c[R]=(m[w]/255-A.rec_mean)/A.rec_std}return new pe("float32",c,[1,3,n,o])}async decodeRecognition(e){const[t,n,o]=e.dims,r=e.data,a=[],d=[];for(let c=0;c<n;c++){let u=0,f=r[c*o];for(let x=1;x<o;x++){const w=r[c*o+x];w>f&&(f=w,u=x)}a.push(u),d.push(f)}const s=[],l=[];let m=-1;for(let c=0;c<a.length;c++){const u=a[c];u!==0&&u!==m&&u<this.charDict.length&&(s.push(this.charDict[u]),l.push(d[c])),m=u}return{text:s.join(""),score:l.length>0?l.reduce((c,u)=>c+u)/l.length:0}}mergeTextLines(e){if(e.length===0)return e;let t=this.filterResults(e);if(t.length===0)return t;t=this.postProcessEnglishText(t);const n=t.map(s=>{const l=s.box.map(m=>m[1]);return Math.max(...l)-Math.min(...l)}),o=n.reduce((s,l)=>s+l)/n.length,r=[];let a=[t[0]];for(let s=1;s<t.length;s++){const l=t[s],m=t[s-1],c=Math.min(...m.box.map(w=>w[1])),u=Math.min(...l.box.map(w=>w[1])),f=Math.abs(u-c),x=o*A.vertical_gap_threshold;f<=x?a.push(l):(r.push(a),a=[l])}a.length>0&&r.push(a);const d=[];for(const s of r){s.sort((x,w)=>{const R=Math.min(...x.box.map(L=>L[0])),_=Math.min(...w.box.map(L=>L[0]));return R-_});const l=s.map(x=>x.text).join(" "),m=s.reduce((x,w)=>x+w.confidence,0)/s.length,c=s.flatMap(x=>x.box),u=c.map(x=>x[0]),f=c.map(x=>x[1]);d.push({text:l,confidence:m,box:[[Math.min(...u),Math.min(...f)],[Math.max(...u),Math.min(...f)],[Math.max(...u),Math.max(...f)],[Math.min(...u),Math.max(...f)]]})}return d}filterResults(e){const t=A.drop_score;return e.filter(n=>n.confidence<t?!1:n.text&&n.text.trim().length>0)}async processPDF(e){const t=await e.arrayBuffer(),n=await J.getDocument({data:t}).promise,o=n.numPages,r=[];for(let a=1;a<=o;a++){const d=await n.getPage(a),s=d.getViewport({scale:2}),l=document.createElement("canvas"),m=l.getContext("2d");l.width=s.width,l.height=s.height,await d.render({canvasContext:m,viewport:s}).promise;const c=await new Promise(f=>l.toBlob(f)),u=await this.process(c);r.push({page:a,results:u})}return r}async blobToImage(e){return new Promise((t,n)=>{const o=new Image,r=URL.createObjectURL(e);o.onload=()=>{URL.revokeObjectURL(r),t(o)},o.onerror=()=>{URL.revokeObjectURL(r),n(new Error("Failed to load image"))},o.src=r})}postProcessEnglishText(e){return e.map(t=>{let n=t.text;n=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([a-zA-Z])(\d)/g,"$1 $2").replace(/(\d)([a-zA-Z])/g,"$1 $2").replace(/\s+/g," ").replace(/([.,!?;:])([a-zA-Z])/g,"$1 $2").trim();const o={tne:"the",tnat:"that",wnen:"when",wnere:"where",witn:"with","l'":"I'"," l ":" I ","^l ":"I "};for(const[r,a]of Object.entries(o)){const d=new RegExp(r,"gi");n=n.replace(d,a)}return{...t,text:n}})}}const de=new He;J.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";ge.wasm.wasmPaths="/client-ocr-app/assets/";ge.wasm.numThreads=1;const ve="/client-ocr-app/models/",j={det_limit_side_len:1280,det_db_thresh:.05,det_db_box_thresh:.15,det_db_unclip_ratio:2.5,drop_score:.05,mean:[.485,.456,.406],std:[.229,.224,.225]};class Ge{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"en_PP-OCRv4_mobile_rec_infer.onnx",dictionary:"en_dict.txt"}}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){this.initialized=!1;try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release(),this.detectionSession=await ue.create(ve+this.modelConfig.detection,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Detection model loaded:",this.detectionSession.inputNames,this.detectionSession.outputNames);const n=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${n}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release(),this.recognitionSession=await ue.create(ve+this.modelConfig.recognition,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Recognition model loaded:",this.recognitionSession.inputNames,this.recognitionSession.outputNames),this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR models loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(ve+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.blobToImage(e),n=await this.detectText(t);return await this.recognizeText(t,n)}async detectText(e){if(!this.detectionSession)throw new Error("Detection model not loaded");const{resizedImage:t,ratio:n}=await this.resizeForDetection(e),o=await this.preprocessForDetection(t),r={[this.detectionSession.inputNames[0]]:o},d=(await this.detectionSession.run(r))[this.detectionSession.outputNames[0]];return await this.postprocessDetection(d,t.width,t.height,n)}async resizeForDetection(e){const t=j.det_limit_side_len;let n=e.width,o=e.height,r=1;Math.max(o,n)>t&&(r=t/Math.max(o,n));const a=Math.ceil(n*r),d=Math.ceil(o*r),s=Math.ceil(a/32)*32,l=Math.ceil(d/32)*32;this.canvas.width=s,this.canvas.height=l,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,s,l),this.ctx.drawImage(e,0,0,a,d);const m=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const f=URL.createObjectURL(u);m.onload=()=>{URL.revokeObjectURL(f),c({resizedImage:m,ratio:r})},m.src=f})})}async preprocessForDetection(e){this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data,o=e.width*e.height,r=new Float32Array(3*o);for(let a=0;a<o;a++){const d=a*4;r[a]=(n[d]/255-j.mean[0])/j.std[0],r[o+a]=(n[d+1]/255-j.mean[1])/j.std[1],r[2*o+a]=(n[d+2]/255-j.mean[2])/j.std[2]}return new pe("float32",r,[1,3,e.height,e.width])}async postprocessDetection(e,t,n,o){const[r,a,d,s]=e.dims,l=e.data,m=new Float32Array(d*s);for(let w=0;w<d*s;w++)m[w]=1/(1+Math.exp(-l[w]));const c=new Uint8Array(d*s),u=j.det_db_thresh;for(let w=0;w<d*s;w++)c[w]=m[w]>u?1:0;const f=[],x=new Set;for(let w=0;w<d;w++)for(let R=0;R<s;R++){const _=w*s+R;if(c[_]===1&&!x.has(_)&&m[_]>j.det_db_box_thresh){const L=this.expandBox(c,m,R,w,s,d,x);if(L){const S={points:L.points.map(b=>[Math.round(b[0]*t/s/o),Math.round(b[1]*n/d/o)]),score:L.score};f.push(S)}}}return this.sortBoxes(f)}expandBox(e,t,n,o,r,a,d){let s=n,l=n,m=o,c=o,u=0,f=0;const x=[[n,o]];for(d.add(o*r+n);x.length>0;){const[_,L]=x.shift();u+=t[L*r+_],f++;for(let S=-1;S<=1;S++)for(let b=-1;b<=1;b++){const M=_+b,O=L+S,T=O*r+M;M>=0&&M<r&&O>=0&&O<a&&e[T]===1&&!d.has(T)&&(d.add(T),x.push([M,O]),s=Math.min(s,M),l=Math.max(l,M),m=Math.min(m,O),c=Math.max(c,O))}}if(l-s<3||c-m<3)return null;const w=j.det_db_unclip_ratio,R=Math.max(l-s,c-m)*(w-1)/2;return s=Math.max(0,s-R),l=Math.min(r-1,l+R),m=Math.max(0,m-R),c=Math.min(a-1,c+R),{points:[[s,m],[l,m],[l,c],[s,c]],score:u/f}}sortBoxes(e){return e.sort((t,n)=>{const o=Math.min(...t.points.map(a=>a[1])),r=Math.min(...n.points.map(a=>a[1]));if(Math.abs(o-r)<10){const a=Math.min(...t.points.map(s=>s[0])),d=Math.min(...n.points.map(s=>s[0]));return a-d}return o-r})}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[];for(const o of t){const r=await this.cropToBox(e,o),a=await this.preprocessForRecognition(r),d={[this.recognitionSession.inputNames[0]]:a},s=await this.recognitionSession.run(d),l=await this.decodeRecognition(s[this.recognitionSession.outputNames[0]]);l.score>=j.drop_score&&n.push({text:l.text,confidence:l.score,box:o.points})}return n}async cropToBox(e,t){const n=t.points,o=Math.min(...n.map(c=>c[0])),r=Math.max(...n.map(c=>c[0])),a=Math.min(...n.map(c=>c[1])),d=Math.max(...n.map(c=>c[1])),s=r-o,l=d-a;this.canvas.width=s,this.canvas.height=l,this.ctx.drawImage(e,o,a,s,l,0,0,s,l);const m=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const f=URL.createObjectURL(u);m.onload=()=>{URL.revokeObjectURL(f),c(m)},m.src=f})})}async preprocessForRecognition(e){const n=e.width/e.height;let o=Math.round(48*n);o=Math.max(o,48),this.canvas.width=o,this.canvas.height=48,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,o,48),this.ctx.drawImage(e,0,0,o,48);const a=this.ctx.getImageData(0,0,o,48).data,d=o*48,s=new Float32Array(3*d);for(let l=0;l<d;l++){const m=l*4;s[l]=(a[m]/255-.5)/.5,s[d+l]=(a[m+1]/255-.5)/.5,s[2*d+l]=(a[m+2]/255-.5)/.5}return new pe("float32",s,[1,3,48,o])}async decodeRecognition(e){const[t,n,o]=e.dims,r=e.data,a=[],d=[];for(let c=0;c<n;c++){let u=0,f=r[c*o];for(let x=1;x<o;x++){const w=r[c*o+x];w>f&&(f=w,u=x)}a.push(u),d.push(f)}const s=[],l=[];let m=-1;for(let c=0;c<a.length;c++){const u=a[c];u!==0&&u!==m&&u<this.charDict.length&&(s.push(this.charDict[u]),l.push(d[c])),m=u}return{text:s.join(""),score:l.length>0?l.reduce((c,u)=>c+u)/l.length:0}}async processPDF(e){const t=await e.arrayBuffer(),n=await J.getDocument({data:t}).promise,o=n.numPages,r=[];for(let a=1;a<=o;a++){const d=await n.getPage(a),s=d.getViewport({scale:2}),l=document.createElement("canvas"),m=l.getContext("2d");l.width=s.width,l.height=s.height,await d.render({canvasContext:m,viewport:s}).promise;const c=await new Promise(w=>l.toBlob(w,"image/png")),u=await this.blobToImage(c),f=await this.detectText(u),x=await this.recognizeText(u,f);r.push({page:a,results:x})}return r}async blobToImage(e){return new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=URL.createObjectURL(e)})}}const oe=new Ge;var We={exports:{}};(function(i){var e=function(t){var n=Object.prototype,o=n.hasOwnProperty,r=Object.defineProperty||function(g,h,v){g[h]=v.value},a,d=typeof Symbol=="function"?Symbol:{},s=d.iterator||"@@iterator",l=d.asyncIterator||"@@asyncIterator",m=d.toStringTag||"@@toStringTag";function c(g,h,v){return Object.defineProperty(g,h,{value:v,enumerable:!0,configurable:!0,writable:!0}),g[h]}try{c({},"")}catch{c=function(h,v,E){return h[v]=E}}function u(g,h,v,E){var p=h&&h.prototype instanceof S?h:S,y=Object.create(p.prototype),I=new ae(E||[]);return r(y,"_invoke",{value:X(g,v,I)}),y}t.wrap=u;function f(g,h,v){try{return{type:"normal",arg:g.call(h,v)}}catch(E){return{type:"throw",arg:E}}}var x="suspendedStart",w="suspendedYield",R="executing",_="completed",L={};function S(){}function b(){}function M(){}var O={};c(O,s,function(){return this});var T=Object.getPrototypeOf,B=T&&T(T(ce([])));B&&B!==n&&o.call(B,s)&&(O=B);var D=M.prototype=S.prototype=Object.create(O);b.prototype=M,r(D,"constructor",{value:M,configurable:!0}),r(M,"constructor",{value:b,configurable:!0}),b.displayName=c(M,m,"GeneratorFunction");function H(g){["next","throw","return"].forEach(function(h){c(g,h,function(v){return this._invoke(h,v)})})}t.isGeneratorFunction=function(g){var h=typeof g=="function"&&g.constructor;return h?h===b||(h.displayName||h.name)==="GeneratorFunction":!1},t.mark=function(g){return Object.setPrototypeOf?Object.setPrototypeOf(g,M):(g.__proto__=M,c(g,m,"GeneratorFunction")),g.prototype=Object.create(D),g},t.awrap=function(g){return{__await:g}};function N(g,h){function v(y,I,P,$){var C=f(g[y],g,I);if(C.type==="throw")$(C.arg);else{var K=C.arg,G=K.value;return G&&typeof G=="object"&&o.call(G,"__await")?h.resolve(G.__await).then(function(W){v("next",W,P,$)},function(W){v("throw",W,P,$)}):h.resolve(G).then(function(W){K.value=W,P(K)},function(W){return v("throw",W,P,$)})}}var E;function p(y,I){function P(){return new h(function($,C){v(y,I,$,C)})}return E=E?E.then(P,P):P()}r(this,"_invoke",{value:p})}H(N.prototype),c(N.prototype,l,function(){return this}),t.AsyncIterator=N,t.async=function(g,h,v,E,p){p===void 0&&(p=Promise);var y=new N(u(g,h,v,E),p);return t.isGeneratorFunction(h)?y:y.next().then(function(I){return I.done?I.value:y.next()})};function X(g,h,v){var E=x;return function(y,I){if(E===R)throw new Error("Generator is already running");if(E===_){if(y==="throw")throw I;return le()}for(v.method=y,v.arg=I;;){var P=v.delegate;if(P){var $=V(P,v);if($){if($===L)continue;return $}}if(v.method==="next")v.sent=v._sent=v.arg;else if(v.method==="throw"){if(E===x)throw E=_,v.arg;v.dispatchException(v.arg)}else v.method==="return"&&v.abrupt("return",v.arg);E=R;var C=f(g,h,v);if(C.type==="normal"){if(E=v.done?_:w,C.arg===L)continue;return{value:C.arg,done:v.done}}else C.type==="throw"&&(E=_,v.method="throw",v.arg=C.arg)}}}function V(g,h){var v=h.method,E=g.iterator[v];if(E===a)return h.delegate=null,v==="throw"&&g.iterator.return&&(h.method="return",h.arg=a,V(g,h),h.method==="throw")||v!=="return"&&(h.method="throw",h.arg=new TypeError("The iterator does not provide a '"+v+"' method")),L;var p=f(E,g.iterator,h.arg);if(p.type==="throw")return h.method="throw",h.arg=p.arg,h.delegate=null,L;var y=p.arg;if(!y)return h.method="throw",h.arg=new TypeError("iterator result is not an object"),h.delegate=null,L;if(y.done)h[g.resultName]=y.value,h.next=g.nextLoc,h.method!=="return"&&(h.method="next",h.arg=a);else return y;return h.delegate=null,L}H(D),c(D,m,"Generator"),c(D,s,function(){return this}),c(D,"toString",function(){return"[object Generator]"});function fe(g){var h={tryLoc:g[0]};1 in g&&(h.catchLoc=g[1]),2 in g&&(h.finallyLoc=g[2],h.afterLoc=g[3]),this.tryEntries.push(h)}function Z(g){var h=g.completion||{};h.type="normal",delete h.arg,g.completion=h}function ae(g){this.tryEntries=[{tryLoc:"root"}],g.forEach(fe,this),this.reset(!0)}t.keys=function(g){var h=Object(g),v=[];for(var E in h)v.push(E);return v.reverse(),function p(){for(;v.length;){var y=v.pop();if(y in h)return p.value=y,p.done=!1,p}return p.done=!0,p}};function ce(g){if(g){var h=g[s];if(h)return h.call(g);if(typeof g.next=="function")return g;if(!isNaN(g.length)){var v=-1,E=function p(){for(;++v<g.length;)if(o.call(g,v))return p.value=g[v],p.done=!1,p;return p.value=a,p.done=!0,p};return E.next=E}}return{next:le}}t.values=ce;function le(){return{value:a,done:!0}}return ae.prototype={constructor:ae,reset:function(g){if(this.prev=0,this.next=0,this.sent=this._sent=a,this.done=!1,this.delegate=null,this.method="next",this.arg=a,this.tryEntries.forEach(Z),!g)for(var h in this)h.charAt(0)==="t"&&o.call(this,h)&&!isNaN(+h.slice(1))&&(this[h]=a)},stop:function(){this.done=!0;var g=this.tryEntries[0],h=g.completion;if(h.type==="throw")throw h.arg;return this.rval},dispatchException:function(g){if(this.done)throw g;var h=this;function v($,C){return y.type="throw",y.arg=g,h.next=$,C&&(h.method="next",h.arg=a),!!C}for(var E=this.tryEntries.length-1;E>=0;--E){var p=this.tryEntries[E],y=p.completion;if(p.tryLoc==="root")return v("end");if(p.tryLoc<=this.prev){var I=o.call(p,"catchLoc"),P=o.call(p,"finallyLoc");if(I&&P){if(this.prev<p.catchLoc)return v(p.catchLoc,!0);if(this.prev<p.finallyLoc)return v(p.finallyLoc)}else if(I){if(this.prev<p.catchLoc)return v(p.catchLoc,!0)}else if(P){if(this.prev<p.finallyLoc)return v(p.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(g,h){for(var v=this.tryEntries.length-1;v>=0;--v){var E=this.tryEntries[v];if(E.tryLoc<=this.prev&&o.call(E,"finallyLoc")&&this.prev<E.finallyLoc){var p=E;break}}p&&(g==="break"||g==="continue")&&p.tryLoc<=h&&h<=p.finallyLoc&&(p=null);var y=p?p.completion:{};return y.type=g,y.arg=h,p?(this.method="next",this.next=p.finallyLoc,L):this.complete(y)},complete:function(g,h){if(g.type==="throw")throw g.arg;return g.type==="break"||g.type==="continue"?this.next=g.arg:g.type==="return"?(this.rval=this.arg=g.arg,this.method="return",this.next="end"):g.type==="normal"&&h&&(this.next=h),L},finish:function(g){for(var h=this.tryEntries.length-1;h>=0;--h){var v=this.tryEntries[h];if(v.finallyLoc===g)return this.complete(v.completion,v.afterLoc),Z(v),L}},catch:function(g){for(var h=this.tryEntries.length-1;h>=0;--h){var v=this.tryEntries[h];if(v.tryLoc===g){var E=v.completion;if(E.type==="throw"){var p=E.arg;Z(v)}return p}}throw new Error("illegal catch attempt")},delegateYield:function(g,h,v){return this.delegate={iterator:ce(g),resultName:h,nextLoc:v},this.method==="next"&&(this.arg=a),L}},t}(i.exports);try{regeneratorRuntime=e}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}})(We);var Re=(i,e)=>`${i}-${e}-${Math.random().toString(16).slice(3,8)}`;const qe=Re;let Ie=0;var Be=({id:i,action:e,payload:t={}})=>{let n=i;return typeof n>"u"&&(n=qe("Job",Ie),Ie+=1),{id:n,action:e,payload:t}},re={};let _e=!1;re.logging=_e;re.setLogging=i=>{_e=i};re.log=(...i)=>_e?console.log.apply(void 0,i):null;const Xe=Be,{log:he}=re,Ve=Re;let Oe=0;var Ke=()=>{const i=Ve("Scheduler",Oe),e={},t={};let n=[];Oe+=1;const o=()=>n.length,r=()=>Object.keys(e).length,a=()=>{if(n.length!==0){const c=Object.keys(e);for(let u=0;u<c.length;u+=1)if(typeof t[c[u]]>"u"){n[0](e[c[u]]);break}}},d=(c,u)=>new Promise((f,x)=>{const w=Xe({action:c,payload:u});n.push(async R=>{n.shift(),t[R.id]=w;try{f(await R[c].apply(void 0,[...u,w.id]))}catch(_){x(_)}finally{delete t[R.id],a()}}),he(`[${i}]: Add ${w.id} to JobQueue`),he(`[${i}]: JobQueue length=${n.length}`),a()});return{addWorker:c=>(e[c.id]=c,he(`[${i}]: Add ${c.id}`),he(`[${i}]: Number of workers=${r()}`),a(),c.id),addJob:async(c,...u)=>{if(r()===0)throw Error(`[${i}]: You need to have at least one worker before adding jobs`);return d(c,u)},terminate:async()=>{Object.keys(e).forEach(async c=>{await e[c].terminate()}),n=[]},getQueueLen:o,getNumWorkers:r}};function Je(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var Ze=Je;const Qe=Ze;var et=i=>{const e={};return typeof WorkerGlobalScope<"u"?e.type="webworker":Qe()?e.type="electron":typeof document=="object"?e.type="browser":typeof process=="object"&&typeof ke=="function"&&(e.type="node"),typeof i>"u"?e:e[i]};const tt=et("type")==="browser",nt=tt?i=>new URL(i,window.location.href).href:i=>i;var ot=i=>{const e={...i};return["corePath","workerPath","langPath"].forEach(t=>{i[t]&&(e[t]=nt(e[t]))}),e},it=i=>{const e=[],t=[],n=[],o=[],r=[];return i.blocks&&i.blocks.forEach(a=>{a.paragraphs.forEach(d=>{d.lines.forEach(s=>{s.words.forEach(l=>{l.symbols.forEach(m=>{r.push({...m,page:i,block:a,paragraph:d,line:s,word:l})}),o.push({...l,page:i,block:a,paragraph:d,line:s})}),n.push({...s,page:i,block:a,paragraph:d})}),t.push({...d,page:i,block:a})}),e.push({...a,page:i})}),{...i,blocks:e,paragraphs:t,lines:n,words:o,symbols:r}},Ae={TESSERACT_ONLY:0,LSTM_ONLY:1,TESSERACT_LSTM_COMBINED:2,DEFAULT:3};const st="5.1.1",rt={version:st};var at={workerBlobURL:!0,logger:()=>{}};const ct=rt.version,dt=at;var lt={...dt,workerPath:`https://cdn.jsdelivr.net/npm/tesseract.js@v${ct}/dist/worker.min.js`},ht=({workerPath:i,workerBlobURL:e})=>{let t;if(Blob&&URL&&e){const n=new Blob([`importScripts("${i}");`],{type:"application/javascript"});t=new Worker(URL.createObjectURL(n))}else t=new Worker(i);return t},ut=i=>{i.terminate()},pt=(i,e)=>{i.onmessage=({data:t})=>{e(t)}},mt=async(i,e)=>{i.postMessage(e)};const ye=i=>new Promise((e,t)=>{const n=new FileReader;n.onload=()=>{e(n.result)},n.onerror=({target:{error:{code:o}}})=>{t(Error(`File could not be read! Code=${o}`))},n.readAsArrayBuffer(i)}),Ee=async i=>{let e=i;if(typeof i>"u")return"undefined";if(typeof i=="string")/data:image\/([a-zA-Z]*);base64,([^"]*)/.test(i)?e=atob(i.split(",")[1]).split("").map(t=>t.charCodeAt(0)):e=await(await fetch(i)).arrayBuffer();else if(typeof HTMLElement<"u"&&i instanceof HTMLElement)i.tagName==="IMG"&&(e=await Ee(i.src)),i.tagName==="VIDEO"&&(e=await Ee(i.poster)),i.tagName==="CANVAS"&&await new Promise(t=>{i.toBlob(async n=>{e=await ye(n),t()})});else if(typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas){const t=await i.convertToBlob();e=await ye(t)}else(i instanceof File||i instanceof Blob)&&(e=await ye(i));return new Uint8Array(e)};var gt=Ee;const ft=lt,wt=ht,vt=ut,yt=pt,xt=mt,Lt=gt;var bt={defaultOptions:ft,spawnWorker:wt,terminateWorker:vt,onMessage:yt,send:xt,loadImage:Lt};const Et=ot,Mt=it,U=Be,{log:Pe}=re,Rt=Re,Q=Ae,{defaultOptions:_t,spawnWorker:St,terminateWorker:It,onMessage:Ot,loadImage:Te,send:Pt}=bt;let $e=0;var ze=async(i="eng",e=Q.LSTM_ONLY,t={},n={})=>{const o=Rt("Worker",$e),{logger:r,errorHandler:a,...d}=Et({..._t,...t}),s={},l={},m=typeof i=="string"?i.split("+"):i;let c=e,u=n;const f=[Q.DEFAULT,Q.LSTM_ONLY].includes(e)&&!d.legacyCore;let x,w;const R=new Promise((p,y)=>{w=p,x=y}),_=p=>{x(p.message)};let L=St(d);L.onerror=_,$e+=1;const S=(p,y)=>{s[p]=y},b=(p,y)=>{l[p]=y},M=({id:p,action:y,payload:I})=>new Promise((P,$)=>{Pe(`[${o}]: Start ${p}, action=${y}`);const C=`${y}-${p}`;S(C,P),b(C,$),Pt(L,{workerId:o,jobId:p,action:y,payload:I})}),O=()=>console.warn("`load` is depreciated and should be removed from code (workers now come pre-loaded)"),T=p=>M(U({id:p,action:"load",payload:{options:{lstmOnly:f,corePath:d.corePath,logging:d.logging}}})),B=(p,y,I)=>M(U({id:I,action:"FS",payload:{method:"writeFile",args:[p,y]}})),D=(p,y)=>M(U({id:y,action:"FS",payload:{method:"readFile",args:[p,{encoding:"utf8"}]}})),H=(p,y)=>M(U({id:y,action:"FS",payload:{method:"unlink",args:[p]}})),N=(p,y,I)=>M(U({id:I,action:"FS",payload:{method:p,args:y}})),X=()=>console.warn("`loadLanguage` is depreciated and should be removed from code (workers now come with language pre-loaded)"),V=(p,y)=>M(U({id:y,action:"loadLanguage",payload:{langs:p,options:{langPath:d.langPath,dataPath:d.dataPath,cachePath:d.cachePath,cacheMethod:d.cacheMethod,gzip:d.gzip,lstmOnly:[Q.DEFAULT,Q.LSTM_ONLY].includes(c)&&!d.legacyLang}}})),fe=()=>console.warn("`initialize` is depreciated and should be removed from code (workers now come pre-initialized)"),Z=(p,y,I,P)=>M(U({id:P,action:"initialize",payload:{langs:p,oem:y,config:I}})),ae=(p="eng",y,I,P)=>{if(f&&[Q.TESSERACT_ONLY,Q.TESSERACT_LSTM_COMBINED].includes(y))throw Error("Legacy model requested but code missing.");const $=y||c;c=$;const C=I||u;u=C;const G=(typeof p=="string"?p.split("+"):p).filter(W=>!m.includes(W));return m.push(...G),G.length>0?V(G,P).then(()=>Z(p,$,C,P)):Z(p,$,C,P)},ce=(p={},y)=>M(U({id:y,action:"setParameters",payload:{params:p}})),le=async(p,y={},I={blocks:!0,text:!0,hocr:!0,tsv:!0},P)=>M(U({id:P,action:"recognize",payload:{image:await Te(p),options:y,output:I}})),g=(p="Tesseract OCR Result",y=!1,I)=>(console.log("`getPDF` function is depreciated. `recognize` option `savePDF` should be used instead."),M(U({id:I,action:"getPDF",payload:{title:p,textonly:y}}))),h=async(p,y)=>{if(f)throw Error("`worker.detect` requires Legacy model, which was not loaded.");return M(U({id:y,action:"detect",payload:{image:await Te(p)}}))},v=async()=>(L!==null&&(It(L),L=null),Promise.resolve());Ot(L,({workerId:p,jobId:y,status:I,action:P,data:$})=>{const C=`${P}-${y}`;if(I==="resolve"){Pe(`[${p}]: Complete ${y}`);let K=$;P==="recognize"?K=Mt($):P==="getPDF"&&(K=Array.from({...$,length:Object.keys($).length})),s[C]({jobId:y,data:K})}else if(I==="reject")if(l[C]($),P==="load"&&x($),a)a($);else throw Error($);else I==="progress"&&r({...$,userJobId:y})});const E={id:o,worker:L,setResolve:S,setReject:b,load:O,writeText:B,readText:D,removeFile:H,FS:N,loadLanguage:X,initialize:fe,reinitialize:ae,setParameters:ce,recognize:le,getPDF:g,detect:h,terminate:v};return T().then(()=>V(i)).then(()=>Z(i,e,n)).then(()=>w(E)).catch(()=>{}),R};const De=ze,Tt=async(i,e,t)=>{const n=await De(e,1,t);return n.recognize(i).finally(async()=>{await n.terminate()})},$t=async(i,e)=>{const t=await De("osd",0,e);return t.detect(i).finally(async()=>{await t.terminate()})};var Ct={recognize:Tt,detect:$t},Bt={AFR:"afr",AMH:"amh",ARA:"ara",ASM:"asm",AZE:"aze",AZE_CYRL:"aze_cyrl",BEL:"bel",BEN:"ben",BOD:"bod",BOS:"bos",BUL:"bul",CAT:"cat",CEB:"ceb",CES:"ces",CHI_SIM:"chi_sim",CHI_TRA:"chi_tra",CHR:"chr",CYM:"cym",DAN:"dan",DEU:"deu",DZO:"dzo",ELL:"ell",ENG:"eng",ENM:"enm",EPO:"epo",EST:"est",EUS:"eus",FAS:"fas",FIN:"fin",FRA:"fra",FRK:"frk",FRM:"frm",GLE:"gle",GLG:"glg",GRC:"grc",GUJ:"guj",HAT:"hat",HEB:"heb",HIN:"hin",HRV:"hrv",HUN:"hun",IKU:"iku",IND:"ind",ISL:"isl",ITA:"ita",ITA_OLD:"ita_old",JAV:"jav",JPN:"jpn",KAN:"kan",KAT:"kat",KAT_OLD:"kat_old",KAZ:"kaz",KHM:"khm",KIR:"kir",KOR:"kor",KUR:"kur",LAO:"lao",LAT:"lat",LAV:"lav",LIT:"lit",MAL:"mal",MAR:"mar",MKD:"mkd",MLT:"mlt",MSA:"msa",MYA:"mya",NEP:"nep",NLD:"nld",NOR:"nor",ORI:"ori",PAN:"pan",POL:"pol",POR:"por",PUS:"pus",RON:"ron",RUS:"rus",SAN:"san",SIN:"sin",SLK:"slk",SLV:"slv",SPA:"spa",SPA_OLD:"spa_old",SQI:"sqi",SRP:"srp",SRP_LATN:"srp_latn",SWA:"swa",SWE:"swe",SYR:"syr",TAM:"tam",TEL:"tel",TGK:"tgk",TGL:"tgl",THA:"tha",TIR:"tir",TUR:"tur",UIG:"uig",UKR:"ukr",URD:"urd",UZB:"uzb",UZB_CYRL:"uzb_cyrl",VIE:"vie",YID:"yid"},At={OSD_ONLY:"0",AUTO_OSD:"1",AUTO_ONLY:"2",AUTO:"3",SINGLE_COLUMN:"4",SINGLE_BLOCK_VERT_TEXT:"5",SINGLE_BLOCK:"6",SINGLE_LINE:"7",SINGLE_WORD:"8",CIRCLE_WORD:"9",SINGLE_CHAR:"10",SPARSE_TEXT:"11",SPARSE_TEXT_OSD:"12",RAW_LINE:"13"};const zt=Ke,Dt=ze,Ft=Ct,Nt=Bt,jt=Ae,Ut=At,{setLogging:kt}=re;var Yt={languages:Nt,OEM:jt,PSM:Ut,createScheduler:zt,createWorker:Dt,setLogging:kt,...Ft};const xe=Ye(Yt);J.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";class Ht{constructor(){this.initialized=!1,this.worker=null}async initialize(e){if(!this.initialized)try{e==null||e({status:"loading",message:"Loading Tesseract OCR engine...",progress:10}),this.worker=await xe.createWorker("eng",1,{logger:t=>{t.status==="loading tesseract core"?e==null||e({status:"loading",message:"Loading OCR core...",progress:30}):t.status==="loading language traineddata"?e==null||e({status:"loading",message:"Loading English language model...",progress:60}):t.status==="initialized tesseract"&&(e==null||e({status:"loading",message:"Initializing OCR engine...",progress:90}))},errorHandler:t=>{console.error("Tesseract error:",t)}}),await this.worker.setParameters({tessedit_ocr_engine_mode:xe.OEM.LSTM_ONLY,preserve_interword_spaces:"1",tessedit_pageseg_mode:xe.PSM.AUTO}),this.initialized=!0,e==null||e({status:"ready",message:"Tesseract OCR engine loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize Tesseract:",t),t}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.worker.recognize(e);return this.formatResults(t)}formatResults(e){const t=[];for(const o of e.data.words)o.confidence>30&&t.push({box:[[o.bbox.x0,o.bbox.y0],[o.bbox.x1,o.bbox.y0],[o.bbox.x1,o.bbox.y1],[o.bbox.x0,o.bbox.y1]],text:o.text,confidence:o.confidence/100});return this.groupWordsIntoLines(t)}groupWordsIntoLines(e){if(e.length===0)return[];e.sort((o,r)=>o.box[0][1]-r.box[0][1]);const t=[];let n={words:[e[0]],minY:e[0].box[0][1],maxY:e[0].box[2][1]};for(let o=1;o<e.length;o++){const r=e[o],a=r.box[0][1];a<=n.maxY&&a>=n.minY-5?(n.words.push(r),n.minY=Math.min(n.minY,a),n.maxY=Math.max(n.maxY,r.box[2][1])):(t.push(this.mergeLine(n)),n={words:[r],minY:a,maxY:r.box[2][1]})}return n.words.length>0&&t.push(this.mergeLine(n)),t}mergeLine(e){e.words.sort((s,l)=>s.box[0][0]-l.box[0][0]);const t=Math.min(...e.words.map(s=>s.box[0][0])),n=Math.max(...e.words.map(s=>s.box[1][0])),o=Math.min(...e.words.map(s=>s.box[0][1])),r=Math.max(...e.words.map(s=>s.box[2][1])),a=e.words.map(s=>s.text).join(" "),d=e.words.reduce((s,l)=>s+l.confidence,0)/e.words.length;return{box:[[t,o],[n,o],[n,r],[t,r]],text:a,confidence:d}}async processPDF(e){const t=await e.arrayBuffer(),n=await J.getDocument({data:t}).promise,o=n.numPages,r=[];for(let a=1;a<=o;a++){const d=await n.getPage(a),s=d.getViewport({scale:2}),l=document.createElement("canvas"),m=l.getContext("2d");l.width=s.width,l.height=s.height,await d.render({canvasContext:m,viewport:s}).promise;const c=await new Promise(x=>l.toBlob(x,"image/png")),u=await this.worker.recognize(c),f=this.formatResults(u);r.push({page:a,results:f})}return r}async cleanup(){this.worker&&(await this.worker.terminate(),this.worker=null,this.initialized=!1)}}const Se=new Ht;J.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";let ne=null,F="tesseract",Y="improved",ie=Se;const Me=document.getElementById("fileInput"),ee=document.getElementById("uploadArea"),Fe=document.getElementById("previewSection"),k=document.getElementById("previewImage"),Gt=document.getElementById("processBtn"),me=document.getElementById("resultsSection"),Le=document.getElementById("loadingIndicator"),se=document.getElementById("ocrResults"),Wt=document.getElementById("copyBtn"),qt=document.getElementById("downloadBtn"),Xt=document.getElementById("resetBtn");async function Vt(){console.log("Initializing OCR engines..."),z("Loading OCR engines...","info");try{await Promise.all([de.initialize(i=>{F==="paddle"&&Y==="improved"&&z(i.message,i.status==="ready"?"success":"info");const e=document.querySelector("#loadingIndicator p");e&&i.progress!==void 0&&F==="paddle"&&Y==="improved"&&(e.textContent=`${i.message} (${i.progress}%)`)}),oe.initialize(i=>{F==="paddle"&&Y==="standard"&&z(i.message,i.status==="ready"?"success":"info")}),Se.initialize(i=>{F==="tesseract"&&z(i.message,i.status==="ready"?"success":"info")})]),console.log("OCR engines loaded successfully!"),z("Ready to process images","success"),Kt()}catch(i){console.error("Failed to initialize OCR engines:",i),q("Failed to load OCR engines. Please check your internet connection and refresh the page.")}}function Kt(){ee.addEventListener("click",()=>Me.click()),Me.addEventListener("change",Qt),ee.addEventListener("dragover",en),ee.addEventListener("dragleave",tn),ee.addEventListener("drop",nn),Gt.addEventListener("click",on),Wt.addEventListener("click",rn),qt.addEventListener("click",an),Xt.addEventListener("click",cn),document.querySelectorAll('input[name="ocrEngine"]').forEach(i=>{i.addEventListener("change",Jt)}),document.querySelectorAll('input[name="preprocessing"]').forEach(i=>{i.addEventListener("change",Zt)}),document.getElementById("detectionModel").addEventListener("change",be),document.getElementById("recognitionModel").addEventListener("change",be),document.getElementById("dictionary").addEventListener("change",be)}async function Jt(i){F=i.target.value,F==="paddle"?ie=Y==="improved"?de:oe:ie=Se;const e=document.getElementById("paddleOptions");e.style.display=F==="paddle"?"block":"none",z(`Switched to ${F==="paddle"?"PaddleOCR":"Tesseract.js"}`,"info")}async function Zt(i){if(Y=i.target.value,F==="paddle"){if(ie=Y==="improved"?de:oe,Y==="standard"){const e=document.getElementById("detectionModel").value,t=document.getElementById("recognitionModel").value,n=document.getElementById("dictionary").value;oe.setModelConfig({detection:e,recognition:t,dictionary:n}),z("Loading standard preprocessing models...","info");try{await oe.initialize(o=>{z(o.message,o.status==="ready"?"success":"info")}),z("Standard preprocessing ready!","success")}catch(o){console.error("Failed to initialize standard preprocessing:",o),q("Failed to load standard preprocessing models"),Y="improved",ie=de,document.getElementById("preprocessImproved").checked=!0}}z(`Switched to ${Y==="improved"?"Improved (PPU)":"Standard"} preprocessing`,"info")}}async function be(){if(F!=="paddle")return;const i=document.getElementById("detectionModel").value,e=document.getElementById("recognitionModel").value,t=document.getElementById("dictionary").value;Y==="improved"?de.setModelConfig({detection:i,recognition:e,dictionary:t}):oe.setModelConfig({detection:i,recognition:e,dictionary:t}),z("Loading new models...","info");try{await ie.initialize(n=>{z(n.message,n.status==="ready"?"success":"info")}),z("Models updated successfully!","success")}catch(n){console.error("Failed to load new models:",n),q("Failed to load new models. Please try again.")}}function Qt(i){const e=i.target.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?Ne(e):q("Please select a valid image or PDF file")}function en(i){i.preventDefault(),ee.classList.add("dragover")}function tn(i){i.preventDefault(),ee.classList.remove("dragover")}function nn(i){i.preventDefault(),ee.classList.remove("dragover");const e=i.dataTransfer.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?Ne(e):q("Please drop a valid image or PDF file")}async function Ne(i){if(ne){const e=k.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),ne=null}if(se.innerHTML="",me.style.display="none",ne=i,Fe.style.display="block",me.style.display="none",i.type==="application/pdf"){k.style.display="none";const e=k.parentElement;e.innerHTML="";const t=document.createElement("div");t.className="pdf-preview",t.innerHTML=`
            <div class="pdf-header">
                <h3>${i.name}</h3>
                <p class="pdf-info">Loading PDF preview...</p>
            </div>
            <div class="pdf-pages" id="pdfPages"></div>
        `,e.appendChild(t);try{const n=await i.arrayBuffer(),o=await J.getDocument({data:n}).promise,r=o.numPages,a=t.querySelector(".pdf-info");a.textContent=`${r} page${r>1?"s":""}`;const d=document.getElementById("pdfPages"),s=Math.min(r,3);for(let l=1;l<=s;l++){const m=await o.getPage(l),c=m.getViewport({scale:.5}),u=document.createElement("div");u.className="pdf-page-preview";const f=document.createElement("canvas"),x=f.getContext("2d");f.height=c.height,f.width=c.width;const w={canvasContext:x,viewport:c};await m.render(w).promise,u.innerHTML=`<p>Page ${l}</p>`,u.appendChild(f),d.appendChild(u)}r>3&&(d.innerHTML+=`<p class="more-pages">... and ${r-3} more pages</p>`)}catch(n){console.error("Error rendering PDF preview:",n),t.querySelector(".pdf-info").textContent="Error loading PDF preview"}}else{const e=document.querySelector(".pdf-placeholder");e&&e.remove(),k.style.display="block";const t=URL.createObjectURL(i);k.src=t,k.onload=()=>{z('Image loaded. Click "Extract Text" to process.',"success")},k.onerror=()=>{URL.revokeObjectURL(t),q("Failed to load image")}}}async function on(){if(!ne){q("Please upload an image first");return}me.style.display="block",Le.style.display="flex",se.innerHTML="";const i=document.querySelector("#loadingIndicator p");let e=F==="paddle"?"PaddleOCR":"Tesseract.js";F==="paddle"&&(e+=` (${Y==="improved"?"Improved PPU":"Standard"})`),i&&(i.textContent=`Processing image with ${e}...`);try{console.log(`Processing image with ${e}...`),z("Detecting and recognizing text...","info");const t=performance.now(),n=await ie.process(ne),o=performance.now()-t;console.log(`Processing completed in ${o.toFixed(2)}ms`),console.log("OCR Results:",n),Le.style.display="none",n&&n.length>0?(Ce(n,o,e),z(`Text extraction complete! Found ${n.length} text regions.`,"success")):(Ce([],o,e),z("No text found in the image","warning"))}catch(t){console.error("OCR processing error:",t),Le.style.display="none",q("Failed to process image: "+t.message)}}function Ce(i,e,t="PaddleOCR"){var r;const n=Array.isArray(i)&&((r=i[0])==null?void 0:r.page)!==void 0,o=F==="paddle"&&i.length>0&&i[0].box;if(n){let a="",d=0,s="";i.forEach(l=>{const m=l.results.map(c=>c.text).join(`
`);a+=`
--- Page ${l.page} ---
${m}
`,d+=l.results.length,s+=`
                <div class="page-results">
                    <h4>Page ${l.page}</h4>
                    <ul class="detection-list">
                        ${l.results.map((c,u)=>`
                            <li data-index="${u}">
                                <span class="detection-index">${u+1}.</span>
                                <span class="detection-text">${te(c.text)}</span>
                                <span class="detection-confidence">${(c.confidence*100).toFixed(1)}%</span>
                            </li>
                        `).join("")}
                    </ul>
                </div>
            `}),se.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Pages Processed:</strong> ${i.length}</p>
                <p><strong>Total Text Regions:</strong> ${d}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${te(a||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details by Page:</h3>
                ${s}
            </div>
        `}else if(o)sn(i,e,t);else{const a=i.map(d=>d.text).join(`
`);se.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Text Regions Found:</strong> ${i.length}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${te(a||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details:</h3>
                <ul class="detection-list">
                    ${i.map((d,s)=>`
                        <li>
                            <span class="detection-index">${s+1}.</span>
                            <span class="detection-text">${te(d.text)}</span>
                            <span class="detection-confidence">${(d.confidence*100).toFixed(1)}%</span>
                        </li>
                    `).join("")}
                </ul>
            </div>
        `}}function sn(i,e,t){const n=i.map(r=>r.text).join(`
`),o=hn(i);se.innerHTML=`
        <div class="ocr-stats">
            <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
            <p><strong>Text Regions Found:</strong> ${i.length}</p>
            <p><strong>Engine:</strong> ${t}</p>
            <p><strong>Average Confidence:</strong> ${ln(i)}%</p>
        </div>
        
        <div class="paddle-results-container">
            <div class="result-tabs">
                <button class="result-tab active" onclick="showResultTab('visual')">Visual Results</button>
                <button class="result-tab" onclick="showResultTab('text')">Text Only</button>
                <button class="result-tab" onclick="showResultTab('grouped')">Grouped by Line</button>
            </div>
            
            <div id="visualResults" class="tab-content active">
                <div class="result-image-container">
                    <img id="resultImage" src="${k.src}" alt="OCR Result">
                    <div class="bounding-box-overlay" id="boundingBoxOverlay"></div>
                </div>
                <div class="detection-results">
                    <h3>Detected Text Regions:</h3>
                    <ul class="detection-list" id="visualDetectionList">
                        ${i.map((r,a)=>{const d=je(r.confidence);return`
                                <li data-index="${a}" onmouseover="highlightBox(${a})" onmouseout="unhighlightBox(${a})" onclick="selectBox(${a})">
                                    <span class="detection-index">${a+1}.</span>
                                    <span class="detection-text">${te(r.text)}</span>
                                    <span class="detection-confidence ${d}">${(r.confidence*100).toFixed(1)}%</span>
                                </li>
                            `}).join("")}
                    </ul>
                </div>
            </div>
            
            <div id="textResults" class="tab-content grouped-results">
                <div class="text-result">
                    <h3>Extracted Text:</h3>
                    <div class="text-content" id="extractedText">${te(n||"No text detected")}</div>
                </div>
            </div>
            
            <div id="groupedResults" class="tab-content grouped-results">
                <h3>Text Grouped by Line:</h3>
                ${o.map((r,a)=>`
                    <div class="text-region-group">
                        <div class="region-header">
                            <span class="region-title">Line ${a+1}</span>
                            <div class="region-confidence">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${r.avgConfidence}%"></div>
                                </div>
                                <span class="confidence-text">${r.avgConfidence.toFixed(1)}%</span>
                            </div>
                        </div>
                        <p>${te(r.text)}</p>
                    </div>
                `).join("")}
            </div>
        </div>
    `,setTimeout(()=>Ue(i),100)}async function rn(){const i=document.getElementById("extractedText");if(i)try{await navigator.clipboard.writeText(i.textContent),dn("Text copied to clipboard!")}catch{q("Failed to copy text")}}function an(){const i=document.getElementById("extractedText");if(i){const e=i.textContent,t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`pp-ocrv5-result-${Date.now()}.txt`,o.click(),URL.revokeObjectURL(n)}}function cn(){if(ne){const e=k.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),ne=null}Me.value="",Fe.style.display="none",me.style.display="none",se.innerHTML="",k.src="";const i=k.parentElement;i.innerHTML='<img id="previewImage" alt="Preview">',window.previewImage=document.getElementById("previewImage"),z("Ready to process a new image","info")}function te(i){const e=document.createElement("div");return e.textContent=i,e.innerHTML}function q(i){z(i,"error");const e=document.createElement("div");e.className="toast error",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},5e3)}function dn(i){const e=document.createElement("div");e.className="toast success",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}function z(i,e="info"){console.log(`[${e.toUpperCase()}] ${i}`);const t=document.getElementById("status");t&&(t.textContent=i,t.className=`status ${e}`)}function ln(i){return i.length===0?0:(i.reduce((t,n)=>t+n.confidence,0)/i.length*100).toFixed(1)}function je(i){const e=i*100;return e>=80?"high-confidence":e>=60?"medium-confidence":"low-confidence"}function hn(i){if(i.length===0)return[];const e=[...i].sort((o,r)=>{const a=Math.min(...o.box.map(s=>s[1])),d=Math.min(...r.box.map(s=>s[1]));return a-d}),t=[];let n=[e[0]];for(let o=1;o<e.length;o++){const r=Math.min(...e[o-1].box.map(d=>d[1])),a=Math.min(...e[o].box.map(d=>d[1]));Math.abs(a-r)<20?n.push(e[o]):(t.push(n),n=[e[o]])}return n.length>0&&t.push(n),t.map(o=>{o.sort((d,s)=>{const l=Math.min(...d.box.map(c=>c[0])),m=Math.min(...s.box.map(c=>c[0]));return l-m});const r=o.map(d=>d.text).join(" "),a=o.reduce((d,s)=>d+s.confidence,0)/o.length*100;return{text:r,avgConfidence:a,items:o}})}function Ue(i){const e=document.getElementById("boundingBoxOverlay"),t=document.getElementById("resultImage");if(!e||!t)return;if(e.innerHTML="",!t.complete){t.onload=()=>Ue(i);return}const n=t.getBoundingClientRect(),o=t.naturalWidth/n.width,r=t.naturalHeight/n.height;i.forEach((a,d)=>{const s=a.box,l=Math.min(...s.map(w=>w[0]))/o,m=Math.min(...s.map(w=>w[1]))/r,c=Math.max(...s.map(w=>w[0]))/o,u=Math.max(...s.map(w=>w[1]))/r,f=document.createElement("div");f.className=`text-box ${je(a.confidence)}`,f.dataset.index=d,f.style.left=`${l}px`,f.style.top=`${m}px`,f.style.width=`${c-l}px`,f.style.height=`${u-m}px`;const x=document.createElement("div");x.className="text-box-label",x.textContent=`${d+1}: ${(a.confidence*100).toFixed(0)}%`,f.appendChild(x),f.onclick=()=>selectBox(d),e.appendChild(f)})}window.showResultTab=function(i){document.querySelectorAll(".result-tab").forEach(e=>{e.classList.remove("active")}),event.target.classList.add("active"),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")}),i==="visual"?document.getElementById("visualResults").classList.add("active"):i==="text"?document.getElementById("textResults").classList.add("active"):i==="grouped"&&document.getElementById("groupedResults").classList.add("active")};window.highlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.add("hover"),t&&t.classList.add("highlighted")};window.unhighlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.remove("hover"),t&&t.classList.remove("highlighted")};window.selectBox=function(i){document.querySelectorAll(".text-box.selected").forEach(t=>{t.classList.remove("selected")});const e=document.querySelector(`.text-box[data-index="${i}"]`);if(e){e.classList.add("selected");const t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlighted"),setTimeout(()=>t.classList.remove("highlighted"),2e3))}};document.addEventListener("DOMContentLoaded",Vt);
//# sourceMappingURL=index-BnhjOGw6.js.map
