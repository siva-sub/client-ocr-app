import{b as fe,F as pe,H as ge}from"./onnxruntime-CqRzMC93.js";import{p as J,c as ke,g as Ye}from"./pdfjs-BhC3vFUT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();J.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";fe.wasm.wasmPaths="/client-ocr-app/assets/";fe.wasm.numThreads=1;const we="/client-ocr-app/models/",P={det_limit_side_len:1280,det_limit_type:"max",det_db_thresh:.05,det_db_box_thresh:.1,det_db_unclip_ratio:2.5,det_db_min_size:2,det_db_max_candidates:2e3,det_use_dilation:!0,det_dilation_kernel:3,rec_image_height:48,rec_image_width:320,rec_batch_num:6,drop_score:.05,det_mean:[.485,.456,.406],det_std:[.229,.224,.225],rec_mean:.5,rec_std:.5,min_area_thresh:2,vertical_gap_threshold:.5,english_mode:!0,min_word_confidence:.1,enable_word_splitting:!0,grid_size:16,overlap_ratio:.2};class He{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"PP-OCRv5_mobile_rec_infer.onnx",dictionary:"ppocr_keys_v1.txt"}}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release(),this.detectionSession=await pe.create(we+this.modelConfig.detection,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Detection model loaded:",this.detectionSession.inputNames,this.detectionSession.outputNames);const n=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${n}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release(),this.recognitionSession=await pe.create(we+this.modelConfig.recognition,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Recognition model loaded:",this.recognitionSession.inputNames,this.recognitionSession.outputNames),this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR ready!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(we+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.blobToImage(e),n=await this.detectText(t),o=await this.recognizeText(t,n);return this.mergeTextLines(o)}async detectText(e){if(!this.detectionSession)throw new Error("Detection model not loaded");try{console.log("Starting image resize...");const{resizedImage:t,ratio:n}=await this.resizeForDetection(e);console.log("Image resized, ratio:",n),console.log("Starting preprocessing...");const o=await this.preprocessForDetection(t);console.log("Preprocessing complete, tensor shape:",o.dims),console.log("Running detection model...");const s={[this.detectionSession.inputNames[0]]:o},r=await this.detectionSession.run(s);console.log("Detection complete");const d=await this.postprocessDetection(r[this.detectionSession.outputNames[0]],t.width,t.height,n);return console.log(`Detected ${d.length} text regions`),this.sortBoxes(d)}catch(t){return console.error("Error in detectText:",t),console.error("Error details:",{message:t.message,stack:t.stack,name:t.name,code:t.code}),[]}}async resizeForDetection(e){const t=P.det_limit_side_len;let n=e.width,o=e.height,s=1;Math.max(o,n)>t&&(s=o>n?t/o:t/n),n=Math.round(n*s),o=Math.round(o*s);const r=P.grid_size,d=Math.round(n/r)*r,a=Math.round(o/r)*r;await this.preprocessImage(e,d,a);const l=new Image;return new Promise(f=>{this.canvas.toBlob(c=>{const p=URL.createObjectURL(c);l.onload=()=>{URL.revokeObjectURL(p),f({resizedImage:l,ratio:s})},l.src=p})})}async preprocessImage(e,t,n){this.canvas.width=t,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,t,n),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high";const o=Math.min(t/e.width,n/e.height),s=e.width*o,r=e.height*o,d=(t-s)/2,a=(n-r)/2;this.ctx.drawImage(e,d,a,s,r);const l=this.ctx.getImageData(0,0,t,n),f=l.data;for(let c=0;c<f.length;c+=4){let h=(.299*f[c]+.587*f[c+1]+.114*f[c+2]-128)*1.2+128;h>240?h=255:h<15&&(h=0),h=Math.max(0,Math.min(255,h)),f[c]=h,f[c+1]=h,f[c+2]=h}return this.ctx.putImageData(l,0,0),this.canvas}async preprocessForDetection(e){this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data,o=e.width*e.height,s=new Float32Array(3*o);for(let r=0;r<o;r++){const d=r*4;s[r]=(n[d]/255-P.det_mean[0])/P.det_std[0],s[o+r]=(n[d+1]/255-P.det_mean[1])/P.det_std[1],s[2*o+r]=(n[d+2]/255-P.det_mean[2])/P.det_std[2]}return new ge("float32",s,[1,3,e.height,e.width])}async postprocessDetection(e,t,n,o){try{let s,r,d;if(e.dims.length===4){const[h,y,x,E]=e.dims;s=x,r=E,d=e.data}else if(e.dims.length===3){const[h,y,x]=e.dims;s=y,r=x,d=e.data}else throw new Error(`Unexpected output tensor dimensions: ${e.dims}`);console.log(`Detection output shape: ${s}x${r}, total pixels: ${s*r}`),console.log("Output tensor dims:",e.dims),console.log("Data length:",d.length);const a=new Float32Array(s*r);for(let h=0;h<s*r;h++)a[h]=1/(1+Math.exp(-d[h]));const l=new Uint8Array(s*r);for(let h=0;h<s*r;h++)l[h]=a[h]>P.det_db_thresh?255:0;const f=[],c=new Set;let p=0;for(let h=0;h<s&&p<P.det_db_max_candidates;h++)for(let y=0;y<r&&p<P.det_db_max_candidates;y++){const x=h*r+y;if(l[x]===255&&!c.has(x)){const E=this.findConnectedComponent(l,r,s,y,h,c,a);E&&E.score>=P.det_db_box_thresh&&(E.points=E.points.map(b=>[Math.round(b[0]/o),Math.round(b[1]/o)]),this.calculatePolygonArea(E.points)>P.min_area_thresh&&(f.push(E),p++))}}return f}catch(s){throw console.error("Error in postprocessDetection:",s),new Error(`Detection post-processing failed: ${s.message}`)}}findConnectedComponent(e,t,n,o,s,r,d){const a=[[o,s]],l=[];let f=0,c=0;const p=1e4,h=s*t+o;if(r.has(h)||e[h]!==255)return null;const y=new Set;for(y.add(h);a.length>0&&l.length<p;){const[T,A]=a.pop(),F=A*t+T;if(!r.has(F)&&(r.add(F),e[F]===255)){l.push([T,A]),f+=d[F],c++;const oe=[[T,A-1],[T,A+1],[T-1,A],[T+1,A]];for(const[N,H]of oe)if(N>=0&&N<t&&H>=0&&H<n){const G=H*t+N;if(!r.has(G)&&e[G]===255){const ae=Math.abs(H-s),W=Math.abs(N-o);(ae<n*.05||W<t*.3)&&(a.push([N,H]),y.add(G))}}}}if(l.length<P.det_db_min_size)return null;const x=l.map(T=>T[0]),E=l.map(T=>T[1]);let I=Math.min(...x),b=Math.max(...x),D=Math.min(...E),$=Math.max(...E);const R=(b-I)*.1,z=($-D)*.2;return I=Math.max(0,I-R),b=Math.min(t-1,b+R),D=Math.max(0,D-z),$=Math.min(n-1,$+z),{points:[[I,D],[b,D],[b,$],[I,$]],score:f/c}}calculatePolygonArea(e){let t=0;const n=e.length;for(let o=0;o<n;o++){const s=(o+1)%n;t+=e[o][0]*e[s][1],t-=e[s][0]*e[o][1]}return Math.abs(t)/2}sortBoxes(e){if(e.length===0)return e;e.sort((t,n)=>{const o=t.points[0][1],s=n.points[0][1];return o-s});for(let t=e.length-1;t>0;t--)for(let n=t-1;n>=0&&(Math.abs(e[n+1].points[0][1]-e[n].points[0][1])<10&&e[n+1].points[0][0]<e[n].points[0][0]);n--){const o=e[n];e[n]=e[n+1],e[n+1]=o}return e}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[],o=P.rec_batch_num;for(let s=0;s<t.length;s+=o){const r=t.slice(s,Math.min(s+o,t.length)),d=await this.processBatch(e,r);n.push(...d)}return n}async processBatch(e,t){const n=[],o=[],s=[];for(const d of t){const a=await this.getRotateCropImage(e,d),l=a.width/a.height;o.push(a),s.push(l)}const r=Array.from({length:t.length},(d,a)=>a).sort((d,a)=>s[d]-s[a]);for(const d of r){const a=o[d],l=t[d],f=await this.preprocessForRecognition(a),c={[this.recognitionSession.inputNames[0]]:f},p=await this.recognitionSession.run(c),h=await this.decodeRecognition(p[this.recognitionSession.outputNames[0]]);h.score>=P.drop_score&&n.push({text:h.text,confidence:h.score,box:l.points})}return n}async getRotateCropImage(e,t){const n=t.points;Math.sqrt(Math.pow(n[0][0]-n[1][0],2)+Math.pow(n[0][1]-n[1][1],2)),Math.sqrt(Math.pow(n[2][0]-n[3][0],2)+Math.pow(n[2][1]-n[3][1],2)),Math.sqrt(Math.pow(n[0][0]-n[3][0],2)+Math.pow(n[0][1]-n[3][1],2)),Math.sqrt(Math.pow(n[1][0]-n[2][0],2)+Math.pow(n[1][1]-n[2][1],2));const o=Math.min(...n.map(c=>c[0])),s=Math.max(...n.map(c=>c[0])),r=Math.min(...n.map(c=>c[1])),d=Math.max(...n.map(c=>c[1])),a=s-o,l=d-r;if(this.canvas.width=a,this.canvas.height=l,this.ctx.drawImage(e,o,r,a,l,0,0,a,l),l*1/a>=1.5){const c=document.createElement("canvas"),p=c.getContext("2d",{willReadFrequently:!0});c.width=l,c.height=a,p.translate(l/2,a/2),p.rotate(Math.PI/2),p.drawImage(this.canvas,-a/2,-l/2),this.canvas.width=l,this.canvas.height=a,this.ctx.drawImage(c,0,0)}const f=new Image;return new Promise(c=>{this.canvas.toBlob(p=>{const h=URL.createObjectURL(p);f.onload=()=>{URL.revokeObjectURL(h),c(f)},f.src=h})})}async preprocessForRecognition(e){const n=P.rec_image_height,o=P.rec_image_width,s=e.height,d=e.width/s;let a;Math.ceil(n*d)>o?a=o:a=Math.ceil(n*d),this.canvas.width=a,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,a,n),this.ctx.drawImage(e,0,0,a,n);const f=this.ctx.getImageData(0,0,a,n).data,c=new Float32Array(3*n*o);for(let p=0;p<3;p++)for(let h=0;h<n;h++)for(let y=0;y<a;y++){const x=(h*a+y)*4+p,E=p*n*o+h*o+y;c[E]=(f[x]/255-P.rec_mean)/P.rec_std}return new ge("float32",c,[1,3,n,o])}async decodeRecognition(e){const[t,n,o]=e.dims,s=e.data,r=[],d=[];for(let c=0;c<n;c++){let p=0,h=s[c*o];for(let y=1;y<o;y++){const x=s[c*o+y];x>h&&(h=x,p=y)}r.push(p),d.push(h)}const a=[],l=[];let f=-1;for(let c=0;c<r.length;c++){const p=r[c];p!==0&&p!==f&&p<this.charDict.length&&(a.push(this.charDict[p]),l.push(d[c])),f=p}return{text:a.join(""),score:l.length>0?l.reduce((c,p)=>c+p)/l.length:0}}mergeTextLines(e){if(e.length===0)return e;let t=this.filterResults(e);if(t.length===0)return t;t=this.postProcessEnglishText(t);const n=t.map(a=>{const l=a.box.map(f=>f[1]);return Math.max(...l)-Math.min(...l)}),o=n.reduce((a,l)=>a+l)/n.length,s=[];let r=[t[0]];for(let a=1;a<t.length;a++){const l=t[a],f=t[a-1],c=Math.min(...f.box.map(x=>x[1])),p=Math.min(...l.box.map(x=>x[1])),h=Math.abs(p-c),y=o*P.vertical_gap_threshold;h<=y?r.push(l):(s.push(r),r=[l])}r.length>0&&s.push(r);const d=[];for(const a of s){a.sort((y,x)=>{const E=Math.min(...y.box.map(b=>b[0])),I=Math.min(...x.box.map(b=>b[0]));return E-I});const l=a.map(y=>y.text).join(" "),f=a.reduce((y,x)=>y+x.confidence,0)/a.length,c=a.flatMap(y=>y.box),p=c.map(y=>y[0]),h=c.map(y=>y[1]);d.push({text:l,confidence:f,box:[[Math.min(...p),Math.min(...h)],[Math.max(...p),Math.min(...h)],[Math.max(...p),Math.max(...h)],[Math.min(...p),Math.max(...h)]]})}return d}filterResults(e){const t=P.drop_score;return e.filter(n=>n.confidence<t?!1:n.text&&n.text.trim().length>0)}async processPDF(e){const t=await e.arrayBuffer(),n=await J.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const d=await n.getPage(r),a=d.getViewport({scale:2}),l=document.createElement("canvas"),f=l.getContext("2d");l.width=a.width,l.height=a.height,await d.render({canvasContext:f,viewport:a}).promise;const c=await new Promise(h=>l.toBlob(h)),p=await this.process(c);s.push({page:r,results:p})}return s}async blobToImage(e){return new Promise((t,n)=>{const o=new Image,s=URL.createObjectURL(e);o.onload=()=>{URL.revokeObjectURL(s),t(o)},o.onerror=()=>{URL.revokeObjectURL(s),n(new Error("Failed to load image"))},o.src=s})}postProcessEnglishText(e){return e.map(t=>{let n=t.text;n=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([a-zA-Z])(\d)/g,"$1 $2").replace(/(\d)([a-zA-Z])/g,"$1 $2").replace(/\s+/g," ").replace(/([.,!?;:])([a-zA-Z])/g,"$1 $2").trim();const o={tne:"the",tnat:"that",wnen:"when",wnere:"where",witn:"with","l'":"I'"," l ":" I ","^l ":"I "};for(const[s,r]of Object.entries(o)){const d=new RegExp(s,"gi");n=n.replace(d,r)}return{...t,text:n}})}}const le=new He;J.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";fe.wasm.wasmPaths="/client-ocr-app/assets/";fe.wasm.numThreads=1;const ve="/client-ocr-app/models/",U={det_limit_side_len:1280,det_db_thresh:.05,det_db_box_thresh:.15,det_db_unclip_ratio:2.5,drop_score:.05,mean:[.485,.456,.406],std:[.229,.224,.225]};class Ge{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"en_PP-OCRv4_mobile_rec_infer.onnx",dictionary:"en_dict.txt"}}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){this.initialized=!1;try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release(),this.detectionSession=await pe.create(ve+this.modelConfig.detection,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Detection model loaded:",this.detectionSession.inputNames,this.detectionSession.outputNames);const n=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${n}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release(),this.recognitionSession=await pe.create(ve+this.modelConfig.recognition,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Recognition model loaded:",this.recognitionSession.inputNames,this.recognitionSession.outputNames),this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR models loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(ve+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.blobToImage(e),n=await this.detectText(t);return await this.recognizeText(t,n)}async detectText(e){if(!this.detectionSession)throw new Error("Detection model not loaded");const{resizedImage:t,ratio:n}=await this.resizeForDetection(e),o=await this.preprocessForDetection(t),s={[this.detectionSession.inputNames[0]]:o},d=(await this.detectionSession.run(s))[this.detectionSession.outputNames[0]];return await this.postprocessDetection(d,t.width,t.height,n)}async resizeForDetection(e){const t=U.det_limit_side_len;let n=e.width,o=e.height,s=1;Math.max(o,n)>t&&(s=t/Math.max(o,n));const r=Math.ceil(n*s),d=Math.ceil(o*s),a=Math.ceil(r/32)*32,l=Math.ceil(d/32)*32;this.canvas.width=a,this.canvas.height=l,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,a,l),this.ctx.drawImage(e,0,0,r,d);const f=new Image;return new Promise(c=>{this.canvas.toBlob(p=>{const h=URL.createObjectURL(p);f.onload=()=>{URL.revokeObjectURL(h),c({resizedImage:f,ratio:s})},f.src=h})})}async preprocessForDetection(e){this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data,o=e.width*e.height,s=new Float32Array(3*o);for(let r=0;r<o;r++){const d=r*4;s[r]=(n[d]/255-U.mean[0])/U.std[0],s[o+r]=(n[d+1]/255-U.mean[1])/U.std[1],s[2*o+r]=(n[d+2]/255-U.mean[2])/U.std[2]}return new ge("float32",s,[1,3,e.height,e.width])}async postprocessDetection(e,t,n,o){const[s,r,d,a]=e.dims,l=e.data,f=new Float32Array(d*a);for(let x=0;x<d*a;x++)f[x]=1/(1+Math.exp(-l[x]));const c=new Uint8Array(d*a),p=U.det_db_thresh;for(let x=0;x<d*a;x++)c[x]=f[x]>p?1:0;const h=[],y=new Set;for(let x=0;x<d;x++)for(let E=0;E<a;E++){const I=x*a+E;if(c[I]===1&&!y.has(I)&&f[I]>U.det_db_box_thresh){const b=this.expandBox(c,f,E,x,a,d,y);if(b){const D={points:b.points.map($=>[Math.round($[0]*t/a/o),Math.round($[1]*n/d/o)]),score:b.score};h.push(D)}}}return this.sortBoxes(h)}expandBox(e,t,n,o,s,r,d){let a=n,l=n,f=o,c=o,p=0,h=0;const y=[[n,o]];for(d.add(o*s+n);y.length>0;){const[I,b]=y.shift();p+=t[b*s+I],h++;for(let D=-1;D<=1;D++)for(let $=-1;$<=1;$++){const R=I+$,z=b+D,T=z*s+R;R>=0&&R<s&&z>=0&&z<r&&e[T]===1&&!d.has(T)&&(d.add(T),y.push([R,z]),a=Math.min(a,R),l=Math.max(l,R),f=Math.min(f,z),c=Math.max(c,z))}}if(l-a<3||c-f<3)return null;const x=U.det_db_unclip_ratio,E=Math.max(l-a,c-f)*(x-1)/2;return a=Math.max(0,a-E),l=Math.min(s-1,l+E),f=Math.max(0,f-E),c=Math.min(r-1,c+E),{points:[[a,f],[l,f],[l,c],[a,c]],score:p/h}}sortBoxes(e){return e.sort((t,n)=>{const o=Math.min(...t.points.map(r=>r[1])),s=Math.min(...n.points.map(r=>r[1]));if(Math.abs(o-s)<10){const r=Math.min(...t.points.map(a=>a[0])),d=Math.min(...n.points.map(a=>a[0]));return r-d}return o-s})}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[];for(const o of t){const s=await this.cropToBox(e,o),r=await this.preprocessForRecognition(s),d={[this.recognitionSession.inputNames[0]]:r},a=await this.recognitionSession.run(d),l=await this.decodeRecognition(a[this.recognitionSession.outputNames[0]]);l.score>=U.drop_score&&n.push({text:l.text,confidence:l.score,box:o.points})}return n}async cropToBox(e,t){const n=t.points,o=Math.min(...n.map(c=>c[0])),s=Math.max(...n.map(c=>c[0])),r=Math.min(...n.map(c=>c[1])),d=Math.max(...n.map(c=>c[1])),a=s-o,l=d-r;this.canvas.width=a,this.canvas.height=l,this.ctx.drawImage(e,o,r,a,l,0,0,a,l);const f=new Image;return new Promise(c=>{this.canvas.toBlob(p=>{const h=URL.createObjectURL(p);f.onload=()=>{URL.revokeObjectURL(h),c(f)},f.src=h})})}async preprocessForRecognition(e){const n=e.width/e.height;let o=Math.round(48*n);o=Math.max(o,48),this.canvas.width=o,this.canvas.height=48,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,o,48),this.ctx.drawImage(e,0,0,o,48);const r=this.ctx.getImageData(0,0,o,48).data,d=o*48,a=new Float32Array(3*d);for(let l=0;l<d;l++){const f=l*4;a[l]=(r[f]/255-.5)/.5,a[d+l]=(r[f+1]/255-.5)/.5,a[2*d+l]=(r[f+2]/255-.5)/.5}return new ge("float32",a,[1,3,48,o])}async decodeRecognition(e){const[t,n,o]=e.dims,s=e.data,r=[],d=[];for(let c=0;c<n;c++){let p=0,h=s[c*o];for(let y=1;y<o;y++){const x=s[c*o+y];x>h&&(h=x,p=y)}r.push(p),d.push(h)}const a=[],l=[];let f=-1;for(let c=0;c<r.length;c++){const p=r[c];p!==0&&p!==f&&p<this.charDict.length&&(a.push(this.charDict[p]),l.push(d[c])),f=p}return{text:a.join(""),score:l.length>0?l.reduce((c,p)=>c+p)/l.length:0}}async processPDF(e){const t=await e.arrayBuffer(),n=await J.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const d=await n.getPage(r),a=d.getViewport({scale:2}),l=document.createElement("canvas"),f=l.getContext("2d");l.width=a.width,l.height=a.height,await d.render({canvasContext:f,viewport:a}).promise;const c=await new Promise(x=>l.toBlob(x,"image/png")),p=await this.blobToImage(c),h=await this.detectText(p),y=await this.recognizeText(p,h);s.push({page:r,results:y})}return s}async blobToImage(e){return new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=URL.createObjectURL(e)})}}const ie=new Ge;var We={exports:{}};(function(i){var e=function(t){var n=Object.prototype,o=n.hasOwnProperty,s=Object.defineProperty||function(m,u,w){m[u]=w.value},r,d=typeof Symbol=="function"?Symbol:{},a=d.iterator||"@@iterator",l=d.asyncIterator||"@@asyncIterator",f=d.toStringTag||"@@toStringTag";function c(m,u,w){return Object.defineProperty(m,u,{value:w,enumerable:!0,configurable:!0,writable:!0}),m[u]}try{c({},"")}catch{c=function(u,w,L){return u[w]=L}}function p(m,u,w,L){var g=u&&u.prototype instanceof D?u:D,v=Object.create(g.prototype),_=new ce(L||[]);return s(v,"_invoke",{value:H(m,w,_)}),v}t.wrap=p;function h(m,u,w){try{return{type:"normal",arg:m.call(u,w)}}catch(L){return{type:"throw",arg:L}}}var y="suspendedStart",x="suspendedYield",E="executing",I="completed",b={};function D(){}function $(){}function R(){}var z={};c(z,a,function(){return this});var T=Object.getPrototypeOf,A=T&&T(T(de([])));A&&A!==n&&o.call(A,a)&&(z=A);var F=R.prototype=D.prototype=Object.create(z);$.prototype=R,s(F,"constructor",{value:R,configurable:!0}),s(R,"constructor",{value:$,configurable:!0}),$.displayName=c(R,f,"GeneratorFunction");function oe(m){["next","throw","return"].forEach(function(u){c(m,u,function(w){return this._invoke(u,w)})})}t.isGeneratorFunction=function(m){var u=typeof m=="function"&&m.constructor;return u?u===$||(u.displayName||u.name)==="GeneratorFunction":!1},t.mark=function(m){return Object.setPrototypeOf?Object.setPrototypeOf(m,R):(m.__proto__=R,c(m,f,"GeneratorFunction")),m.prototype=Object.create(F),m},t.awrap=function(m){return{__await:m}};function N(m,u){function w(v,_,S,M){var O=h(m[v],m,_);if(O.type==="throw")M(O.arg);else{var V=O.arg,q=V.value;return q&&typeof q=="object"&&o.call(q,"__await")?u.resolve(q.__await).then(function(X){w("next",X,S,M)},function(X){w("throw",X,S,M)}):u.resolve(q).then(function(X){V.value=X,S(V)},function(X){return w("throw",X,S,M)})}}var L;function g(v,_){function S(){return new u(function(M,O){w(v,_,M,O)})}return L=L?L.then(S,S):S()}s(this,"_invoke",{value:g})}oe(N.prototype),c(N.prototype,l,function(){return this}),t.AsyncIterator=N,t.async=function(m,u,w,L,g){g===void 0&&(g=Promise);var v=new N(p(m,u,w,L),g);return t.isGeneratorFunction(u)?v:v.next().then(function(_){return _.done?_.value:v.next()})};function H(m,u,w){var L=y;return function(v,_){if(L===E)throw new Error("Generator is already running");if(L===I){if(v==="throw")throw _;return he()}for(w.method=v,w.arg=_;;){var S=w.delegate;if(S){var M=G(S,w);if(M){if(M===b)continue;return M}}if(w.method==="next")w.sent=w._sent=w.arg;else if(w.method==="throw"){if(L===y)throw L=I,w.arg;w.dispatchException(w.arg)}else w.method==="return"&&w.abrupt("return",w.arg);L=E;var O=h(m,u,w);if(O.type==="normal"){if(L=w.done?I:x,O.arg===b)continue;return{value:O.arg,done:w.done}}else O.type==="throw"&&(L=I,w.method="throw",w.arg=O.arg)}}}function G(m,u){var w=u.method,L=m.iterator[w];if(L===r)return u.delegate=null,w==="throw"&&m.iterator.return&&(u.method="return",u.arg=r,G(m,u),u.method==="throw")||w!=="return"&&(u.method="throw",u.arg=new TypeError("The iterator does not provide a '"+w+"' method")),b;var g=h(L,m.iterator,u.arg);if(g.type==="throw")return u.method="throw",u.arg=g.arg,u.delegate=null,b;var v=g.arg;if(!v)return u.method="throw",u.arg=new TypeError("iterator result is not an object"),u.delegate=null,b;if(v.done)u[m.resultName]=v.value,u.next=m.nextLoc,u.method!=="return"&&(u.method="next",u.arg=r);else return v;return u.delegate=null,b}oe(F),c(F,f,"Generator"),c(F,a,function(){return this}),c(F,"toString",function(){return"[object Generator]"});function ae(m){var u={tryLoc:m[0]};1 in m&&(u.catchLoc=m[1]),2 in m&&(u.finallyLoc=m[2],u.afterLoc=m[3]),this.tryEntries.push(u)}function W(m){var u=m.completion||{};u.type="normal",delete u.arg,m.completion=u}function ce(m){this.tryEntries=[{tryLoc:"root"}],m.forEach(ae,this),this.reset(!0)}t.keys=function(m){var u=Object(m),w=[];for(var L in u)w.push(L);return w.reverse(),function g(){for(;w.length;){var v=w.pop();if(v in u)return g.value=v,g.done=!1,g}return g.done=!0,g}};function de(m){if(m){var u=m[a];if(u)return u.call(m);if(typeof m.next=="function")return m;if(!isNaN(m.length)){var w=-1,L=function g(){for(;++w<m.length;)if(o.call(m,w))return g.value=m[w],g.done=!1,g;return g.value=r,g.done=!0,g};return L.next=L}}return{next:he}}t.values=de;function he(){return{value:r,done:!0}}return ce.prototype={constructor:ce,reset:function(m){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(W),!m)for(var u in this)u.charAt(0)==="t"&&o.call(this,u)&&!isNaN(+u.slice(1))&&(this[u]=r)},stop:function(){this.done=!0;var m=this.tryEntries[0],u=m.completion;if(u.type==="throw")throw u.arg;return this.rval},dispatchException:function(m){if(this.done)throw m;var u=this;function w(M,O){return v.type="throw",v.arg=m,u.next=M,O&&(u.method="next",u.arg=r),!!O}for(var L=this.tryEntries.length-1;L>=0;--L){var g=this.tryEntries[L],v=g.completion;if(g.tryLoc==="root")return w("end");if(g.tryLoc<=this.prev){var _=o.call(g,"catchLoc"),S=o.call(g,"finallyLoc");if(_&&S){if(this.prev<g.catchLoc)return w(g.catchLoc,!0);if(this.prev<g.finallyLoc)return w(g.finallyLoc)}else if(_){if(this.prev<g.catchLoc)return w(g.catchLoc,!0)}else if(S){if(this.prev<g.finallyLoc)return w(g.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(m,u){for(var w=this.tryEntries.length-1;w>=0;--w){var L=this.tryEntries[w];if(L.tryLoc<=this.prev&&o.call(L,"finallyLoc")&&this.prev<L.finallyLoc){var g=L;break}}g&&(m==="break"||m==="continue")&&g.tryLoc<=u&&u<=g.finallyLoc&&(g=null);var v=g?g.completion:{};return v.type=m,v.arg=u,g?(this.method="next",this.next=g.finallyLoc,b):this.complete(v)},complete:function(m,u){if(m.type==="throw")throw m.arg;return m.type==="break"||m.type==="continue"?this.next=m.arg:m.type==="return"?(this.rval=this.arg=m.arg,this.method="return",this.next="end"):m.type==="normal"&&u&&(this.next=u),b},finish:function(m){for(var u=this.tryEntries.length-1;u>=0;--u){var w=this.tryEntries[u];if(w.finallyLoc===m)return this.complete(w.completion,w.afterLoc),W(w),b}},catch:function(m){for(var u=this.tryEntries.length-1;u>=0;--u){var w=this.tryEntries[u];if(w.tryLoc===m){var L=w.completion;if(L.type==="throw"){var g=L.arg;W(w)}return g}}throw new Error("illegal catch attempt")},delegateYield:function(m,u,w){return this.delegate={iterator:de(m),resultName:u,nextLoc:w},this.method==="next"&&(this.arg=r),b}},t}(i.exports);try{regeneratorRuntime=e}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}})(We);var Re=(i,e)=>`${i}-${e}-${Math.random().toString(16).slice(3,8)}`;const qe=Re;let Ie=0;var De=({id:i,action:e,payload:t={}})=>{let n=i;return typeof n>"u"&&(n=qe("Job",Ie),Ie+=1),{id:n,action:e,payload:t}},re={};let Se=!1;re.logging=Se;re.setLogging=i=>{Se=i};re.log=(...i)=>Se?console.log.apply(void 0,i):null;const Xe=De,{log:ue}=re,Ke=Re;let Oe=0;var Ve=()=>{const i=Ke("Scheduler",Oe),e={},t={};let n=[];Oe+=1;const o=()=>n.length,s=()=>Object.keys(e).length,r=()=>{if(n.length!==0){const c=Object.keys(e);for(let p=0;p<c.length;p+=1)if(typeof t[c[p]]>"u"){n[0](e[c[p]]);break}}},d=(c,p)=>new Promise((h,y)=>{const x=Xe({action:c,payload:p});n.push(async E=>{n.shift(),t[E.id]=x;try{h(await E[c].apply(void 0,[...p,x.id]))}catch(I){y(I)}finally{delete t[E.id],r()}}),ue(`[${i}]: Add ${x.id} to JobQueue`),ue(`[${i}]: JobQueue length=${n.length}`),r()});return{addWorker:c=>(e[c.id]=c,ue(`[${i}]: Add ${c.id}`),ue(`[${i}]: Number of workers=${s()}`),r(),c.id),addJob:async(c,...p)=>{if(s()===0)throw Error(`[${i}]: You need to have at least one worker before adding jobs`);return d(c,p)},terminate:async()=>{Object.keys(e).forEach(async c=>{await e[c].terminate()}),n=[]},getQueueLen:o,getNumWorkers:s}};function Je(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var Ze=Je;const Qe=Ze;var et=i=>{const e={};return typeof WorkerGlobalScope<"u"?e.type="webworker":Qe()?e.type="electron":typeof document=="object"?e.type="browser":typeof process=="object"&&typeof ke=="function"&&(e.type="node"),typeof i>"u"?e:e[i]};const tt=et("type")==="browser",nt=tt?i=>new URL(i,window.location.href).href:i=>i;var ot=i=>{const e={...i};return["corePath","workerPath","langPath"].forEach(t=>{i[t]&&(e[t]=nt(e[t]))}),e},it=i=>{const e=[],t=[],n=[],o=[],s=[];return i.blocks&&i.blocks.forEach(r=>{r.paragraphs.forEach(d=>{d.lines.forEach(a=>{a.words.forEach(l=>{l.symbols.forEach(f=>{s.push({...f,page:i,block:r,paragraph:d,line:a,word:l})}),o.push({...l,page:i,block:r,paragraph:d,line:a})}),n.push({...a,page:i,block:r,paragraph:d})}),t.push({...d,page:i,block:r})}),e.push({...r,page:i})}),{...i,blocks:e,paragraphs:t,lines:n,words:o,symbols:s}},Be={TESSERACT_ONLY:0,LSTM_ONLY:1,TESSERACT_LSTM_COMBINED:2,DEFAULT:3};const st="5.1.1",rt={version:st};var at={workerBlobURL:!0,logger:()=>{}};const ct=rt.version,dt=at;var lt={...dt,workerPath:`https://cdn.jsdelivr.net/npm/tesseract.js@v${ct}/dist/worker.min.js`},ht=({workerPath:i,workerBlobURL:e})=>{let t;if(Blob&&URL&&e){const n=new Blob([`importScripts("${i}");`],{type:"application/javascript"});t=new Worker(URL.createObjectURL(n))}else t=new Worker(i);return t},ut=i=>{i.terminate()},pt=(i,e)=>{i.onmessage=({data:t})=>{e(t)}},gt=async(i,e)=>{i.postMessage(e)};const ye=i=>new Promise((e,t)=>{const n=new FileReader;n.onload=()=>{e(n.result)},n.onerror=({target:{error:{code:o}}})=>{t(Error(`File could not be read! Code=${o}`))},n.readAsArrayBuffer(i)}),Ee=async i=>{let e=i;if(typeof i>"u")return"undefined";if(typeof i=="string")/data:image\/([a-zA-Z]*);base64,([^"]*)/.test(i)?e=atob(i.split(",")[1]).split("").map(t=>t.charCodeAt(0)):e=await(await fetch(i)).arrayBuffer();else if(typeof HTMLElement<"u"&&i instanceof HTMLElement)i.tagName==="IMG"&&(e=await Ee(i.src)),i.tagName==="VIDEO"&&(e=await Ee(i.poster)),i.tagName==="CANVAS"&&await new Promise(t=>{i.toBlob(async n=>{e=await ye(n),t()})});else if(typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas){const t=await i.convertToBlob();e=await ye(t)}else(i instanceof File||i instanceof Blob)&&(e=await ye(i));return new Uint8Array(e)};var mt=Ee;const ft=lt,wt=ht,vt=ut,yt=pt,xt=gt,Lt=mt;var bt={defaultOptions:ft,spawnWorker:wt,terminateWorker:vt,onMessage:yt,send:xt,loadImage:Lt};const Et=ot,_t=it,k=De,{log:Pe}=re,Rt=Re,Z=Be,{defaultOptions:St,spawnWorker:Mt,terminateWorker:It,onMessage:Ot,loadImage:$e,send:Pt}=bt;let Te=0;var ze=async(i="eng",e=Z.LSTM_ONLY,t={},n={})=>{const o=Rt("Worker",Te),{logger:s,errorHandler:r,...d}=Et({...St,...t}),a={},l={},f=typeof i=="string"?i.split("+"):i;let c=e,p=n;const h=[Z.DEFAULT,Z.LSTM_ONLY].includes(e)&&!d.legacyCore;let y,x;const E=new Promise((g,v)=>{x=g,y=v}),I=g=>{y(g.message)};let b=Mt(d);b.onerror=I,Te+=1;const D=(g,v)=>{a[g]=v},$=(g,v)=>{l[g]=v},R=({id:g,action:v,payload:_})=>new Promise((S,M)=>{Pe(`[${o}]: Start ${g}, action=${v}`);const O=`${v}-${g}`;D(O,S),$(O,M),Pt(b,{workerId:o,jobId:g,action:v,payload:_})}),z=()=>console.warn("`load` is depreciated and should be removed from code (workers now come pre-loaded)"),T=g=>R(k({id:g,action:"load",payload:{options:{lstmOnly:h,corePath:d.corePath,logging:d.logging}}})),A=(g,v,_)=>R(k({id:_,action:"FS",payload:{method:"writeFile",args:[g,v]}})),F=(g,v)=>R(k({id:v,action:"FS",payload:{method:"readFile",args:[g,{encoding:"utf8"}]}})),oe=(g,v)=>R(k({id:v,action:"FS",payload:{method:"unlink",args:[g]}})),N=(g,v,_)=>R(k({id:_,action:"FS",payload:{method:g,args:v}})),H=()=>console.warn("`loadLanguage` is depreciated and should be removed from code (workers now come with language pre-loaded)"),G=(g,v)=>R(k({id:v,action:"loadLanguage",payload:{langs:g,options:{langPath:d.langPath,dataPath:d.dataPath,cachePath:d.cachePath,cacheMethod:d.cacheMethod,gzip:d.gzip,lstmOnly:[Z.DEFAULT,Z.LSTM_ONLY].includes(c)&&!d.legacyLang}}})),ae=()=>console.warn("`initialize` is depreciated and should be removed from code (workers now come pre-initialized)"),W=(g,v,_,S)=>R(k({id:S,action:"initialize",payload:{langs:g,oem:v,config:_}})),ce=(g="eng",v,_,S)=>{if(h&&[Z.TESSERACT_ONLY,Z.TESSERACT_LSTM_COMBINED].includes(v))throw Error("Legacy model requested but code missing.");const M=v||c;c=M;const O=_||p;p=O;const q=(typeof g=="string"?g.split("+"):g).filter(X=>!f.includes(X));return f.push(...q),q.length>0?G(q,S).then(()=>W(g,M,O,S)):W(g,M,O,S)},de=(g={},v)=>R(k({id:v,action:"setParameters",payload:{params:g}})),he=async(g,v={},_={blocks:!0,text:!0,hocr:!0,tsv:!0},S)=>R(k({id:S,action:"recognize",payload:{image:await $e(g),options:v,output:_}})),m=(g="Tesseract OCR Result",v=!1,_)=>(console.log("`getPDF` function is depreciated. `recognize` option `savePDF` should be used instead."),R(k({id:_,action:"getPDF",payload:{title:g,textonly:v}}))),u=async(g,v)=>{if(h)throw Error("`worker.detect` requires Legacy model, which was not loaded.");return R(k({id:v,action:"detect",payload:{image:await $e(g)}}))},w=async()=>(b!==null&&(It(b),b=null),Promise.resolve());Ot(b,({workerId:g,jobId:v,status:_,action:S,data:M})=>{const O=`${S}-${v}`;if(_==="resolve"){Pe(`[${g}]: Complete ${v}`);let V=M;S==="recognize"?V=_t(M):S==="getPDF"&&(V=Array.from({...M,length:Object.keys(M).length})),a[O]({jobId:v,data:V})}else if(_==="reject")if(l[O](M),S==="load"&&y(M),r)r(M);else throw Error(M);else _==="progress"&&s({...M,userJobId:v})});const L={id:o,worker:b,setResolve:D,setReject:$,load:z,writeText:A,readText:F,removeFile:oe,FS:N,loadLanguage:H,initialize:ae,reinitialize:ce,setParameters:de,recognize:he,getPDF:m,detect:u,terminate:w};return T().then(()=>G(i)).then(()=>W(i,e,n)).then(()=>x(L)).catch(()=>{}),E};const Ae=ze,$t=async(i,e,t)=>{const n=await Ae(e,1,t);return n.recognize(i).finally(async()=>{await n.terminate()})},Tt=async(i,e)=>{const t=await Ae("osd",0,e);return t.detect(i).finally(async()=>{await t.terminate()})};var Ct={recognize:$t,detect:Tt},Dt={AFR:"afr",AMH:"amh",ARA:"ara",ASM:"asm",AZE:"aze",AZE_CYRL:"aze_cyrl",BEL:"bel",BEN:"ben",BOD:"bod",BOS:"bos",BUL:"bul",CAT:"cat",CEB:"ceb",CES:"ces",CHI_SIM:"chi_sim",CHI_TRA:"chi_tra",CHR:"chr",CYM:"cym",DAN:"dan",DEU:"deu",DZO:"dzo",ELL:"ell",ENG:"eng",ENM:"enm",EPO:"epo",EST:"est",EUS:"eus",FAS:"fas",FIN:"fin",FRA:"fra",FRK:"frk",FRM:"frm",GLE:"gle",GLG:"glg",GRC:"grc",GUJ:"guj",HAT:"hat",HEB:"heb",HIN:"hin",HRV:"hrv",HUN:"hun",IKU:"iku",IND:"ind",ISL:"isl",ITA:"ita",ITA_OLD:"ita_old",JAV:"jav",JPN:"jpn",KAN:"kan",KAT:"kat",KAT_OLD:"kat_old",KAZ:"kaz",KHM:"khm",KIR:"kir",KOR:"kor",KUR:"kur",LAO:"lao",LAT:"lat",LAV:"lav",LIT:"lit",MAL:"mal",MAR:"mar",MKD:"mkd",MLT:"mlt",MSA:"msa",MYA:"mya",NEP:"nep",NLD:"nld",NOR:"nor",ORI:"ori",PAN:"pan",POL:"pol",POR:"por",PUS:"pus",RON:"ron",RUS:"rus",SAN:"san",SIN:"sin",SLK:"slk",SLV:"slv",SPA:"spa",SPA_OLD:"spa_old",SQI:"sqi",SRP:"srp",SRP_LATN:"srp_latn",SWA:"swa",SWE:"swe",SYR:"syr",TAM:"tam",TEL:"tel",TGK:"tgk",TGL:"tgl",THA:"tha",TIR:"tir",TUR:"tur",UIG:"uig",UKR:"ukr",URD:"urd",UZB:"uzb",UZB_CYRL:"uzb_cyrl",VIE:"vie",YID:"yid"},Bt={OSD_ONLY:"0",AUTO_OSD:"1",AUTO_ONLY:"2",AUTO:"3",SINGLE_COLUMN:"4",SINGLE_BLOCK_VERT_TEXT:"5",SINGLE_BLOCK:"6",SINGLE_LINE:"7",SINGLE_WORD:"8",CIRCLE_WORD:"9",SINGLE_CHAR:"10",SPARSE_TEXT:"11",SPARSE_TEXT_OSD:"12",RAW_LINE:"13"};const zt=Ve,At=ze,Ft=Ct,Nt=Dt,jt=Be,Ut=Bt,{setLogging:kt}=re;var Yt={languages:Nt,OEM:jt,PSM:Ut,createScheduler:zt,createWorker:At,setLogging:kt,...Ft};const xe=Ye(Yt);J.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";class Ht{constructor(){this.initialized=!1,this.worker=null}async initialize(e){if(!this.initialized)try{e==null||e({status:"loading",message:"Loading Tesseract OCR engine...",progress:10}),this.worker=await xe.createWorker("eng",1,{logger:t=>{t.status==="loading tesseract core"?e==null||e({status:"loading",message:"Loading OCR core...",progress:30}):t.status==="loading language traineddata"?e==null||e({status:"loading",message:"Loading English language model...",progress:60}):t.status==="initialized tesseract"&&(e==null||e({status:"loading",message:"Initializing OCR engine...",progress:90}))},errorHandler:t=>{console.error("Tesseract error:",t)}}),await this.worker.setParameters({tessedit_ocr_engine_mode:xe.OEM.LSTM_ONLY,preserve_interword_spaces:"1",tessedit_pageseg_mode:xe.PSM.AUTO}),this.initialized=!0,e==null||e({status:"ready",message:"Tesseract OCR engine loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize Tesseract:",t),t}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.worker.recognize(e);return this.formatResults(t)}formatResults(e){const t=[];for(const o of e.data.words)o.confidence>30&&t.push({box:[[o.bbox.x0,o.bbox.y0],[o.bbox.x1,o.bbox.y0],[o.bbox.x1,o.bbox.y1],[o.bbox.x0,o.bbox.y1]],text:o.text,confidence:o.confidence/100});return this.groupWordsIntoLines(t)}groupWordsIntoLines(e){if(e.length===0)return[];e.sort((o,s)=>o.box[0][1]-s.box[0][1]);const t=[];let n={words:[e[0]],minY:e[0].box[0][1],maxY:e[0].box[2][1]};for(let o=1;o<e.length;o++){const s=e[o],r=s.box[0][1];r<=n.maxY&&r>=n.minY-5?(n.words.push(s),n.minY=Math.min(n.minY,r),n.maxY=Math.max(n.maxY,s.box[2][1])):(t.push(this.mergeLine(n)),n={words:[s],minY:r,maxY:s.box[2][1]})}return n.words.length>0&&t.push(this.mergeLine(n)),t}mergeLine(e){e.words.sort((a,l)=>a.box[0][0]-l.box[0][0]);const t=Math.min(...e.words.map(a=>a.box[0][0])),n=Math.max(...e.words.map(a=>a.box[1][0])),o=Math.min(...e.words.map(a=>a.box[0][1])),s=Math.max(...e.words.map(a=>a.box[2][1])),r=e.words.map(a=>a.text).join(" "),d=e.words.reduce((a,l)=>a+l.confidence,0)/e.words.length;return{box:[[t,o],[n,o],[n,s],[t,s]],text:r,confidence:d}}async processPDF(e){const t=await e.arrayBuffer(),n=await J.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const d=await n.getPage(r),a=d.getViewport({scale:2}),l=document.createElement("canvas"),f=l.getContext("2d");l.width=a.width,l.height=a.height,await d.render({canvasContext:f,viewport:a}).promise;const c=await new Promise(y=>l.toBlob(y,"image/png")),p=await this.worker.recognize(c),h=this.formatResults(p);s.push({page:r,results:h})}return s}async cleanup(){this.worker&&(await this.worker.terminate(),this.worker=null,this.initialized=!1)}}const Me=new Ht;J.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";let te=null,B="tesseract",j="improved",ne=Me;const _e=document.getElementById("fileInput"),Q=document.getElementById("uploadArea"),Fe=document.getElementById("previewSection"),Y=document.getElementById("previewImage"),Gt=document.getElementById("processBtn"),me=document.getElementById("resultsSection"),Le=document.getElementById("loadingIndicator"),se=document.getElementById("ocrResults"),Wt=document.getElementById("copyBtn"),qt=document.getElementById("downloadBtn"),Xt=document.getElementById("resetBtn");async function Kt(){console.log("Initializing OCR engines..."),C("Loading OCR engines...","info");try{await Promise.all([le.initialize(i=>{B==="paddle"&&j==="improved"&&C(i.message,i.status==="ready"?"success":"info");const e=document.querySelector("#loadingIndicator p");e&&i.progress!==void 0&&B==="paddle"&&j==="improved"&&(e.textContent=`${i.message} (${i.progress}%)`)}),ie.initialize(i=>{B==="paddle"&&j==="standard"&&C(i.message,i.status==="ready"?"success":"info")}),Me.initialize(i=>{B==="tesseract"&&C(i.message,i.status==="ready"?"success":"info")})]),console.log("OCR engines loaded successfully!"),C("Ready to process images","success"),Vt()}catch(i){console.error("Failed to initialize OCR engines:",i),K("Failed to load OCR engines. Please check your internet connection and refresh the page.")}}function Vt(){Q.addEventListener("click",()=>_e.click()),_e.addEventListener("change",Qt),Q.addEventListener("dragover",en),Q.addEventListener("dragleave",tn),Q.addEventListener("drop",nn),Gt.addEventListener("click",on),Wt.addEventListener("click",rn),qt.addEventListener("click",an),Xt.addEventListener("click",cn),document.querySelectorAll('input[name="ocrEngine"]').forEach(i=>{i.addEventListener("change",Jt)}),document.querySelectorAll('input[name="preprocessing"]').forEach(i=>{i.addEventListener("change",Zt)}),document.getElementById("detectionModel").addEventListener("change",be),document.getElementById("recognitionModel").addEventListener("change",be),document.getElementById("dictionary").addEventListener("change",be)}async function Jt(i){B=i.target.value,console.log("Engine changed to:",B),B==="paddle"?(ne=j==="improved"?le:ie,console.log("Using PaddleOCR engine:",j)):(ne=Me,console.log("Using Tesseract engine"));const e=document.getElementById("paddleOptions");e.style.display=B==="paddle"?"block":"none",C(`Switched to ${B==="paddle"?"PaddleOCR":"Tesseract.js"}`,"info")}async function Zt(i){if(j=i.target.value,B==="paddle"){if(ne=j==="improved"?le:ie,j==="standard"){const e=document.getElementById("detectionModel").value,t=document.getElementById("recognitionModel").value,n=document.getElementById("dictionary").value;ie.setModelConfig({detection:e,recognition:t,dictionary:n}),C("Loading standard preprocessing models...","info");try{await ie.initialize(o=>{C(o.message,o.status==="ready"?"success":"info")}),C("Standard preprocessing ready!","success")}catch(o){console.error("Failed to initialize standard preprocessing:",o),K("Failed to load standard preprocessing models"),j="improved",ne=le,document.getElementById("preprocessImproved").checked=!0}}C(`Switched to ${j==="improved"?"Improved (PPU)":"Standard"} preprocessing`,"info")}}async function be(){if(B!=="paddle")return;const i=document.getElementById("detectionModel").value,e=document.getElementById("recognitionModel").value,t=document.getElementById("dictionary").value;j==="improved"?le.setModelConfig({detection:i,recognition:e,dictionary:t}):ie.setModelConfig({detection:i,recognition:e,dictionary:t}),C("Loading new models...","info");try{await ne.initialize(n=>{C(n.message,n.status==="ready"?"success":"info")}),C("Models updated successfully!","success")}catch(n){console.error("Failed to load new models:",n),K("Failed to load new models. Please try again.")}}function Qt(i){const e=i.target.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?Ne(e):K("Please select a valid image or PDF file")}function en(i){i.preventDefault(),Q.classList.add("dragover")}function tn(i){i.preventDefault(),Q.classList.remove("dragover")}function nn(i){i.preventDefault(),Q.classList.remove("dragover");const e=i.dataTransfer.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?Ne(e):K("Please drop a valid image or PDF file")}async function Ne(i){if(te){const e=Y.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),te=null}if(se.innerHTML="",me.style.display="none",te=i,Fe.style.display="block",me.style.display="none",i.type==="application/pdf"){Y.style.display="none";const e=Y.parentElement;e.innerHTML="";const t=document.createElement("div");t.className="pdf-preview",t.innerHTML=`
            <div class="pdf-header">
                <h3>${i.name}</h3>
                <p class="pdf-info">Loading PDF preview...</p>
            </div>
            <div class="pdf-pages" id="pdfPages"></div>
        `,e.appendChild(t);try{const n=await i.arrayBuffer(),o=await J.getDocument({data:n}).promise,s=o.numPages,r=t.querySelector(".pdf-info");r.textContent=`${s} page${s>1?"s":""}`;const d=document.getElementById("pdfPages"),a=Math.min(s,3);for(let l=1;l<=a;l++){const f=await o.getPage(l),c=f.getViewport({scale:.5}),p=document.createElement("div");p.className="pdf-page-preview";const h=document.createElement("canvas"),y=h.getContext("2d");h.height=c.height,h.width=c.width;const x={canvasContext:y,viewport:c};await f.render(x).promise,p.innerHTML=`<p>Page ${l}</p>`,p.appendChild(h),d.appendChild(p)}s>3&&(d.innerHTML+=`<p class="more-pages">... and ${s-3} more pages</p>`)}catch(n){console.error("Error rendering PDF preview:",n),t.querySelector(".pdf-info").textContent="Error loading PDF preview"}}else{const e=document.querySelector(".pdf-placeholder");e&&e.remove(),Y.style.display="block";const t=URL.createObjectURL(i);Y.src=t,Y.onload=()=>{C('Image loaded. Click "Extract Text" to process.',"success")},Y.onerror=()=>{URL.revokeObjectURL(t),K("Failed to load image")}}}async function on(){if(!te){K("Please upload an image first");return}me.style.display="block",Le.style.display="flex",se.innerHTML="";const i=document.querySelector("#loadingIndicator p");let e=B==="paddle"?"PaddleOCR":"Tesseract.js";B==="paddle"&&(e+=` (${j==="improved"?"Improved PPU":"Standard"})`),i&&(i.textContent=`Processing image with ${e}...`);try{console.log(`Processing image with ${e}...`),console.log("Current engine variable:",B),console.log("Current OCR engine object:",ne),C("Detecting and recognizing text...","info");const t=performance.now(),n=await ne.process(te),o=performance.now()-t;console.log(`Processing completed in ${o.toFixed(2)}ms`),console.log("OCR Results:",n),Le.style.display="none",n&&n.length>0?(Ce(n,o,e),C(`Text extraction complete! Found ${n.length} text regions.`,"success")):(Ce([],o,e),C("No text found in the image","warning"))}catch(t){console.error("OCR processing error:",t),Le.style.display="none",K("Failed to process image: "+t.message)}}function Ce(i,e,t="PaddleOCR"){var s;const n=Array.isArray(i)&&((s=i[0])==null?void 0:s.page)!==void 0,o=B==="paddle"&&i.length>0&&i[0]&&i[0].box;if(console.log("Display check - currentEngine:",B,"isPaddleWithBoxes:",o,"results:",i),n){let r="",d=0,a="";i.forEach(l=>{const f=l.results.map(c=>c.text).join(`
`);r+=`
--- Page ${l.page} ---
${f}
`,d+=l.results.length,a+=`
                <div class="page-results">
                    <h4>Page ${l.page}</h4>
                    <ul class="detection-list">
                        ${l.results.map((c,p)=>`
                            <li data-index="${p}">
                                <span class="detection-index">${p+1}.</span>
                                <span class="detection-text">${ee(c.text)}</span>
                                <span class="detection-confidence">${(c.confidence*100).toFixed(1)}%</span>
                            </li>
                        `).join("")}
                    </ul>
                </div>
            `}),se.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Pages Processed:</strong> ${i.length}</p>
                <p><strong>Total Text Regions:</strong> ${d}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${ee(r||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details by Page:</h3>
                ${a}
            </div>
        `}else if(o)sn(i,e,t);else{const r=i.map(d=>d.text).join(`
`);se.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Text Regions Found:</strong> ${i.length}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${ee(r||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details:</h3>
                <ul class="detection-list">
                    ${i.map((d,a)=>`
                        <li>
                            <span class="detection-index">${a+1}.</span>
                            <span class="detection-text">${ee(d.text)}</span>
                            <span class="detection-confidence">${(d.confidence*100).toFixed(1)}%</span>
                        </li>
                    `).join("")}
                </ul>
            </div>
        `}}function sn(i,e,t){const n=i.map(s=>s.text).join(`
`),o=hn(i);se.innerHTML=`
        <div class="ocr-stats">
            <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
            <p><strong>Text Regions Found:</strong> ${i.length}</p>
            <p><strong>Engine:</strong> ${t}</p>
            <p><strong>Average Confidence:</strong> ${ln(i)}%</p>
        </div>
        
        <div class="paddle-results-container">
            <div class="result-tabs">
                <button class="result-tab active" onclick="showResultTab('visual')">Visual Results</button>
                <button class="result-tab" onclick="showResultTab('text')">Text Only</button>
                <button class="result-tab" onclick="showResultTab('grouped')">Grouped by Line</button>
            </div>
            
            <div id="visualResults" class="tab-content active">
                <div class="result-image-container">
                    <img id="resultImage" src="${Y.src}" alt="OCR Result">
                    <div class="bounding-box-overlay" id="boundingBoxOverlay"></div>
                </div>
                <div class="detection-results">
                    <h3>Detected Text Regions:</h3>
                    <ul class="detection-list" id="visualDetectionList">
                        ${i.map((s,r)=>{const d=je(s.confidence);return`
                                <li data-index="${r}" onmouseover="highlightBox(${r})" onmouseout="unhighlightBox(${r})" onclick="selectBox(${r})">
                                    <span class="detection-index">${r+1}.</span>
                                    <span class="detection-text">${ee(s.text)}</span>
                                    <span class="detection-confidence ${d}">${(s.confidence*100).toFixed(1)}%</span>
                                </li>
                            `}).join("")}
                    </ul>
                </div>
            </div>
            
            <div id="textResults" class="tab-content grouped-results">
                <div class="text-result">
                    <h3>Extracted Text:</h3>
                    <div class="text-content" id="extractedText">${ee(n||"No text detected")}</div>
                </div>
            </div>
            
            <div id="groupedResults" class="tab-content grouped-results">
                <h3>Text Grouped by Line:</h3>
                ${o.map((s,r)=>`
                    <div class="text-region-group">
                        <div class="region-header">
                            <span class="region-title">Line ${r+1}</span>
                            <div class="region-confidence">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${s.avgConfidence}%"></div>
                                </div>
                                <span class="confidence-text">${s.avgConfidence.toFixed(1)}%</span>
                            </div>
                        </div>
                        <p>${ee(s.text)}</p>
                    </div>
                `).join("")}
            </div>
        </div>
    `,setTimeout(()=>Ue(i),100)}async function rn(){const i=document.getElementById("extractedText");if(i)try{await navigator.clipboard.writeText(i.textContent),dn("Text copied to clipboard!")}catch{K("Failed to copy text")}}function an(){const i=document.getElementById("extractedText");if(i){const e=i.textContent,t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`pp-ocrv5-result-${Date.now()}.txt`,o.click(),URL.revokeObjectURL(n)}}function cn(){if(te){const e=Y.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),te=null}_e.value="",Fe.style.display="none",me.style.display="none",se.innerHTML="",Y.src="";const i=Y.parentElement;i.innerHTML='<img id="previewImage" alt="Preview">',window.previewImage=document.getElementById("previewImage"),C("Ready to process a new image","info")}function ee(i){const e=document.createElement("div");return e.textContent=i,e.innerHTML}function K(i){C(i,"error");const e=document.createElement("div");e.className="toast error",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},5e3)}function dn(i){const e=document.createElement("div");e.className="toast success",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}function C(i,e="info"){console.log(`[${e.toUpperCase()}] ${i}`);const t=document.getElementById("status");t&&(t.textContent=i,t.className=`status ${e}`)}function ln(i){return i.length===0?0:(i.reduce((t,n)=>t+n.confidence,0)/i.length*100).toFixed(1)}function je(i){const e=i*100;return e>=80?"high-confidence":e>=60?"medium-confidence":"low-confidence"}function hn(i){if(i.length===0)return[];const e=[...i].sort((o,s)=>{const r=Math.min(...o.box.map(a=>a[1])),d=Math.min(...s.box.map(a=>a[1]));return r-d}),t=[];let n=[e[0]];for(let o=1;o<e.length;o++){const s=Math.min(...e[o-1].box.map(d=>d[1])),r=Math.min(...e[o].box.map(d=>d[1]));Math.abs(r-s)<20?n.push(e[o]):(t.push(n),n=[e[o]])}return n.length>0&&t.push(n),t.map(o=>{o.sort((d,a)=>{const l=Math.min(...d.box.map(c=>c[0])),f=Math.min(...a.box.map(c=>c[0]));return l-f});const s=o.map(d=>d.text).join(" "),r=o.reduce((d,a)=>d+a.confidence,0)/o.length*100;return{text:s,avgConfidence:r,items:o}})}function Ue(i){const e=document.getElementById("boundingBoxOverlay"),t=document.getElementById("resultImage");if(!e||!t)return;if(e.innerHTML="",!t.complete){t.onload=()=>Ue(i);return}const n=t.getBoundingClientRect(),o=t.naturalWidth/n.width,s=t.naturalHeight/n.height;i.forEach((r,d)=>{const a=r.box,l=Math.min(...a.map(x=>x[0]))/o,f=Math.min(...a.map(x=>x[1]))/s,c=Math.max(...a.map(x=>x[0]))/o,p=Math.max(...a.map(x=>x[1]))/s,h=document.createElement("div");h.className=`text-box ${je(r.confidence)}`,h.dataset.index=d,h.style.left=`${l}px`,h.style.top=`${f}px`,h.style.width=`${c-l}px`,h.style.height=`${p-f}px`;const y=document.createElement("div");y.className="text-box-label",y.textContent=`${d+1}: ${(r.confidence*100).toFixed(0)}%`,h.appendChild(y),h.onclick=()=>selectBox(d),e.appendChild(h)})}window.showResultTab=function(i){document.querySelectorAll(".result-tab").forEach(e=>{e.classList.remove("active")}),event.target.classList.add("active"),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")}),i==="visual"?document.getElementById("visualResults").classList.add("active"):i==="text"?document.getElementById("textResults").classList.add("active"):i==="grouped"&&document.getElementById("groupedResults").classList.add("active")};window.highlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.add("hover"),t&&t.classList.add("highlighted")};window.unhighlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.remove("hover"),t&&t.classList.remove("highlighted")};window.selectBox=function(i){document.querySelectorAll(".text-box.selected").forEach(t=>{t.classList.remove("selected")});const e=document.querySelector(`.text-box[data-index="${i}"]`);if(e){e.classList.add("selected");const t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlighted"),setTimeout(()=>t.classList.remove("highlighted"),2e3))}};document.addEventListener("DOMContentLoaded",Kt);
//# sourceMappingURL=index-DOaXMq7T.js.map
