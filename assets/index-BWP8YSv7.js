import{b as de,F as we,H as ye}from"./onnxruntime-CqRzMC93.js";import{p as ee,c as Ye,g as He}from"./pdfjs-BhC3vFUT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();ee.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";de.wasm.wasmPaths="/client-ocr-app/assets/";de.wasm.numThreads=1;de.webgl.pack=!1;de.webgl.matmulMaxBatchSize=16;const xe="/client-ocr-app/models/",N={det_limit_side_len:1280,det_limit_type:"max",det_db_thresh:.05,det_db_box_thresh:.1,det_db_unclip_ratio:2.5,det_db_min_size:2,det_db_max_candidates:2e3,det_use_dilation:!0,det_dilation_kernel:3,rec_image_height:48,rec_image_width:320,rec_batch_num:6,drop_score:.05,det_mean:[.485,.456,.406],det_std:[.229,.224,.225],rec_mean:.5,rec_std:.5,min_area_thresh:2,vertical_gap_threshold:.5,english_mode:!0,min_word_confidence:.1,enable_word_splitting:!0,grid_size:16,overlap_ratio:.2};class We{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"en_PP-OCRv4_mobile_rec_infer.onnx",dictionary:"en_dict.txt"},this.CONFIG=N}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release();const n=["webgl","wasm"];let o=null;for(const r of n)try{console.log(`Trying to load detection model with ${r} provider...`),this.detectionSession=await we.create(xe+this.modelConfig.detection,{executionProviders:[r],graphOptimizationLevel:"all",enableCpuMemArena:!1,enableMemPattern:!1}),console.log(`Detection model loaded successfully with ${r}:`,this.detectionSession.inputNames,this.detectionSession.outputNames);break}catch(l){if(console.warn(`Failed to load with ${r}:`,l.message),o=l,r===n[n.length-1])throw o}const s=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${s}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release();for(const r of n)try{console.log(`Trying to load recognition model with ${r} provider...`),this.recognitionSession=await we.create(xe+this.modelConfig.recognition,{executionProviders:[r],graphOptimizationLevel:"all",enableCpuMemArena:!1,enableMemPattern:!1}),console.log(`Recognition model loaded successfully with ${r}:`,this.recognitionSession.inputNames,this.recognitionSession.outputNames);break}catch(l){if(console.warn(`Failed to load recognition with ${r}:`,l.message),o=l,r===n[n.length-1])throw o}this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR ready!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(xe+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(console.log("Processing blob type:",e.type,"size:",e.size),e.type==="application/pdf")return await this.processPDF(e);console.log("Converting blob to image...");const t=await this.blobToImage(e);console.log("Image loaded:",t.width,"x",t.height);const n=await this.detectText(t),o=await this.recognizeText(t,n);return this.mergeTextLines(o)}async detectText(e){var t,n;if(console.log("detectText called, checking detection session..."),!this.detectionSession)throw new Error("Detection model not loaded");console.log("Detection session exists:",this.detectionSession),console.log("Current dictionary:",this.modelConfig.dictionary,"Dictionary length:",this.charDict.length);try{console.log("Starting image resize...");const{resizedImage:o,ratio:s}=await this.resizeForDetection(e);console.log("Image resized, ratio:",s),console.log("Starting preprocessing...");const r=await this.preprocessForDetection(o);console.log("Preprocessing complete, tensor shape:",r.dims),console.log("Running detection model..."),console.log("Input names:",this.detectionSession.inputNames),console.log("Output names:",this.detectionSession.outputNames);const l={[this.detectionSession.inputNames[0]]:r};let a;try{console.log("Tensor data type:",r.type),console.log("Tensor size:",r.data.length),console.log("Tensor shape:",r.dims),console.log("Expected input name:",this.detectionSession.inputNames[0]);try{const v=this.detectionSession.inputNames.map(E=>({name:E}));console.log("Model inputs:",v)}catch{console.log("Could not get model input info")}const h=r.data;let c=0,u=0,g=1/0,y=-1/0;for(let v=0;v<h.length;v++)isNaN(h[v])&&c++,isFinite(h[v])||u++,g=Math.min(g,h[v]),y=Math.max(y,h[v]);console.log(`Tensor stats: min=${g.toFixed(3)}, max=${y.toFixed(3)}`),(c>0||u>0)&&console.error(`Invalid tensor data: ${c} NaN values, ${u} Inf values`),a=await this.detectionSession.run(l),console.log("Detection complete"),console.log("Output shape:",a[this.detectionSession.outputNames[0]].dims)}catch(h){if(console.error("ONNX inference error:",h),console.error("Error code:",h.code),console.error("Error message:",h.message),console.error("Error stack:",h.stack),h.code===30757872||(t=h.message)!=null&&t.includes("invalid graph")||(n=h.message)!=null&&n.includes("dimension mismatch")){console.error("Model compatibility issue detected. The model might require specific input dimensions."),console.error("Trying simplified approach...");try{const c=await this.simplifiedDetection(o,s);return console.log(`Simplified detection found ${c.length} regions`),c}catch(c){console.error("Simplified detection also failed:",c)}}throw h}const d=await this.postprocessDetection(a[this.detectionSession.outputNames[0]],o.width,o.height,s);return console.log(`Detected ${d.length} text regions`),this.sortBoxes(d)}catch(o){return console.error("Error in detectText:",o),console.error("Error details:",{message:o.message,stack:o.stack,name:o.name,code:o.code}),[]}}async resizeForDetection(e){try{console.log("resizeForDetection - input image size:",e.width,"x",e.height);const t=this.CONFIG.det_limit_side_len,n=this.CONFIG.det_limit_type;let o=e.width,s=e.height,r=1;n==="max"?Math.max(s,o)>t&&(r=s>o?t/s:t/o):Math.min(s,o)<t&&(r=s<o?t/s:t/o),o=Math.round(o*r),s=Math.round(s*r);const l=this.CONFIG.grid_size||32,a=Math.max(l,Math.round(o/l)*l),d=Math.max(l,Math.round(s/l)*l);if(console.log(`Resizing from ${e.width}x${e.height} to ${a}x${d} (ratio: ${r})`),a<=0||d<=0||!isFinite(a)||!isFinite(d))throw new Error(`Invalid target dimensions: ${a}x${d}`);const h=await this.preprocessImage(e,a,d),c=new Image;return new Promise(u=>{this.canvas.toBlob(g=>{const y=URL.createObjectURL(g);c.onload=()=>{URL.revokeObjectURL(y),u({resizedImage:c,ratio:r})},c.src=y})})}catch(t){throw console.error("Error in resizeForDetection:",t),t}}async preprocessImage(e,t,n){this.canvas.width=t,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,t,n),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high";const o=Math.min(t/e.width,n/e.height),s=e.width*o,r=e.height*o,l=(t-s)/2,a=(n-r)/2;this.ctx.drawImage(e,l,a,s,r);const d=this.ctx.getImageData(0,0,t,n),h=d.data;for(let c=0;c<h.length;c+=4){let g=(.299*h[c]+.587*h[c+1]+.114*h[c+2]-128)*1.2+128;g>240?g=255:g<15&&(g=0),g=Math.max(0,Math.min(255,g)),h[c]=g,h[c+1]=g,h[c+2]=g}return this.ctx.putImageData(d,0,0),this.canvas}async preprocessForDetection(e){try{this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data;console.log(`Preprocessing image: ${e.width}x${e.height}`);const o=e.width*e.height,s=new Float32Array(3*o),r=N.det_mean||[.485,.456,.406],l=N.det_std||[.229,.224,.225];for(let d=0;d<o;d++){const h=d*4,c=Math.max(0,Math.min(255,n[h])),u=Math.max(0,Math.min(255,n[h+1])),g=Math.max(0,Math.min(255,n[h+2]));s[d]=(c/255-r[0])/l[0],s[o+d]=(u/255-r[1])/l[1],s[2*o+d]=(g/255-r[2])/l[2]}for(let d=0;d<s.length;d++)isFinite(s[d])||(console.error(`Invalid value at index ${d}: ${s[d]}`),s[d]=0);const a=new ye("float32",s,[1,3,e.height,e.width]);return console.log("Created tensor with shape:",a.dims,"type:",a.type),a}catch(t){throw console.error("Error in preprocessForDetection:",t),new Error(`Preprocessing failed: ${t.message}`)}}async postprocessDetection(e,t,n,o){try{let s,r,l;if(e.dims.length===4){const[b,$,O,L]=e.dims;s=O,r=L,l=e.data}else if(e.dims.length===3){const[b,$,O]=e.dims;s=$,r=O,l=e.data}else throw new Error(`Unexpected output tensor dimensions: ${e.dims}`);console.log(`Detection output shape: ${s}x${r}, total pixels: ${s*r}`),console.log("Output tensor dims:",e.dims),console.log("Data length:",l.length);const a=new Float32Array(s*r);for(let b=0;b<s*r;b++)a[b]=1/(1+Math.exp(-l[b]));const d=new Uint8Array(s*r);let h=0;for(let b=0;b<s*r;b++)d[b]=a[b]>N.det_db_thresh?255:0,d[b]===255&&h++;console.log(`Detected pixels: ${h} out of ${s*r} (${(h/(s*r)*100).toFixed(2)}%)`),console.log(`Detection threshold: ${N.det_db_thresh}`);const c=[];for(let b=0;b<Math.min(10,a.length);b+=Math.floor(a.length/10))c.push(a[b].toFixed(3));console.log("Sample probability values:",c);const u=[],g=new Set;let y=0,v=0,E=0,M=0;for(let b=0;b<s&&y<N.det_db_max_candidates;b++)for(let $=0;$<r&&y<N.det_db_max_candidates;$++){const O=b*r+$;if(d[O]===255&&!g.has(O)){const L=this.findConnectedComponent(d,r,s,$,b,g,a);if(L)if(v++,L.score>=N.det_db_box_thresh){L.points=L.points.map(C=>[Math.round(C[0]/o),Math.round(C[1]/o)]);const z=this.calculatePolygonArea(L.points);z>N.min_area_thresh?(u.push(L),y++):(M++,console.log(`Component rejected by area: ${z} < ${N.min_area_thresh}`))}else E++,console.log(`Component rejected by score: ${L.score.toFixed(3)} < ${N.det_db_box_thresh}`)}}return console.log(`Detection summary: ${v} components found, ${y} accepted, ${E} rejected by score, ${M} rejected by area`),u}catch(s){throw console.error("Error in postprocessDetection:",s),new Error(`Detection post-processing failed: ${s.message}`)}}findConnectedComponent(e,t,n,o,s,r,l){const a=[[o,s]],d=[];let h=0,c=0;const u=1e4,g=s*t+o;if(r.has(g)||e[g]!==255)return null;const y=new Set;for(y.add(g);a.length>0&&d.length<u;){const[C,D]=a.pop(),j=D*t+C;if(!r.has(j)&&(r.add(j),e[j]===255)){d.push([C,D]),h+=l[j],c++;const ae=[[C,D-1],[C,D+1],[C-1,D],[C+1,D]];for(const[k,q]of ae)if(k>=0&&k<t&&q>=0&&q<n){const X=q*t+k;if(!r.has(X)&&e[X]===255){const he=Math.abs(q-s),V=Math.abs(k-o);(he<n*.05||V<t*.3)&&(a.push([k,q]),y.add(X))}}}}if(d.length<N.det_db_min_size)return null;const v=d.map(C=>C[0]),E=d.map(C=>C[1]);let M=Math.min(...v),b=Math.max(...v),$=Math.min(...E),O=Math.max(...E);N.det_db_unclip_ratio;const L=(b-M)*.1,z=(O-$)*.2;return M=Math.max(0,M-L),b=Math.min(t-1,b+L),$=Math.max(0,$-z),O=Math.min(n-1,O+z),{points:[[M,$],[b,$],[b,O],[M,O]],score:h/c}}calculatePolygonArea(e){let t=0;const n=e.length;for(let o=0;o<n;o++){const s=(o+1)%n;t+=e[o][0]*e[s][1],t-=e[s][0]*e[o][1]}return Math.abs(t)/2}async simplifiedDetection(e,t){console.log("Using simplified detection fallback..."),this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const o=this.ctx.getImageData(0,0,e.width,e.height).data,s=new Uint8Array(e.width*e.height);for(let a=0;a<s.length;a++){const d=a*4,h=.299*o[d]+.587*o[d+1]+.114*o[d+2];s[a]=h<200?255:0}const r=[],l=new Set;for(let a=10;a<e.height-10;a+=20)for(let d=10;d<e.width-10;d+=20){const h=a*e.width+d;if(s[h]===255&&!l.has(h)){let c=d,u=d,g=a,y=a;const v=[[d,a]];for(;v.length>0&&l.size<1e4;){const[E,M]=v.pop(),b=M*e.width+E;E<0||E>=e.width||M<0||M>=e.height||l.has(b)||s[b]!==255||(l.add(b),c=Math.min(c,E),u=Math.max(u,E),g=Math.min(g,M),y=Math.max(y,M),v.push([E+1,M],[E-1,M],[E,M+1],[E,M-1]))}u-c>10&&y-g>10&&r.push({points:[[c/t,g/t],[u/t,g/t],[u/t,y/t],[c/t,y/t]],score:.8})}}return r}sortBoxes(e){if(e.length===0)return e;e.sort((t,n)=>{const o=t.points[0][1],s=n.points[0][1];return o-s});for(let t=e.length-1;t>0;t--)for(let n=t-1;n>=0&&(Math.abs(e[n+1].points[0][1]-e[n].points[0][1])<10&&e[n+1].points[0][0]<e[n].points[0][0]);n--){const o=e[n];e[n]=e[n+1],e[n+1]=o}return e}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[],o=N.rec_batch_num;for(let s=0;s<t.length;s+=o){const r=t.slice(s,Math.min(s+o,t.length)),l=await this.processBatch(e,r);n.push(...l)}return n}async processBatch(e,t){const n=[],o=[],s=[];for(const l of t){const a=await this.getRotateCropImage(e,l),d=a.width/a.height;o.push(a),s.push(d)}const r=Array.from({length:t.length},(l,a)=>a).sort((l,a)=>s[l]-s[a]);for(const l of r){const a=o[l],d=t[l],h=await this.preprocessForRecognition(a),c={[this.recognitionSession.inputNames[0]]:h},u=await this.recognitionSession.run(c),g=await this.decodeRecognition(u[this.recognitionSession.outputNames[0]]);g.score>=N.drop_score&&n.push({text:g.text,confidence:g.score,box:d.points})}return n}async getRotateCropImage(e,t){const n=t.points;Math.sqrt(Math.pow(n[0][0]-n[1][0],2)+Math.pow(n[0][1]-n[1][1],2)),Math.sqrt(Math.pow(n[2][0]-n[3][0],2)+Math.pow(n[2][1]-n[3][1],2)),Math.sqrt(Math.pow(n[0][0]-n[3][0],2)+Math.pow(n[0][1]-n[3][1],2)),Math.sqrt(Math.pow(n[1][0]-n[2][0],2)+Math.pow(n[1][1]-n[2][1],2));const o=Math.min(...n.map(c=>c[0])),s=Math.max(...n.map(c=>c[0])),r=Math.min(...n.map(c=>c[1])),l=Math.max(...n.map(c=>c[1])),a=s-o,d=l-r;if(this.canvas.width=a,this.canvas.height=d,this.ctx.drawImage(e,o,r,a,d,0,0,a,d),d*1/a>=1.5){const c=document.createElement("canvas"),u=c.getContext("2d",{willReadFrequently:!0});c.width=d,c.height=a,u.translate(d/2,a/2),u.rotate(Math.PI/2),u.drawImage(this.canvas,-a/2,-d/2),this.canvas.width=d,this.canvas.height=a,this.ctx.drawImage(c,0,0)}const h=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const g=URL.createObjectURL(u);h.onload=()=>{URL.revokeObjectURL(g),c(h)},h.src=g})})}async preprocessForRecognition(e){const n=N.rec_image_height,o=N.rec_image_width,s=e.height,l=e.width/s;let a;Math.ceil(n*l)>o?a=o:a=Math.ceil(n*l),this.canvas.width=a,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,a,n),this.ctx.drawImage(e,0,0,a,n);const h=this.ctx.getImageData(0,0,a,n).data,c=new Float32Array(3*n*o);for(let u=0;u<3;u++)for(let g=0;g<n;g++)for(let y=0;y<a;y++){const v=(g*a+y)*4+u,E=u*n*o+g*o+y;c[E]=(h[v]/255-N.rec_mean)/N.rec_std}return new ye("float32",c,[1,3,n,o])}async decodeRecognition(e){const[t,n,o]=e.dims,s=e.data,r=[],l=[];for(let c=0;c<n;c++){let u=0,g=s[c*o];for(let y=1;y<o;y++){const v=s[c*o+y];v>g&&(g=v,u=y)}r.push(u),l.push(g)}const a=[],d=[];let h=-1;for(let c=0;c<r.length;c++){const u=r[c];u!==0&&u!==h&&u<this.charDict.length&&(a.push(this.charDict[u]),d.push(l[c])),h=u}return{text:a.join(""),score:d.length>0?d.reduce((c,u)=>c+u)/d.length:0}}mergeTextLines(e){if(e.length===0)return e;let t=this.filterResults(e);if(t.length===0)return t;N.english_mode&&(t=this.postProcessEnglishText(t));const n=t.map(a=>{const d=a.box.map(h=>h[1]);return Math.max(...d)-Math.min(...d)}),o=n.reduce((a,d)=>a+d)/n.length,s=[];let r=[t[0]];for(let a=1;a<t.length;a++){const d=t[a],h=t[a-1],c=Math.min(...h.box.map(v=>v[1])),u=Math.min(...d.box.map(v=>v[1])),g=Math.abs(u-c),y=o*N.vertical_gap_threshold;g<=y?r.push(d):(s.push(r),r=[d])}r.length>0&&s.push(r);const l=[];for(const a of s){a.sort((y,v)=>{const E=Math.min(...y.box.map(b=>b[0])),M=Math.min(...v.box.map(b=>b[0]));return E-M});const d=a.map(y=>y.text).join(" "),h=a.reduce((y,v)=>y+v.confidence,0)/a.length,c=a.flatMap(y=>y.box),u=c.map(y=>y[0]),g=c.map(y=>y[1]);l.push({text:d,confidence:h,box:[[Math.min(...u),Math.min(...g)],[Math.max(...u),Math.min(...g)],[Math.max(...u),Math.max(...g)],[Math.min(...u),Math.max(...g)]]})}return l}filterResults(e){const t=N.drop_score;return e.filter(n=>n.confidence<t?!1:n.text&&n.text.trim().length>0)}async processPDF(e){const t=await e.arrayBuffer(),n=await ee.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const l=await n.getPage(r),a=l.getViewport({scale:2}),d=document.createElement("canvas"),h=d.getContext("2d");d.width=a.width,d.height=a.height,await l.render({canvasContext:h,viewport:a}).promise;const c=await new Promise(g=>d.toBlob(g)),u=await this.process(c);s.push({page:r,results:u})}return s}async blobToImage(e){return new Promise((t,n)=>{const o=new Image,s=URL.createObjectURL(e);o.onload=()=>{URL.revokeObjectURL(s),t(o)},o.onerror=()=>{URL.revokeObjectURL(s),n(new Error("Failed to load image"))},o.src=s})}postProcessEnglishText(e){return e.map(t=>{let n=t.text;n=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([a-zA-Z])(\d)/g,"$1 $2").replace(/(\d)([a-zA-Z])/g,"$1 $2").replace(/\s+/g," ").replace(/([.,!?;:])([a-zA-Z])/g,"$1 $2").trim();const o={tne:"the",tnat:"that",wnen:"when",wnere:"where",witn:"with","l'":"I'"," l ":" I ","^l ":"I "};for(const[s,r]of Object.entries(o)){const l=new RegExp(s,"gi");n=n.replace(l,r)}return{...t,text:n}})}}const re=new We;ee.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";de.wasm.wasmPaths="/client-ocr-app/assets/";de.wasm.numThreads=1;const be="/client-ocr-app/models/",U={det_limit_side_len:1280,det_db_thresh:.05,det_db_box_thresh:.15,det_db_unclip_ratio:2.5,drop_score:.05,mean:[.485,.456,.406],std:[.229,.224,.225]};class qe{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"en_PP-OCRv4_mobile_rec_infer.onnx",dictionary:"en_dict.txt"}}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){this.initialized=!1;try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release(),this.detectionSession=await we.create(be+this.modelConfig.detection,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Detection model loaded:",this.detectionSession.inputNames,this.detectionSession.outputNames);const n=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${n}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release(),this.recognitionSession=await we.create(be+this.modelConfig.recognition,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Recognition model loaded:",this.recognitionSession.inputNames,this.recognitionSession.outputNames),this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR models loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(be+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.blobToImage(e),n=await this.detectText(t);return await this.recognizeText(t,n)}async detectText(e){if(!this.detectionSession)throw new Error("Detection model not loaded");const{resizedImage:t,ratio:n}=await this.resizeForDetection(e),o=await this.preprocessForDetection(t),s={[this.detectionSession.inputNames[0]]:o},l=(await this.detectionSession.run(s))[this.detectionSession.outputNames[0]];return await this.postprocessDetection(l,t.width,t.height,n)}async resizeForDetection(e){const t=U.det_limit_side_len;let n=e.width,o=e.height,s=1;Math.max(o,n)>t&&(s=t/Math.max(o,n));const r=Math.ceil(n*s),l=Math.ceil(o*s),a=Math.ceil(r/32)*32,d=Math.ceil(l/32)*32;this.canvas.width=a,this.canvas.height=d,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,a,d),this.ctx.drawImage(e,0,0,r,l);const h=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const g=URL.createObjectURL(u);h.onload=()=>{URL.revokeObjectURL(g),c({resizedImage:h,ratio:s})},h.src=g})})}async preprocessForDetection(e){this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data,o=e.width*e.height,s=new Float32Array(3*o);for(let r=0;r<o;r++){const l=r*4;s[r]=(n[l]/255-U.mean[0])/U.std[0],s[o+r]=(n[l+1]/255-U.mean[1])/U.std[1],s[2*o+r]=(n[l+2]/255-U.mean[2])/U.std[2]}return new ye("float32",s,[1,3,e.height,e.width])}async postprocessDetection(e,t,n,o){const[s,r,l,a]=e.dims,d=e.data,h=new Float32Array(l*a);for(let v=0;v<l*a;v++)h[v]=1/(1+Math.exp(-d[v]));const c=new Uint8Array(l*a),u=U.det_db_thresh;for(let v=0;v<l*a;v++)c[v]=h[v]>u?1:0;const g=[],y=new Set;for(let v=0;v<l;v++)for(let E=0;E<a;E++){const M=v*a+E;if(c[M]===1&&!y.has(M)&&h[M]>U.det_db_box_thresh){const b=this.expandBox(c,h,E,v,a,l,y);if(b){const $={points:b.points.map(O=>[Math.round(O[0]*t/a/o),Math.round(O[1]*n/l/o)]),score:b.score};g.push($)}}}return this.sortBoxes(g)}expandBox(e,t,n,o,s,r,l){let a=n,d=n,h=o,c=o,u=0,g=0;const y=[[n,o]];for(l.add(o*s+n);y.length>0;){const[M,b]=y.shift();u+=t[b*s+M],g++;for(let $=-1;$<=1;$++)for(let O=-1;O<=1;O++){const L=M+O,z=b+$,C=z*s+L;L>=0&&L<s&&z>=0&&z<r&&e[C]===1&&!l.has(C)&&(l.add(C),y.push([L,z]),a=Math.min(a,L),d=Math.max(d,L),h=Math.min(h,z),c=Math.max(c,z))}}if(d-a<3||c-h<3)return null;const v=U.det_db_unclip_ratio,E=Math.max(d-a,c-h)*(v-1)/2;return a=Math.max(0,a-E),d=Math.min(s-1,d+E),h=Math.max(0,h-E),c=Math.min(r-1,c+E),{points:[[a,h],[d,h],[d,c],[a,c]],score:u/g}}sortBoxes(e){return e.sort((t,n)=>{const o=Math.min(...t.points.map(r=>r[1])),s=Math.min(...n.points.map(r=>r[1]));if(Math.abs(o-s)<10){const r=Math.min(...t.points.map(a=>a[0])),l=Math.min(...n.points.map(a=>a[0]));return r-l}return o-s})}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[];for(const o of t){const s=await this.cropToBox(e,o),r=await this.preprocessForRecognition(s),l={[this.recognitionSession.inputNames[0]]:r},a=await this.recognitionSession.run(l),d=await this.decodeRecognition(a[this.recognitionSession.outputNames[0]]);d.score>=U.drop_score&&n.push({text:d.text,confidence:d.score,box:o.points})}return n}async cropToBox(e,t){const n=t.points,o=Math.min(...n.map(c=>c[0])),s=Math.max(...n.map(c=>c[0])),r=Math.min(...n.map(c=>c[1])),l=Math.max(...n.map(c=>c[1])),a=s-o,d=l-r;this.canvas.width=a,this.canvas.height=d,this.ctx.drawImage(e,o,r,a,d,0,0,a,d);const h=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const g=URL.createObjectURL(u);h.onload=()=>{URL.revokeObjectURL(g),c(h)},h.src=g})})}async preprocessForRecognition(e){const n=e.width/e.height;let o=Math.round(48*n);o=Math.max(o,48),this.canvas.width=o,this.canvas.height=48,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,o,48),this.ctx.drawImage(e,0,0,o,48);const r=this.ctx.getImageData(0,0,o,48).data,l=o*48,a=new Float32Array(3*l);for(let d=0;d<l;d++){const h=d*4;a[d]=(r[h]/255-.5)/.5,a[l+d]=(r[h+1]/255-.5)/.5,a[2*l+d]=(r[h+2]/255-.5)/.5}return new ye("float32",a,[1,3,48,o])}async decodeRecognition(e){const[t,n,o]=e.dims,s=e.data,r=[],l=[];for(let c=0;c<n;c++){let u=0,g=s[c*o];for(let y=1;y<o;y++){const v=s[c*o+y];v>g&&(g=v,u=y)}r.push(u),l.push(g)}const a=[],d=[];let h=-1;for(let c=0;c<r.length;c++){const u=r[c];u!==0&&u!==h&&u<this.charDict.length&&(a.push(this.charDict[u]),d.push(l[c])),h=u}return{text:a.join(""),score:d.length>0?d.reduce((c,u)=>c+u)/d.length:0}}async processPDF(e){const t=await e.arrayBuffer(),n=await ee.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const l=await n.getPage(r),a=l.getViewport({scale:2}),d=document.createElement("canvas"),h=d.getContext("2d");d.width=a.width,d.height=a.height,await l.render({canvasContext:h,viewport:a}).promise;const c=await new Promise(v=>d.toBlob(v,"image/png")),u=await this.blobToImage(c),g=await this.detectText(u),y=await this.recognizeText(u,g);s.push({page:r,results:y})}return s}async blobToImage(e){return new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=URL.createObjectURL(e)})}}const Q=new qe;var Xe={exports:{}};(function(i){var e=function(t){var n=Object.prototype,o=n.hasOwnProperty,s=Object.defineProperty||function(f,m,w){f[m]=w.value},r,l=typeof Symbol=="function"?Symbol:{},a=l.iterator||"@@iterator",d=l.asyncIterator||"@@asyncIterator",h=l.toStringTag||"@@toStringTag";function c(f,m,w){return Object.defineProperty(f,m,{value:w,enumerable:!0,configurable:!0,writable:!0}),f[m]}try{c({},"")}catch{c=function(m,w,_){return m[w]=_}}function u(f,m,w,_){var p=m&&m.prototype instanceof $?m:$,x=Object.create(p.prototype),R=new ue(_||[]);return s(x,"_invoke",{value:q(f,w,R)}),x}t.wrap=u;function g(f,m,w){try{return{type:"normal",arg:f.call(m,w)}}catch(_){return{type:"throw",arg:_}}}var y="suspendedStart",v="suspendedYield",E="executing",M="completed",b={};function $(){}function O(){}function L(){}var z={};c(z,a,function(){return this});var C=Object.getPrototypeOf,D=C&&C(C(ge([])));D&&D!==n&&o.call(D,a)&&(z=D);var j=L.prototype=$.prototype=Object.create(z);O.prototype=L,s(j,"constructor",{value:L,configurable:!0}),s(L,"constructor",{value:O,configurable:!0}),O.displayName=c(L,h,"GeneratorFunction");function ae(f){["next","throw","return"].forEach(function(m){c(f,m,function(w){return this._invoke(m,w)})})}t.isGeneratorFunction=function(f){var m=typeof f=="function"&&f.constructor;return m?m===O||(m.displayName||m.name)==="GeneratorFunction":!1},t.mark=function(f){return Object.setPrototypeOf?Object.setPrototypeOf(f,L):(f.__proto__=L,c(f,h,"GeneratorFunction")),f.prototype=Object.create(j),f},t.awrap=function(f){return{__await:f}};function k(f,m){function w(x,R,S,I){var T=g(f[x],f,R);if(T.type==="throw")I(T.arg);else{var Z=T.arg,K=Z.value;return K&&typeof K=="object"&&o.call(K,"__await")?m.resolve(K.__await).then(function(J){w("next",J,S,I)},function(J){w("throw",J,S,I)}):m.resolve(K).then(function(J){Z.value=J,S(Z)},function(J){return w("throw",J,S,I)})}}var _;function p(x,R){function S(){return new m(function(I,T){w(x,R,I,T)})}return _=_?_.then(S,S):S()}s(this,"_invoke",{value:p})}ae(k.prototype),c(k.prototype,d,function(){return this}),t.AsyncIterator=k,t.async=function(f,m,w,_,p){p===void 0&&(p=Promise);var x=new k(u(f,m,w,_),p);return t.isGeneratorFunction(m)?x:x.next().then(function(R){return R.done?R.value:x.next()})};function q(f,m,w){var _=y;return function(x,R){if(_===E)throw new Error("Generator is already running");if(_===M){if(x==="throw")throw R;return me()}for(w.method=x,w.arg=R;;){var S=w.delegate;if(S){var I=X(S,w);if(I){if(I===b)continue;return I}}if(w.method==="next")w.sent=w._sent=w.arg;else if(w.method==="throw"){if(_===y)throw _=M,w.arg;w.dispatchException(w.arg)}else w.method==="return"&&w.abrupt("return",w.arg);_=E;var T=g(f,m,w);if(T.type==="normal"){if(_=w.done?M:v,T.arg===b)continue;return{value:T.arg,done:w.done}}else T.type==="throw"&&(_=M,w.method="throw",w.arg=T.arg)}}}function X(f,m){var w=m.method,_=f.iterator[w];if(_===r)return m.delegate=null,w==="throw"&&f.iterator.return&&(m.method="return",m.arg=r,X(f,m),m.method==="throw")||w!=="return"&&(m.method="throw",m.arg=new TypeError("The iterator does not provide a '"+w+"' method")),b;var p=g(_,f.iterator,m.arg);if(p.type==="throw")return m.method="throw",m.arg=p.arg,m.delegate=null,b;var x=p.arg;if(!x)return m.method="throw",m.arg=new TypeError("iterator result is not an object"),m.delegate=null,b;if(x.done)m[f.resultName]=x.value,m.next=f.nextLoc,m.method!=="return"&&(m.method="next",m.arg=r);else return x;return m.delegate=null,b}ae(j),c(j,h,"Generator"),c(j,a,function(){return this}),c(j,"toString",function(){return"[object Generator]"});function he(f){var m={tryLoc:f[0]};1 in f&&(m.catchLoc=f[1]),2 in f&&(m.finallyLoc=f[2],m.afterLoc=f[3]),this.tryEntries.push(m)}function V(f){var m=f.completion||{};m.type="normal",delete m.arg,f.completion=m}function ue(f){this.tryEntries=[{tryLoc:"root"}],f.forEach(he,this),this.reset(!0)}t.keys=function(f){var m=Object(f),w=[];for(var _ in m)w.push(_);return w.reverse(),function p(){for(;w.length;){var x=w.pop();if(x in m)return p.value=x,p.done=!1,p}return p.done=!0,p}};function ge(f){if(f){var m=f[a];if(m)return m.call(f);if(typeof f.next=="function")return f;if(!isNaN(f.length)){var w=-1,_=function p(){for(;++w<f.length;)if(o.call(f,w))return p.value=f[w],p.done=!1,p;return p.value=r,p.done=!0,p};return _.next=_}}return{next:me}}t.values=ge;function me(){return{value:r,done:!0}}return ue.prototype={constructor:ue,reset:function(f){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(V),!f)for(var m in this)m.charAt(0)==="t"&&o.call(this,m)&&!isNaN(+m.slice(1))&&(this[m]=r)},stop:function(){this.done=!0;var f=this.tryEntries[0],m=f.completion;if(m.type==="throw")throw m.arg;return this.rval},dispatchException:function(f){if(this.done)throw f;var m=this;function w(I,T){return x.type="throw",x.arg=f,m.next=I,T&&(m.method="next",m.arg=r),!!T}for(var _=this.tryEntries.length-1;_>=0;--_){var p=this.tryEntries[_],x=p.completion;if(p.tryLoc==="root")return w("end");if(p.tryLoc<=this.prev){var R=o.call(p,"catchLoc"),S=o.call(p,"finallyLoc");if(R&&S){if(this.prev<p.catchLoc)return w(p.catchLoc,!0);if(this.prev<p.finallyLoc)return w(p.finallyLoc)}else if(R){if(this.prev<p.catchLoc)return w(p.catchLoc,!0)}else if(S){if(this.prev<p.finallyLoc)return w(p.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(f,m){for(var w=this.tryEntries.length-1;w>=0;--w){var _=this.tryEntries[w];if(_.tryLoc<=this.prev&&o.call(_,"finallyLoc")&&this.prev<_.finallyLoc){var p=_;break}}p&&(f==="break"||f==="continue")&&p.tryLoc<=m&&m<=p.finallyLoc&&(p=null);var x=p?p.completion:{};return x.type=f,x.arg=m,p?(this.method="next",this.next=p.finallyLoc,b):this.complete(x)},complete:function(f,m){if(f.type==="throw")throw f.arg;return f.type==="break"||f.type==="continue"?this.next=f.arg:f.type==="return"?(this.rval=this.arg=f.arg,this.method="return",this.next="end"):f.type==="normal"&&m&&(this.next=m),b},finish:function(f){for(var m=this.tryEntries.length-1;m>=0;--m){var w=this.tryEntries[m];if(w.finallyLoc===f)return this.complete(w.completion,w.afterLoc),V(w),b}},catch:function(f){for(var m=this.tryEntries.length-1;m>=0;--m){var w=this.tryEntries[m];if(w.tryLoc===f){var _=w.completion;if(_.type==="throw"){var p=_.arg;V(w)}return p}}throw new Error("illegal catch attempt")},delegateYield:function(f,m,w){return this.delegate={iterator:ge(f),resultName:m,nextLoc:w},this.method==="next"&&(this.arg=r),b}},t}(i.exports);try{regeneratorRuntime=e}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}})(Xe);var Ie=(i,e)=>`${i}-${e}-${Math.random().toString(16).slice(3,8)}`;const Ve=Ie;let $e=0;var ze=({id:i,action:e,payload:t={}})=>{let n=i;return typeof n>"u"&&(n=Ve("Job",$e),$e+=1),{id:n,action:e,payload:t}},le={};let Oe=!1;le.logging=Oe;le.setLogging=i=>{Oe=i};le.log=(...i)=>Oe?console.log.apply(void 0,i):null;const Ke=ze,{log:pe}=le,Je=Ie;let Pe=0;var Ze=()=>{const i=Je("Scheduler",Pe),e={},t={};let n=[];Pe+=1;const o=()=>n.length,s=()=>Object.keys(e).length,r=()=>{if(n.length!==0){const c=Object.keys(e);for(let u=0;u<c.length;u+=1)if(typeof t[c[u]]>"u"){n[0](e[c[u]]);break}}},l=(c,u)=>new Promise((g,y)=>{const v=Ke({action:c,payload:u});n.push(async E=>{n.shift(),t[E.id]=v;try{g(await E[c].apply(void 0,[...u,v.id]))}catch(M){y(M)}finally{delete t[E.id],r()}}),pe(`[${i}]: Add ${v.id} to JobQueue`),pe(`[${i}]: JobQueue length=${n.length}`),r()});return{addWorker:c=>(e[c.id]=c,pe(`[${i}]: Add ${c.id}`),pe(`[${i}]: Number of workers=${s()}`),r(),c.id),addJob:async(c,...u)=>{if(s()===0)throw Error(`[${i}]: You need to have at least one worker before adding jobs`);return l(c,u)},terminate:async()=>{Object.keys(e).forEach(async c=>{await e[c].terminate()}),n=[]},getQueueLen:o,getNumWorkers:s}};function Qe(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var et=Qe;const tt=et;var nt=i=>{const e={};return typeof WorkerGlobalScope<"u"?e.type="webworker":tt()?e.type="electron":typeof document=="object"?e.type="browser":typeof process=="object"&&typeof Ye=="function"&&(e.type="node"),typeof i>"u"?e:e[i]};const ot=nt("type")==="browser",it=ot?i=>new URL(i,window.location.href).href:i=>i;var st=i=>{const e={...i};return["corePath","workerPath","langPath"].forEach(t=>{i[t]&&(e[t]=it(e[t]))}),e},rt=i=>{const e=[],t=[],n=[],o=[],s=[];return i.blocks&&i.blocks.forEach(r=>{r.paragraphs.forEach(l=>{l.lines.forEach(a=>{a.words.forEach(d=>{d.symbols.forEach(h=>{s.push({...h,page:i,block:r,paragraph:l,line:a,word:d})}),o.push({...d,page:i,block:r,paragraph:l,line:a})}),n.push({...a,page:i,block:r,paragraph:l})}),t.push({...l,page:i,block:r})}),e.push({...r,page:i})}),{...i,blocks:e,paragraphs:t,lines:n,words:o,symbols:s}},Be={TESSERACT_ONLY:0,LSTM_ONLY:1,TESSERACT_LSTM_COMBINED:2,DEFAULT:3};const at="5.1.1",ct={version:at};var dt={workerBlobURL:!0,logger:()=>{}};const lt=ct.version,ht=dt;var ut={...ht,workerPath:`https://cdn.jsdelivr.net/npm/tesseract.js@v${lt}/dist/worker.min.js`},gt=({workerPath:i,workerBlobURL:e})=>{let t;if(Blob&&URL&&e){const n=new Blob([`importScripts("${i}");`],{type:"application/javascript"});t=new Worker(URL.createObjectURL(n))}else t=new Worker(i);return t},mt=i=>{i.terminate()},pt=(i,e)=>{i.onmessage=({data:t})=>{e(t)}},ft=async(i,e)=>{i.postMessage(e)};const _e=i=>new Promise((e,t)=>{const n=new FileReader;n.onload=()=>{e(n.result)},n.onerror=({target:{error:{code:o}}})=>{t(Error(`File could not be read! Code=${o}`))},n.readAsArrayBuffer(i)}),Re=async i=>{let e=i;if(typeof i>"u")return"undefined";if(typeof i=="string")/data:image\/([a-zA-Z]*);base64,([^"]*)/.test(i)?e=atob(i.split(",")[1]).split("").map(t=>t.charCodeAt(0)):e=await(await fetch(i)).arrayBuffer();else if(typeof HTMLElement<"u"&&i instanceof HTMLElement)i.tagName==="IMG"&&(e=await Re(i.src)),i.tagName==="VIDEO"&&(e=await Re(i.poster)),i.tagName==="CANVAS"&&await new Promise(t=>{i.toBlob(async n=>{e=await _e(n),t()})});else if(typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas){const t=await i.convertToBlob();e=await _e(t)}else(i instanceof File||i instanceof Blob)&&(e=await _e(i));return new Uint8Array(e)};var wt=Re;const yt=ut,vt=gt,xt=mt,bt=pt,_t=ft,Et=wt;var Lt={defaultOptions:yt,spawnWorker:vt,terminateWorker:xt,onMessage:bt,send:_t,loadImage:Et};const Mt=st,Rt=rt,G=ze,{log:Te}=le,St=Ie,te=Be,{defaultOptions:It,spawnWorker:Ot,terminateWorker:$t,onMessage:Pt,loadImage:Ce,send:Tt}=Lt;let Fe=0;var Ae=async(i="eng",e=te.LSTM_ONLY,t={},n={})=>{const o=St("Worker",Fe),{logger:s,errorHandler:r,...l}=Mt({...It,...t}),a={},d={},h=typeof i=="string"?i.split("+"):i;let c=e,u=n;const g=[te.DEFAULT,te.LSTM_ONLY].includes(e)&&!l.legacyCore;let y,v;const E=new Promise((p,x)=>{v=p,y=x}),M=p=>{y(p.message)};let b=Ot(l);b.onerror=M,Fe+=1;const $=(p,x)=>{a[p]=x},O=(p,x)=>{d[p]=x},L=({id:p,action:x,payload:R})=>new Promise((S,I)=>{Te(`[${o}]: Start ${p}, action=${x}`);const T=`${x}-${p}`;$(T,S),O(T,I),Tt(b,{workerId:o,jobId:p,action:x,payload:R})}),z=()=>console.warn("`load` is depreciated and should be removed from code (workers now come pre-loaded)"),C=p=>L(G({id:p,action:"load",payload:{options:{lstmOnly:g,corePath:l.corePath,logging:l.logging}}})),D=(p,x,R)=>L(G({id:R,action:"FS",payload:{method:"writeFile",args:[p,x]}})),j=(p,x)=>L(G({id:x,action:"FS",payload:{method:"readFile",args:[p,{encoding:"utf8"}]}})),ae=(p,x)=>L(G({id:x,action:"FS",payload:{method:"unlink",args:[p]}})),k=(p,x,R)=>L(G({id:R,action:"FS",payload:{method:p,args:x}})),q=()=>console.warn("`loadLanguage` is depreciated and should be removed from code (workers now come with language pre-loaded)"),X=(p,x)=>L(G({id:x,action:"loadLanguage",payload:{langs:p,options:{langPath:l.langPath,dataPath:l.dataPath,cachePath:l.cachePath,cacheMethod:l.cacheMethod,gzip:l.gzip,lstmOnly:[te.DEFAULT,te.LSTM_ONLY].includes(c)&&!l.legacyLang}}})),he=()=>console.warn("`initialize` is depreciated and should be removed from code (workers now come pre-initialized)"),V=(p,x,R,S)=>L(G({id:S,action:"initialize",payload:{langs:p,oem:x,config:R}})),ue=(p="eng",x,R,S)=>{if(g&&[te.TESSERACT_ONLY,te.TESSERACT_LSTM_COMBINED].includes(x))throw Error("Legacy model requested but code missing.");const I=x||c;c=I;const T=R||u;u=T;const K=(typeof p=="string"?p.split("+"):p).filter(J=>!h.includes(J));return h.push(...K),K.length>0?X(K,S).then(()=>V(p,I,T,S)):V(p,I,T,S)},ge=(p={},x)=>L(G({id:x,action:"setParameters",payload:{params:p}})),me=async(p,x={},R={blocks:!0,text:!0,hocr:!0,tsv:!0},S)=>L(G({id:S,action:"recognize",payload:{image:await Ce(p),options:x,output:R}})),f=(p="Tesseract OCR Result",x=!1,R)=>(console.log("`getPDF` function is depreciated. `recognize` option `savePDF` should be used instead."),L(G({id:R,action:"getPDF",payload:{title:p,textonly:x}}))),m=async(p,x)=>{if(g)throw Error("`worker.detect` requires Legacy model, which was not loaded.");return L(G({id:x,action:"detect",payload:{image:await Ce(p)}}))},w=async()=>(b!==null&&($t(b),b=null),Promise.resolve());Pt(b,({workerId:p,jobId:x,status:R,action:S,data:I})=>{const T=`${S}-${x}`;if(R==="resolve"){Te(`[${p}]: Complete ${x}`);let Z=I;S==="recognize"?Z=Rt(I):S==="getPDF"&&(Z=Array.from({...I,length:Object.keys(I).length})),a[T]({jobId:x,data:Z})}else if(R==="reject")if(d[T](I),S==="load"&&y(I),r)r(I);else throw Error(I);else R==="progress"&&s({...I,userJobId:x})});const _={id:o,worker:b,setResolve:$,setReject:O,load:z,writeText:D,readText:j,removeFile:ae,FS:k,loadLanguage:q,initialize:he,reinitialize:ue,setParameters:ge,recognize:me,getPDF:f,detect:m,terminate:w};return C().then(()=>X(i)).then(()=>V(i,e,n)).then(()=>v(_)).catch(()=>{}),E};const De=Ae,Ct=async(i,e,t)=>{const n=await De(e,1,t);return n.recognize(i).finally(async()=>{await n.terminate()})},Ft=async(i,e)=>{const t=await De("osd",0,e);return t.detect(i).finally(async()=>{await t.terminate()})};var Nt={recognize:Ct,detect:Ft},zt={AFR:"afr",AMH:"amh",ARA:"ara",ASM:"asm",AZE:"aze",AZE_CYRL:"aze_cyrl",BEL:"bel",BEN:"ben",BOD:"bod",BOS:"bos",BUL:"bul",CAT:"cat",CEB:"ceb",CES:"ces",CHI_SIM:"chi_sim",CHI_TRA:"chi_tra",CHR:"chr",CYM:"cym",DAN:"dan",DEU:"deu",DZO:"dzo",ELL:"ell",ENG:"eng",ENM:"enm",EPO:"epo",EST:"est",EUS:"eus",FAS:"fas",FIN:"fin",FRA:"fra",FRK:"frk",FRM:"frm",GLE:"gle",GLG:"glg",GRC:"grc",GUJ:"guj",HAT:"hat",HEB:"heb",HIN:"hin",HRV:"hrv",HUN:"hun",IKU:"iku",IND:"ind",ISL:"isl",ITA:"ita",ITA_OLD:"ita_old",JAV:"jav",JPN:"jpn",KAN:"kan",KAT:"kat",KAT_OLD:"kat_old",KAZ:"kaz",KHM:"khm",KIR:"kir",KOR:"kor",KUR:"kur",LAO:"lao",LAT:"lat",LAV:"lav",LIT:"lit",MAL:"mal",MAR:"mar",MKD:"mkd",MLT:"mlt",MSA:"msa",MYA:"mya",NEP:"nep",NLD:"nld",NOR:"nor",ORI:"ori",PAN:"pan",POL:"pol",POR:"por",PUS:"pus",RON:"ron",RUS:"rus",SAN:"san",SIN:"sin",SLK:"slk",SLV:"slv",SPA:"spa",SPA_OLD:"spa_old",SQI:"sqi",SRP:"srp",SRP_LATN:"srp_latn",SWA:"swa",SWE:"swe",SYR:"syr",TAM:"tam",TEL:"tel",TGK:"tgk",TGL:"tgl",THA:"tha",TIR:"tir",TUR:"tur",UIG:"uig",UKR:"ukr",URD:"urd",UZB:"uzb",UZB_CYRL:"uzb_cyrl",VIE:"vie",YID:"yid"},Bt={OSD_ONLY:"0",AUTO_OSD:"1",AUTO_ONLY:"2",AUTO:"3",SINGLE_COLUMN:"4",SINGLE_BLOCK_VERT_TEXT:"5",SINGLE_BLOCK:"6",SINGLE_LINE:"7",SINGLE_WORD:"8",CIRCLE_WORD:"9",SINGLE_CHAR:"10",SPARSE_TEXT:"11",SPARSE_TEXT_OSD:"12",RAW_LINE:"13"};const At=Ze,Dt=Ae,jt=Nt,kt=zt,Ut=Be,Gt=Bt,{setLogging:Yt}=le;var Ht={languages:kt,OEM:Ut,PSM:Gt,createScheduler:At,createWorker:Dt,setLogging:Yt,...jt};const Ee=He(Ht);ee.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";class Wt{constructor(){this.initialized=!1,this.worker=null}async initialize(e){if(!this.initialized)try{e==null||e({status:"loading",message:"Loading Tesseract OCR engine...",progress:10}),this.worker=await Ee.createWorker("eng",1,{logger:t=>{t.status==="loading tesseract core"?e==null||e({status:"loading",message:"Loading OCR core...",progress:30}):t.status==="loading language traineddata"?e==null||e({status:"loading",message:"Loading English language model...",progress:60}):t.status==="initialized tesseract"&&(e==null||e({status:"loading",message:"Initializing OCR engine...",progress:90}))},errorHandler:t=>{console.error("Tesseract error:",t)}}),await this.worker.setParameters({tessedit_ocr_engine_mode:Ee.OEM.LSTM_ONLY,preserve_interword_spaces:"1",tessedit_pageseg_mode:Ee.PSM.AUTO}),this.initialized=!0,e==null||e({status:"ready",message:"Tesseract OCR engine loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize Tesseract:",t),t}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.worker.recognize(e);return this.formatResults(t)}formatResults(e){const t=[];for(const o of e.data.words)o.confidence>30&&t.push({box:[[o.bbox.x0,o.bbox.y0],[o.bbox.x1,o.bbox.y0],[o.bbox.x1,o.bbox.y1],[o.bbox.x0,o.bbox.y1]],text:o.text,confidence:o.confidence/100});return this.groupWordsIntoLines(t)}groupWordsIntoLines(e){if(e.length===0)return[];e.sort((o,s)=>o.box[0][1]-s.box[0][1]);const t=[];let n={words:[e[0]],minY:e[0].box[0][1],maxY:e[0].box[2][1]};for(let o=1;o<e.length;o++){const s=e[o],r=s.box[0][1];r<=n.maxY&&r>=n.minY-5?(n.words.push(s),n.minY=Math.min(n.minY,r),n.maxY=Math.max(n.maxY,s.box[2][1])):(t.push(this.mergeLine(n)),n={words:[s],minY:r,maxY:s.box[2][1]})}return n.words.length>0&&t.push(this.mergeLine(n)),t}mergeLine(e){e.words.sort((a,d)=>a.box[0][0]-d.box[0][0]);const t=Math.min(...e.words.map(a=>a.box[0][0])),n=Math.max(...e.words.map(a=>a.box[1][0])),o=Math.min(...e.words.map(a=>a.box[0][1])),s=Math.max(...e.words.map(a=>a.box[2][1])),r=e.words.map(a=>a.text).join(" "),l=e.words.reduce((a,d)=>a+d.confidence,0)/e.words.length;return{box:[[t,o],[n,o],[n,s],[t,s]],text:r,confidence:l}}async processPDF(e){const t=await e.arrayBuffer(),n=await ee.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const l=await n.getPage(r),a=l.getViewport({scale:2}),d=document.createElement("canvas"),h=d.getContext("2d");d.width=a.width,d.height=a.height,await l.render({canvasContext:h,viewport:a}).promise;const c=await new Promise(y=>d.toBlob(y,"image/png")),u=await this.worker.recognize(c),g=this.formatResults(u);s.push({page:r,results:g})}return s}async cleanup(){this.worker&&(await this.worker.terminate(),this.worker=null,this.initialized=!1)}}const ne=new Wt,W={detection:{det_limit_side_len:1920,det_db_thresh:.15,det_db_box_thresh:.2,det_db_unclip_ratio:2,det_db_min_size:5,det_db_max_candidates:3e3,grid_size:8,min_area_thresh:10},recognition:{rec_batch_num:16,drop_score:.3}};function qt(i){i.CONFIG.det_limit_side_len=W.detection.det_limit_side_len,i.CONFIG.det_db_thresh=W.detection.det_db_thresh,i.CONFIG.det_db_box_thresh=W.detection.det_db_box_thresh,i.CONFIG.det_db_unclip_ratio=W.detection.det_db_unclip_ratio,i.CONFIG.det_db_min_size=W.detection.det_db_min_size,i.CONFIG.det_db_max_candidates=W.detection.det_db_max_candidates,i.CONFIG.grid_size=W.detection.grid_size,i.CONFIG.min_area_thresh=W.detection.min_area_thresh,i.CONFIG.rec_batch_num=W.recognition.rec_batch_num,i.CONFIG.drop_score=W.recognition.drop_score,console.log("PaddleOCR configuration updated for infographic processing")}ee.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";let se=null,P="tesseract",A="improved",B=ne,fe=!1;Object.defineProperty(window,"currentEngine",{get:()=>P,set:i=>{console.warn("Attempted to set currentEngine directly. Use handleEngineChange instead.")}});const Se=document.getElementById("fileInput"),oe=document.getElementById("uploadArea"),je=document.getElementById("previewSection"),Y=document.getElementById("previewImage"),Xt=document.getElementById("processBtn"),ve=document.getElementById("resultsSection"),Le=document.getElementById("loadingIndicator"),ce=document.getElementById("ocrResults"),Vt=document.getElementById("copyBtn"),Kt=document.getElementById("downloadBtn"),Jt=document.getElementById("resetBtn");async function Zt(){var i,e;console.log("Initializing OCR engines..."),F("Loading OCR engines...","info");try{await Promise.all([re.initialize(n=>{P==="paddle"&&A==="improved"&&F(n.message,n.status==="ready"?"success":"info");const o=document.querySelector("#loadingIndicator p");o&&n.progress!==void 0&&P==="paddle"&&A==="improved"&&(o.textContent=`${n.message} (${n.progress}%)`)}),Q.initialize(n=>{P==="paddle"&&A==="standard"&&F(n.message,n.status==="ready"?"success":"info")}),ne.initialize(n=>{P==="tesseract"&&F(n.message,n.status==="ready"?"success":"info")})]),console.log("OCR engines loaded successfully!"),F("Ready to process images","success"),Qt();const t=document.querySelector('input[name="ocrEngine"]:checked');t&&(P=t.value,P==="paddle"?(B=A==="improved"?re:Q,document.getElementById("paddleOptions").style.display="block"):(B=ne,document.getElementById("paddleOptions").style.display="none"),console.log("Initial engine set to:",P),console.log("Initial OCR engine object:",B))}catch(t){if(console.error("Failed to initialize OCR engines:",t),(i=t.message)!=null&&i.includes("onnx")||(e=t.message)!=null&&e.includes("ONNX")?H("Failed to load PaddleOCR models. This may be due to browser compatibility issues. Please try using Tesseract.js instead."):H("Failed to load OCR engines. Please check your internet connection and refresh the page."),ne.initialized){F("Tesseract.js is ready. PaddleOCR failed to load.","warning"),P="tesseract",B=ne;const n=document.getElementById("engineTesseract");n&&(n.checked=!0)}}}function Qt(){oe.addEventListener("click",()=>Se.click()),Se.addEventListener("change",nn),oe.addEventListener("dragover",on),oe.addEventListener("dragleave",sn),oe.addEventListener("drop",rn),Xt.addEventListener("click",an),Vt.addEventListener("click",dn),Kt.addEventListener("click",ln),Jt.addEventListener("click",hn),document.querySelectorAll('input[name="ocrEngine"]').forEach(e=>{console.log("Adding event listener to radio:",e.value,e),e.addEventListener("change",en)});const i=document.querySelector('input[name="ocrEngine"]:checked');console.log("Initial checked engine:",i==null?void 0:i.value),document.querySelectorAll('input[name="preprocessing"]').forEach(e=>{e.addEventListener("change",tn)}),document.getElementById("detectionModel").addEventListener("change",Me),document.getElementById("recognitionModel").addEventListener("change",Me),document.getElementById("dictionary").addEventListener("change",Me),document.getElementById("infographicMode").addEventListener("change",pn)}async function en(i){const e=i.target.value;console.log("Engine change event - new value:",e),console.log("Engine change event - old currentEngine:",P),P=e,P==="paddle"?(B=A==="improved"?re:Q,console.log("Set currentOCREngine to PaddleOCR:",A),console.log("Verify currentOCREngine:",B)):(B=ne,console.log("Set currentOCREngine to Tesseract"));const t=document.getElementById("paddleOptions");t.style.display=P==="paddle"?"block":"none",F(`Switched to ${P==="paddle"?"PaddleOCR":"Tesseract.js"}`,"info"),console.log("Final currentEngine:",P),console.log("Final currentOCREngine:",B)}async function tn(i){if(A=i.target.value,P==="paddle"){if(B=A==="improved"?re:Q,A==="standard"){const e=document.getElementById("detectionModel").value,t=document.getElementById("recognitionModel").value,n=document.getElementById("dictionary").value;Q.setModelConfig({detection:e,recognition:t,dictionary:n}),F("Loading standard preprocessing models...","info");try{await Q.initialize(o=>{F(o.message,o.status==="ready"?"success":"info")}),F("Standard preprocessing ready!","success")}catch(o){console.error("Failed to initialize standard preprocessing:",o),H("Failed to load standard preprocessing models"),A="improved",B=re,document.getElementById("preprocessImproved").checked=!0}}F(`Switched to ${A==="improved"?"Improved (PPU)":"Standard"} preprocessing`,"info")}}async function Me(){if(P!=="paddle")return;const i=document.getElementById("detectionModel").value,e=document.getElementById("recognitionModel").value,t=document.getElementById("dictionary").value;A==="improved"?re.setModelConfig({detection:i,recognition:e,dictionary:t}):Q.setModelConfig({detection:i,recognition:e,dictionary:t}),F("Loading new models...","info");try{await B.initialize(n=>{F(n.message,n.status==="ready"?"success":"info")}),F("Models updated successfully!","success")}catch(n){console.error("Failed to load new models:",n),H("Failed to load new models. Please try again.")}}function nn(i){const e=i.target.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?ke(e):H("Please select a valid image or PDF file")}function on(i){i.preventDefault(),oe.classList.add("dragover")}function sn(i){i.preventDefault(),oe.classList.remove("dragover")}function rn(i){i.preventDefault(),oe.classList.remove("dragover");const e=i.dataTransfer.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?ke(e):H("Please drop a valid image or PDF file")}async function ke(i){if(se){const e=Y.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),se=null}if(ce.innerHTML="",ve.style.display="none",se=i,je.style.display="block",ve.style.display="none",i.type==="application/pdf"){Y.style.display="none";const e=Y.parentElement;e.innerHTML="";const t=document.createElement("div");t.className="pdf-preview",t.innerHTML=`
            <div class="pdf-header">
                <h3>${i.name}</h3>
                <p class="pdf-info">Loading PDF preview...</p>
            </div>
            <div class="pdf-pages" id="pdfPages"></div>
        `,e.appendChild(t);try{const n=await i.arrayBuffer(),o=await ee.getDocument({data:n}).promise,s=o.numPages,r=t.querySelector(".pdf-info");r.textContent=`${s} page${s>1?"s":""}`;const l=document.getElementById("pdfPages"),a=Math.min(s,3);for(let d=1;d<=a;d++){const h=await o.getPage(d),c=h.getViewport({scale:.5}),u=document.createElement("div");u.className="pdf-page-preview";const g=document.createElement("canvas"),y=g.getContext("2d");g.height=c.height,g.width=c.width;const v={canvasContext:y,viewport:c};await h.render(v).promise,u.innerHTML=`<p>Page ${d}</p>`,u.appendChild(g),l.appendChild(u)}s>3&&(l.innerHTML+=`<p class="more-pages">... and ${s-3} more pages</p>`)}catch(n){console.error("Error rendering PDF preview:",n),t.querySelector(".pdf-info").textContent="Error loading PDF preview"}}else{const e=document.querySelector(".pdf-placeholder");e&&e.remove(),Y.style.display="block";const t=URL.createObjectURL(i);Y.src=t,Y.onload=()=>{F('Image loaded. Click "Extract Text" to process.',"success")},Y.onerror=()=>{URL.revokeObjectURL(t),H("Failed to load image")}}}async function an(){if(!se){H("Please upload an image first");return}ve.style.display="block",Le.style.display="flex",ce.innerHTML="";const i=document.querySelector("#loadingIndicator p");let e=P==="paddle"?"PaddleOCR":"Tesseract.js";P==="paddle"&&(e+=` (${A==="improved"?"Improved PPU":"Standard"})`),i&&(i.textContent=`Processing image with ${e}...`);try{console.log(`Processing image with ${e}...`),console.log("Current engine variable:",P),console.log("Current OCR engine object:",B),console.log("Current OCR engine name:",B.constructor.name),F("Detecting and recognizing text...","info");const t=performance.now();P==="paddle"&&B===ne&&(console.error("Engine mismatch detected! Expected PaddleOCR but got Tesseract"),B=A==="improved"?re:Q,console.log("Forced engine to:",B));const n=await B.process(se),o=performance.now()-t;console.log(`Processing completed in ${o.toFixed(2)}ms`),console.log("OCR Results:",n),Le.style.display="none",n&&n.length>0?(Ne(n,o,e),F(`Text extraction complete! Found ${n.length} text regions.`,"success")):(Ne([],o,e),F("No text found in the image","warning"))}catch(t){if(console.error("OCR processing error:",t),console.error("Error code:",t.code),Le.style.display="none",P==="paddle"&&(t.code===30757872||t.message.includes("30757872"))){if(H("PaddleOCR failed: ONNX Runtime error. The PP-OCRv5 model appears to be incompatible with your browser."),F("Consider using Tesseract.js for better compatibility","warning"),confirm("PaddleOCR failed due to browser compatibility. Would you like to switch to Tesseract.js?")){const o=document.getElementById("engineTesseract");o&&(o.checked=!0,o.dispatchEvent(new Event("change")))}}else H("Failed to process image: "+t.message)}}function Ne(i,e,t="PaddleOCR"){var s;const n=Array.isArray(i)&&((s=i[0])==null?void 0:s.page)!==void 0,o=P==="paddle"&&i.length>0&&i[0]&&i[0].box;if(console.log("Display check - currentEngine:",P,"isPaddleWithBoxes:",o,"results:",i),n){let r="",l=0,a="";i.forEach(d=>{const h=d.results.map(c=>c.text).join(`
`);r+=`
--- Page ${d.page} ---
${h}
`,l+=d.results.length,a+=`
                <div class="page-results">
                    <h4>Page ${d.page}</h4>
                    <ul class="detection-list">
                        ${d.results.map((c,u)=>`
                            <li data-index="${u}">
                                <span class="detection-index">${u+1}.</span>
                                <span class="detection-text">${ie(c.text)}</span>
                                <span class="detection-confidence">${(c.confidence*100).toFixed(1)}%</span>
                            </li>
                        `).join("")}
                    </ul>
                </div>
            `}),ce.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Pages Processed:</strong> ${i.length}</p>
                <p><strong>Total Text Regions:</strong> ${l}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${ie(r||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details by Page:</h3>
                ${a}
            </div>
        `}else if(o)cn(i,e,t);else{const r=i.map(l=>l.text).join(`
`);ce.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Text Regions Found:</strong> ${i.length}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${ie(r||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details:</h3>
                <ul class="detection-list">
                    ${i.map((l,a)=>`
                        <li>
                            <span class="detection-index">${a+1}.</span>
                            <span class="detection-text">${ie(l.text)}</span>
                            <span class="detection-confidence">${(l.confidence*100).toFixed(1)}%</span>
                        </li>
                    `).join("")}
                </ul>
            </div>
        `}}function cn(i,e,t){const n=i.map(s=>s.text).join(`
`),o=mn(i);ce.innerHTML=`
        <div class="ocr-stats">
            <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
            <p><strong>Text Regions Found:</strong> ${i.length}</p>
            <p><strong>Engine:</strong> ${t}</p>
            <p><strong>Average Confidence:</strong> ${gn(i)}%</p>
        </div>
        
        <div class="paddle-results-container">
            <div class="result-tabs">
                <button class="result-tab active" onclick="showResultTab('visual')">Visual Results</button>
                <button class="result-tab" onclick="showResultTab('text')">Text Only</button>
                <button class="result-tab" onclick="showResultTab('grouped')">Grouped by Line</button>
            </div>
            
            <div id="visualResults" class="tab-content active">
                <div class="result-image-container">
                    <img id="resultImage" src="${Y.src}" alt="OCR Result">
                    <div class="bounding-box-overlay" id="boundingBoxOverlay"></div>
                </div>
                <div class="detection-results">
                    <h3>Detected Text Regions:</h3>
                    <ul class="detection-list" id="visualDetectionList">
                        ${i.map((s,r)=>{const l=Ue(s.confidence);return`
                                <li data-index="${r}" onmouseover="highlightBox(${r})" onmouseout="unhighlightBox(${r})" onclick="selectBox(${r})">
                                    <span class="detection-index">${r+1}.</span>
                                    <span class="detection-text">${ie(s.text)}</span>
                                    <span class="detection-confidence ${l}">${(s.confidence*100).toFixed(1)}%</span>
                                </li>
                            `}).join("")}
                    </ul>
                </div>
            </div>
            
            <div id="textResults" class="tab-content grouped-results">
                <div class="text-result">
                    <h3>Extracted Text:</h3>
                    <div class="text-content" id="extractedText">${ie(n||"No text detected")}</div>
                </div>
            </div>
            
            <div id="groupedResults" class="tab-content grouped-results">
                <h3>Text Grouped by Line:</h3>
                ${o.map((s,r)=>`
                    <div class="text-region-group">
                        <div class="region-header">
                            <span class="region-title">Line ${r+1}</span>
                            <div class="region-confidence">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${s.avgConfidence}%"></div>
                                </div>
                                <span class="confidence-text">${s.avgConfidence.toFixed(1)}%</span>
                            </div>
                        </div>
                        <p>${ie(s.text)}</p>
                    </div>
                `).join("")}
            </div>
        </div>
    `,setTimeout(()=>Ge(i),100)}async function dn(){const i=document.getElementById("extractedText");if(i)try{await navigator.clipboard.writeText(i.textContent),un("Text copied to clipboard!")}catch{H("Failed to copy text")}}function ln(){const i=document.getElementById("extractedText");if(i){const e=i.textContent,t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`pp-ocrv5-result-${Date.now()}.txt`,o.click(),URL.revokeObjectURL(n)}}function hn(){if(se){const e=Y.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),se=null}Se.value="",je.style.display="none",ve.style.display="none",ce.innerHTML="",Y.src="";const i=Y.parentElement;i.innerHTML='<img id="previewImage" alt="Preview">',window.previewImage=document.getElementById("previewImage"),F("Ready to process a new image","info")}function ie(i){const e=document.createElement("div");return e.textContent=i,e.innerHTML}function H(i){F(i,"error");const e=document.createElement("div");e.className="toast error",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},5e3)}function un(i){const e=document.createElement("div");e.className="toast success",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}function F(i,e="info"){console.log(`[${e.toUpperCase()}] ${i}`);const t=document.getElementById("status");t&&(t.textContent=i,t.className=`status ${e}`)}function gn(i){return i.length===0?0:(i.reduce((t,n)=>t+n.confidence,0)/i.length*100).toFixed(1)}function Ue(i){const e=i*100;return e>=80?"high-confidence":e>=60?"medium-confidence":"low-confidence"}function mn(i){if(i.length===0)return[];const e=[...i].sort((o,s)=>{const r=Math.min(...o.box.map(a=>a[1])),l=Math.min(...s.box.map(a=>a[1]));return r-l}),t=[];let n=[e[0]];for(let o=1;o<e.length;o++){const s=Math.min(...e[o-1].box.map(l=>l[1])),r=Math.min(...e[o].box.map(l=>l[1]));Math.abs(r-s)<20?n.push(e[o]):(t.push(n),n=[e[o]])}return n.length>0&&t.push(n),t.map(o=>{o.sort((l,a)=>{const d=Math.min(...l.box.map(c=>c[0])),h=Math.min(...a.box.map(c=>c[0]));return d-h});const s=o.map(l=>l.text).join(" "),r=o.reduce((l,a)=>l+a.confidence,0)/o.length*100;return{text:s,avgConfidence:r,items:o}})}function Ge(i){const e=document.getElementById("boundingBoxOverlay"),t=document.getElementById("resultImage");if(!e||!t)return;if(e.innerHTML="",!t.complete){t.onload=()=>Ge(i);return}const n=t.getBoundingClientRect(),o=t.naturalWidth/n.width,s=t.naturalHeight/n.height;i.forEach((r,l)=>{const a=r.box,d=Math.min(...a.map(v=>v[0]))/o,h=Math.min(...a.map(v=>v[1]))/s,c=Math.max(...a.map(v=>v[0]))/o,u=Math.max(...a.map(v=>v[1]))/s,g=document.createElement("div");g.className=`text-box ${Ue(r.confidence)}`,g.dataset.index=l,g.style.left=`${d}px`,g.style.top=`${h}px`,g.style.width=`${c-d}px`,g.style.height=`${u-h}px`;const y=document.createElement("div");y.className="text-box-label",y.textContent=`${l+1}: ${(r.confidence*100).toFixed(0)}%`,g.appendChild(y),g.onclick=()=>selectBox(l),e.appendChild(g)})}window.showResultTab=function(i){document.querySelectorAll(".result-tab").forEach(e=>{e.classList.remove("active")}),event.target.classList.add("active"),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")}),i==="visual"?document.getElementById("visualResults").classList.add("active"):i==="text"?document.getElementById("textResults").classList.add("active"):i==="grouped"&&document.getElementById("groupedResults").classList.add("active")};window.highlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.add("hover"),t&&t.classList.add("highlighted")};window.unhighlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.remove("hover"),t&&t.classList.remove("highlighted")};window.selectBox=function(i){document.querySelectorAll(".text-box.selected").forEach(t=>{t.classList.remove("selected")});const e=document.querySelector(`.text-box[data-index="${i}"]`);if(e){e.classList.add("selected");const t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlighted"),setTimeout(()=>t.classList.remove("highlighted"),2e3))}};function pn(i){fe=i.target.checked,console.log("Infographic mode:",fe?"enabled":"disabled"),fe&&P==="paddle"?(qt(B),F("Infographic mode enabled - optimized for complex layouts","info")):!fe&&P==="paddle"&&F("Infographic mode disabled","info")}document.addEventListener("DOMContentLoaded",Zt);
//# sourceMappingURL=index-BWP8YSv7.js.map
