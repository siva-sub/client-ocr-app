import{b as le,F as ye,H as ve}from"./onnxruntime-CqRzMC93.js";import{p as te,c as qe,g as Xe}from"./pdfjs-BhC3vFUT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();te.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";le.wasm.wasmPaths="/client-ocr-app/assets/";le.wasm.numThreads=1;le.webgl.pack=!1;le.webgl.matmulMaxBatchSize=16;const _e="/client-ocr-app/models/",Ve={det_limit_side_len:1280,det_limit_type:"max",det_db_thresh:.05,det_db_box_thresh:.1,det_db_unclip_ratio:2.5,det_db_min_size:2,det_db_max_candidates:2e3,det_use_dilation:!0,det_dilation_kernel:3,rec_image_height:48,rec_image_width:320,rec_batch_num:6,drop_score:.05,det_mean:[.485,.456,.406],det_std:[.229,.224,.225],rec_mean:.5,rec_std:.5,min_area_thresh:2,vertical_gap_threshold:.5,english_mode:!0,min_word_confidence:.1,enable_word_splitting:!0,grid_size:16,overlap_ratio:.2};class Ke{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"en_PP-OCRv4_mobile_rec_infer.onnx",dictionary:"en_dict.txt"},this.CONFIG=Ve}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release();const n=["webgl","wasm"];let o=null;for(const r of n)try{console.log(`Trying to load detection model with ${r} provider...`),this.detectionSession=await ye.create(_e+this.modelConfig.detection,{executionProviders:[r],graphOptimizationLevel:"all",enableCpuMemArena:!1,enableMemPattern:!1}),console.log(`Detection model loaded successfully with ${r}:`,this.detectionSession.inputNames,this.detectionSession.outputNames);break}catch(l){if(console.warn(`Failed to load with ${r}:`,l.message),o=l,r===n[n.length-1])throw o}const s=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${s}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release();for(const r of n)try{console.log(`Trying to load recognition model with ${r} provider...`),this.recognitionSession=await ye.create(_e+this.modelConfig.recognition,{executionProviders:[r],graphOptimizationLevel:"all",enableCpuMemArena:!1,enableMemPattern:!1}),console.log(`Recognition model loaded successfully with ${r}:`,this.recognitionSession.inputNames,this.recognitionSession.outputNames);break}catch(l){if(console.warn(`Failed to load recognition with ${r}:`,l.message),o=l,r===n[n.length-1])throw o}this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR ready!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(_e+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(console.log("Processing blob type:",e.type,"size:",e.size),e.type==="application/pdf")return await this.processPDF(e);console.log("Converting blob to image...");const t=await this.blobToImage(e);console.log("Image loaded:",t.width,"x",t.height);const n=await this.detectText(t),o=await this.recognizeText(t,n);return this.mergeTextLines(o)}async detectText(e){var t,n;if(console.log("detectText called, checking detection session..."),!this.detectionSession)throw new Error("Detection model not loaded");console.log("Detection session exists:",this.detectionSession),console.log("Current dictionary:",this.modelConfig.dictionary,"Dictionary length:",this.charDict.length);try{console.log("Starting image resize...");const{resizedImage:o,ratio:s}=await this.resizeForDetection(e);console.log("Image resized, ratio:",s),console.log("Starting preprocessing...");const r=await this.preprocessForDetection(o);console.log("Preprocessing complete, tensor shape:",r.dims),console.log("Running detection model..."),console.log("Input names:",this.detectionSession.inputNames),console.log("Output names:",this.detectionSession.outputNames);const l={[this.detectionSession.inputNames[0]]:r};let a;try{console.log("Tensor data type:",r.type),console.log("Tensor size:",r.data.length),console.log("Tensor shape:",r.dims),console.log("Expected input name:",this.detectionSession.inputNames[0]);try{const v=this.detectionSession.inputNames.map(E=>({name:E}));console.log("Model inputs:",v)}catch{console.log("Could not get model input info")}const h=r.data;let c=0,u=0,m=1/0,y=-1/0;for(let v=0;v<h.length;v++)isNaN(h[v])&&c++,isFinite(h[v])||u++,m=Math.min(m,h[v]),y=Math.max(y,h[v]);console.log(`Tensor stats: min=${m.toFixed(3)}, max=${y.toFixed(3)}`),(c>0||u>0)&&console.error(`Invalid tensor data: ${c} NaN values, ${u} Inf values`),a=await this.detectionSession.run(l),console.log("Detection complete"),console.log("Output shape:",a[this.detectionSession.outputNames[0]].dims)}catch(h){if(console.error("ONNX inference error:",h),console.error("Error code:",h.code),console.error("Error message:",h.message),console.error("Error stack:",h.stack),h.code===30757872||(t=h.message)!=null&&t.includes("invalid graph")||(n=h.message)!=null&&n.includes("dimension mismatch")){console.error("Model compatibility issue detected. The model might require specific input dimensions."),console.error("Trying simplified approach...");try{const c=await this.simplifiedDetection(o,s);return console.log(`Simplified detection found ${c.length} regions`),c}catch(c){console.error("Simplified detection also failed:",c)}}throw h}const d=await this.postprocessDetection(a[this.detectionSession.outputNames[0]],o.width,o.height,s);return console.log(`Detected ${d.length} text regions`),this.sortBoxes(d)}catch(o){return console.error("Error in detectText:",o),console.error("Error details:",{message:o.message,stack:o.stack,name:o.name,code:o.code}),[]}}async resizeForDetection(e){try{console.log("resizeForDetection - input image size:",e.width,"x",e.height);const t=this.CONFIG.det_limit_side_len,n=this.CONFIG.det_limit_type;let o=e.width,s=e.height,r=1;n==="max"?Math.max(s,o)>t&&(r=s>o?t/s:t/o):Math.min(s,o)<t&&(r=s<o?t/s:t/o),o=Math.round(o*r),s=Math.round(s*r);const l=this.CONFIG.grid_size||32,a=Math.max(l,Math.round(o/l)*l),d=Math.max(l,Math.round(s/l)*l);if(console.log(`Resizing from ${e.width}x${e.height} to ${a}x${d} (ratio: ${r})`),a<=0||d<=0||!isFinite(a)||!isFinite(d))throw new Error(`Invalid target dimensions: ${a}x${d}`);const h=await this.preprocessImage(e,a,d),c=new Image;return new Promise(u=>{this.canvas.toBlob(m=>{const y=URL.createObjectURL(m);c.onload=()=>{URL.revokeObjectURL(y),u({resizedImage:c,ratio:r})},c.src=y})})}catch(t){throw console.error("Error in resizeForDetection:",t),t}}async preprocessImage(e,t,n){this.canvas.width=t,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,t,n),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high";const o=Math.min(t/e.width,n/e.height),s=e.width*o,r=e.height*o,l=(t-s)/2,a=(n-r)/2;this.ctx.drawImage(e,l,a,s,r);const d=this.ctx.getImageData(0,0,t,n),h=d.data;for(let c=0;c<h.length;c+=4){let m=(.299*h[c]+.587*h[c+1]+.114*h[c+2]-128)*1.2+128;m>240?m=255:m<15&&(m=0),m=Math.max(0,Math.min(255,m)),h[c]=m,h[c+1]=m,h[c+2]=m}return this.ctx.putImageData(d,0,0),this.canvas}async preprocessForDetection(e){try{this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data;console.log(`Preprocessing image: ${e.width}x${e.height}`);const o=e.width*e.height,s=new Float32Array(3*o),r=this.CONFIG.det_mean||[.485,.456,.406],l=this.CONFIG.det_std||[.229,.224,.225];for(let d=0;d<o;d++){const h=d*4,c=Math.max(0,Math.min(255,n[h])),u=Math.max(0,Math.min(255,n[h+1])),m=Math.max(0,Math.min(255,n[h+2]));s[d]=(c/255-r[0])/l[0],s[o+d]=(u/255-r[1])/l[1],s[2*o+d]=(m/255-r[2])/l[2]}for(let d=0;d<s.length;d++)isFinite(s[d])||(console.error(`Invalid value at index ${d}: ${s[d]}`),s[d]=0);const a=new ve("float32",s,[1,3,e.height,e.width]);return console.log("Created tensor with shape:",a.dims,"type:",a.type),a}catch(t){throw console.error("Error in preprocessForDetection:",t),new Error(`Preprocessing failed: ${t.message}`)}}async postprocessDetection(e,t,n,o){try{let s,r,l;if(e.dims.length===4){const[_,P,C,O]=e.dims;s=C,r=O,l=e.data}else if(e.dims.length===3){const[_,P,C]=e.dims;s=P,r=C,l=e.data}else throw new Error(`Unexpected output tensor dimensions: ${e.dims}`);console.log(`Detection output shape: ${s}x${r}, total pixels: ${s*r}`),console.log("Output tensor dims:",e.dims),console.log("Data length:",l.length);const a=new Float32Array(s*r);for(let _=0;_<s*r;_++)a[_]=1/(1+Math.exp(-l[_]));const d=new Uint8Array(s*r);let h=0;for(let _=0;_<s*r;_++)d[_]=a[_]>this.CONFIG.det_db_thresh?255:0,d[_]===255&&h++;console.log(`Detected pixels: ${h} out of ${s*r} (${(h/(s*r)*100).toFixed(2)}%)`),console.log(`Detection threshold: ${this.CONFIG.det_db_thresh}`);const c=[];for(let _=0;_<Math.min(10,a.length);_+=Math.floor(a.length/10))c.push(a[_].toFixed(3));console.log("Sample probability values:",c);const u=[],m=new Set;let y=0,v=0,E=0,L=0;for(let _=0;_<s&&y<this.CONFIG.det_db_max_candidates;_++)for(let P=0;P<r&&y<this.CONFIG.det_db_max_candidates;P++){const C=_*r+P;if(d[C]===255&&!m.has(C)){const O=this.findConnectedComponent(d,r,s,P,_,m,a);if(O)if(v++,O.score>=this.CONFIG.det_db_box_thresh){O.points=O.points.map(F=>[Math.round(F[0]/o),Math.round(F[1]/o)]);const z=this.calculatePolygonArea(O.points);z>this.CONFIG.min_area_thresh?(u.push(O),y++):(L++,console.log(`Component rejected by area: ${z} < ${this.CONFIG.min_area_thresh}`))}else E++,console.log(`Component rejected by score: ${O.score.toFixed(3)} < ${this.CONFIG.det_db_box_thresh}`)}}return console.log(`Detection summary: ${v} components found, ${y} accepted, ${E} rejected by score, ${L} rejected by area`),u}catch(s){throw console.error("Error in postprocessDetection:",s),new Error(`Detection post-processing failed: ${s.message}`)}}findConnectedComponent(e,t,n,o,s,r,l){const a=[[o,s]],d=[];let h=0,c=0;const u=1e4,m=s*t+o;if(r.has(m)||e[m]!==255)return null;const y=new Set;for(y.add(m);a.length>0&&d.length<u;){const[F,D]=a.pop(),A=D*t+F;if(!r.has(A)&&(r.add(A),e[A]===255)){d.push([F,D]),h+=l[A],c++;const ce=[[F,D-1],[F,D+1],[F-1,D],[F+1,D]];for(const[G,W]of ce)if(G>=0&&G<t&&W>=0&&W<n){const q=W*t+G;if(!r.has(q)&&e[q]===255){const ue=Math.abs(W-s),X=Math.abs(G-o);(ue<n*.05||X<t*.3)&&(a.push([G,W]),y.add(q))}}}}if(d.length<this.CONFIG.det_db_min_size)return null;const v=d.map(F=>F[0]),E=d.map(F=>F[1]);let L=Math.min(...v),_=Math.max(...v),P=Math.min(...E),C=Math.max(...E);this.CONFIG.det_db_unclip_ratio;const O=(_-L)*.1,z=(C-P)*.2;return L=Math.max(0,L-O),_=Math.min(t-1,_+O),P=Math.max(0,P-z),C=Math.min(n-1,C+z),{points:[[L,P],[_,P],[_,C],[L,C]],score:h/c}}calculatePolygonArea(e){let t=0;const n=e.length;for(let o=0;o<n;o++){const s=(o+1)%n;t+=e[o][0]*e[s][1],t-=e[s][0]*e[o][1]}return Math.abs(t)/2}async simplifiedDetection(e,t){console.log("Using simplified detection fallback..."),this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const o=this.ctx.getImageData(0,0,e.width,e.height).data,s=new Uint8Array(e.width*e.height);for(let a=0;a<s.length;a++){const d=a*4,h=.299*o[d]+.587*o[d+1]+.114*o[d+2];s[a]=h<200?255:0}const r=[],l=new Set;for(let a=10;a<e.height-10;a+=20)for(let d=10;d<e.width-10;d+=20){const h=a*e.width+d;if(s[h]===255&&!l.has(h)){let c=d,u=d,m=a,y=a;const v=[[d,a]];for(;v.length>0&&l.size<1e4;){const[E,L]=v.pop(),_=L*e.width+E;E<0||E>=e.width||L<0||L>=e.height||l.has(_)||s[_]!==255||(l.add(_),c=Math.min(c,E),u=Math.max(u,E),m=Math.min(m,L),y=Math.max(y,L),v.push([E+1,L],[E-1,L],[E,L+1],[E,L-1]))}u-c>10&&y-m>10&&r.push({points:[[c/t,m/t],[u/t,m/t],[u/t,y/t],[c/t,y/t]],score:.8})}}return r}sortBoxes(e){if(e.length===0)return e;e.sort((t,n)=>{const o=t.points[0][1],s=n.points[0][1];return o-s});for(let t=e.length-1;t>0;t--)for(let n=t-1;n>=0&&(Math.abs(e[n+1].points[0][1]-e[n].points[0][1])<10&&e[n+1].points[0][0]<e[n].points[0][0]);n--){const o=e[n];e[n]=e[n+1],e[n+1]=o}return e}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[],o=this.CONFIG.rec_batch_num;for(let s=0;s<t.length;s+=o){const r=t.slice(s,Math.min(s+o,t.length)),l=await this.processBatch(e,r);n.push(...l)}return n}async processBatch(e,t){const n=[],o=[],s=[];for(const l of t){const a=await this.getRotateCropImage(e,l),d=a.width/a.height;o.push(a),s.push(d)}const r=Array.from({length:t.length},(l,a)=>a).sort((l,a)=>s[l]-s[a]);for(const l of r){const a=o[l],d=t[l],h=await this.preprocessForRecognition(a),c={[this.recognitionSession.inputNames[0]]:h},u=await this.recognitionSession.run(c),m=await this.decodeRecognition(u[this.recognitionSession.outputNames[0]]);m.score>=this.CONFIG.drop_score&&n.push({text:m.text,confidence:m.score,box:d.points})}return n}async getRotateCropImage(e,t){const n=t.points;Math.sqrt(Math.pow(n[0][0]-n[1][0],2)+Math.pow(n[0][1]-n[1][1],2)),Math.sqrt(Math.pow(n[2][0]-n[3][0],2)+Math.pow(n[2][1]-n[3][1],2)),Math.sqrt(Math.pow(n[0][0]-n[3][0],2)+Math.pow(n[0][1]-n[3][1],2)),Math.sqrt(Math.pow(n[1][0]-n[2][0],2)+Math.pow(n[1][1]-n[2][1],2));const o=Math.min(...n.map(c=>c[0])),s=Math.max(...n.map(c=>c[0])),r=Math.min(...n.map(c=>c[1])),l=Math.max(...n.map(c=>c[1])),a=s-o,d=l-r;if(this.canvas.width=a,this.canvas.height=d,this.ctx.drawImage(e,o,r,a,d,0,0,a,d),d*1/a>=1.5){const c=document.createElement("canvas"),u=c.getContext("2d",{willReadFrequently:!0});c.width=d,c.height=a,u.translate(d/2,a/2),u.rotate(Math.PI/2),u.drawImage(this.canvas,-a/2,-d/2),this.canvas.width=d,this.canvas.height=a,this.ctx.drawImage(c,0,0)}const h=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const m=URL.createObjectURL(u);h.onload=()=>{URL.revokeObjectURL(m),c(h)},h.src=m})})}async preprocessForRecognition(e){const n=this.CONFIG.rec_image_height,o=this.CONFIG.rec_image_width,s=e.height,l=e.width/s;let a;Math.ceil(n*l)>o?a=o:a=Math.ceil(n*l),this.canvas.width=a,this.canvas.height=n,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,a,n),this.ctx.drawImage(e,0,0,a,n);const h=this.ctx.getImageData(0,0,a,n).data,c=new Float32Array(3*n*o);for(let u=0;u<3;u++)for(let m=0;m<n;m++)for(let y=0;y<a;y++){const v=(m*a+y)*4+u,E=u*n*o+m*o+y;c[E]=(h[v]/255-this.CONFIG.rec_mean)/this.CONFIG.rec_std}return new ve("float32",c,[1,3,n,o])}async decodeRecognition(e){const[t,n,o]=e.dims,s=e.data,r=[],l=[];for(let c=0;c<n;c++){let u=0,m=s[c*o];for(let y=1;y<o;y++){const v=s[c*o+y];v>m&&(m=v,u=y)}r.push(u),l.push(m)}const a=[],d=[];let h=-1;for(let c=0;c<r.length;c++){const u=r[c];u!==0&&u!==h&&u<this.charDict.length&&(a.push(this.charDict[u]),d.push(l[c])),h=u}return{text:a.join(""),score:d.length>0?d.reduce((c,u)=>c+u)/d.length:0}}mergeTextLines(e){if(e.length===0)return e;let t=this.filterResults(e);if(t.length===0)return t;this.CONFIG.english_mode&&(t=this.postProcessEnglishText(t));const n=t.map(a=>{const d=a.box.map(h=>h[1]);return Math.max(...d)-Math.min(...d)}),o=n.reduce((a,d)=>a+d)/n.length,s=[];let r=[t[0]];for(let a=1;a<t.length;a++){const d=t[a],h=t[a-1],c=Math.min(...h.box.map(v=>v[1])),u=Math.min(...d.box.map(v=>v[1])),m=Math.abs(u-c),y=o*this.CONFIG.vertical_gap_threshold;m<=y?r.push(d):(s.push(r),r=[d])}r.length>0&&s.push(r);const l=[];for(const a of s){a.sort((y,v)=>{const E=Math.min(...y.box.map(_=>_[0])),L=Math.min(...v.box.map(_=>_[0]));return E-L});const d=a.map(y=>y.text).join(" "),h=a.reduce((y,v)=>y+v.confidence,0)/a.length,c=a.flatMap(y=>y.box),u=c.map(y=>y[0]),m=c.map(y=>y[1]);l.push({text:d,confidence:h,box:[[Math.min(...u),Math.min(...m)],[Math.max(...u),Math.min(...m)],[Math.max(...u),Math.max(...m)],[Math.min(...u),Math.max(...m)]]})}return l}filterResults(e){const t=this.CONFIG.drop_score;return e.filter(n=>n.confidence<t?!1:n.text&&n.text.trim().length>0)}async processPDF(e){const t=await e.arrayBuffer(),n=await te.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const l=await n.getPage(r),a=l.getViewport({scale:2}),d=document.createElement("canvas"),h=d.getContext("2d");d.width=a.width,d.height=a.height,await l.render({canvasContext:h,viewport:a}).promise;const c=await new Promise(m=>d.toBlob(m)),u=await this.process(c);s.push({page:r,results:u})}return s}async blobToImage(e){return new Promise((t,n)=>{const o=new Image,s=URL.createObjectURL(e);o.onload=()=>{URL.revokeObjectURL(s),t(o)},o.onerror=()=>{URL.revokeObjectURL(s),n(new Error("Failed to load image"))},o.src=s})}postProcessEnglishText(e){return e.map(t=>{let n=t.text;n=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([a-zA-Z])(\d)/g,"$1 $2").replace(/(\d)([a-zA-Z])/g,"$1 $2").replace(/\s+/g," ").replace(/([.,!?;:])([a-zA-Z])/g,"$1 $2").trim();const o={tne:"the",tnat:"that",wnen:"when",wnere:"where",witn:"with","l'":"I'"," l ":" I ","^l ":"I "};for(const[s,r]of Object.entries(o)){const l=new RegExp(s,"gi");n=n.replace(l,r)}return{...t,text:n}})}}const ae=new Ke;te.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";le.wasm.wasmPaths="/client-ocr-app/assets/";le.wasm.numThreads=1;const be="/client-ocr-app/models/",j={det_limit_side_len:1280,det_db_thresh:.05,det_db_box_thresh:.15,det_db_unclip_ratio:2.5,drop_score:.05,mean:[.485,.456,.406],std:[.229,.224,.225]};class Je{constructor(){this.detectionSession=null,this.recognitionSession=null,this.charDict=[],this.initialized=!1,this.canvas=null,this.ctx=null,this.modelConfig={detection:"PP-OCRv5_mobile_det_infer.onnx",recognition:"en_PP-OCRv4_mobile_rec_infer.onnx",dictionary:"en_dict.txt"}}setModelConfig(e){e.detection&&(this.modelConfig.detection=e.detection),e.recognition&&(this.modelConfig.recognition=e.recognition),e.dictionary&&(this.modelConfig.dictionary=e.dictionary),this.initialized=!1}async initialize(e){this.initialized=!1;try{this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),e==null||e({status:"loading",message:"Loading dictionary...",progress:10}),await this.loadDictionary();const t=this.modelConfig.detection.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${t}...`,progress:30}),this.detectionSession&&await this.detectionSession.release(),this.detectionSession=await ye.create(be+this.modelConfig.detection,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Detection model loaded:",this.detectionSession.inputNames,this.detectionSession.outputNames);const n=this.modelConfig.recognition.replace(".onnx","").replace(/_/g," ");e==null||e({status:"loading",message:`Loading ${n}...`,progress:70}),this.recognitionSession&&await this.recognitionSession.release(),this.recognitionSession=await ye.create(be+this.modelConfig.recognition,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("Recognition model loaded:",this.recognitionSession.inputNames,this.recognitionSession.outputNames),this.initialized=!0,e==null||e({status:"ready",message:"PP-OCR models loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize PP-OCR models:",t),t}}async loadDictionary(){try{const t=await(await fetch(be+this.modelConfig.dictionary)).text();this.charDict=t.split(`
`).filter(n=>n.trim()),this.charDict.unshift(" "),console.log(`Loaded dictionary ${this.modelConfig.dictionary} with ${this.charDict.length} characters`)}catch(e){console.error("Failed to load dictionary:",e),this.charDict=[" "];for(let t=32;t<127;t++)this.charDict.push(String.fromCharCode(t))}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.blobToImage(e),n=await this.detectText(t);return await this.recognizeText(t,n)}async detectText(e){if(!this.detectionSession)throw new Error("Detection model not loaded");const{resizedImage:t,ratio:n}=await this.resizeForDetection(e),o=await this.preprocessForDetection(t),s={[this.detectionSession.inputNames[0]]:o},l=(await this.detectionSession.run(s))[this.detectionSession.outputNames[0]];return await this.postprocessDetection(l,t.width,t.height,n)}async resizeForDetection(e){const t=j.det_limit_side_len;let n=e.width,o=e.height,s=1;Math.max(o,n)>t&&(s=t/Math.max(o,n));const r=Math.ceil(n*s),l=Math.ceil(o*s),a=Math.ceil(r/32)*32,d=Math.ceil(l/32)*32;this.canvas.width=a,this.canvas.height=d,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,a,d),this.ctx.drawImage(e,0,0,r,l);const h=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const m=URL.createObjectURL(u);h.onload=()=>{URL.revokeObjectURL(m),c({resizedImage:h,ratio:s})},h.src=m})})}async preprocessForDetection(e){this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0);const n=this.ctx.getImageData(0,0,e.width,e.height).data,o=e.width*e.height,s=new Float32Array(3*o);for(let r=0;r<o;r++){const l=r*4;s[r]=(n[l]/255-j.mean[0])/j.std[0],s[o+r]=(n[l+1]/255-j.mean[1])/j.std[1],s[2*o+r]=(n[l+2]/255-j.mean[2])/j.std[2]}return new ve("float32",s,[1,3,e.height,e.width])}async postprocessDetection(e,t,n,o){const[s,r,l,a]=e.dims,d=e.data,h=new Float32Array(l*a);for(let v=0;v<l*a;v++)h[v]=1/(1+Math.exp(-d[v]));const c=new Uint8Array(l*a),u=j.det_db_thresh;for(let v=0;v<l*a;v++)c[v]=h[v]>u?1:0;const m=[],y=new Set;for(let v=0;v<l;v++)for(let E=0;E<a;E++){const L=v*a+E;if(c[L]===1&&!y.has(L)&&h[L]>j.det_db_box_thresh){const _=this.expandBox(c,h,E,v,a,l,y);if(_){const P={points:_.points.map(C=>[Math.round(C[0]*t/a/o),Math.round(C[1]*n/l/o)]),score:_.score};m.push(P)}}}return this.sortBoxes(m)}expandBox(e,t,n,o,s,r,l){let a=n,d=n,h=o,c=o,u=0,m=0;const y=[[n,o]];for(l.add(o*s+n);y.length>0;){const[L,_]=y.shift();u+=t[_*s+L],m++;for(let P=-1;P<=1;P++)for(let C=-1;C<=1;C++){const O=L+C,z=_+P,F=z*s+O;O>=0&&O<s&&z>=0&&z<r&&e[F]===1&&!l.has(F)&&(l.add(F),y.push([O,z]),a=Math.min(a,O),d=Math.max(d,O),h=Math.min(h,z),c=Math.max(c,z))}}if(d-a<3||c-h<3)return null;const v=j.det_db_unclip_ratio,E=Math.max(d-a,c-h)*(v-1)/2;return a=Math.max(0,a-E),d=Math.min(s-1,d+E),h=Math.max(0,h-E),c=Math.min(r-1,c+E),{points:[[a,h],[d,h],[d,c],[a,c]],score:u/m}}sortBoxes(e){return e.sort((t,n)=>{const o=Math.min(...t.points.map(r=>r[1])),s=Math.min(...n.points.map(r=>r[1]));if(Math.abs(o-s)<10){const r=Math.min(...t.points.map(a=>a[0])),l=Math.min(...n.points.map(a=>a[0]));return r-l}return o-s})}async recognizeText(e,t){if(!this.recognitionSession)throw new Error("Recognition model not loaded");const n=[];for(const o of t){const s=await this.cropToBox(e,o),r=await this.preprocessForRecognition(s),l={[this.recognitionSession.inputNames[0]]:r},a=await this.recognitionSession.run(l),d=await this.decodeRecognition(a[this.recognitionSession.outputNames[0]]);d.score>=j.drop_score&&n.push({text:d.text,confidence:d.score,box:o.points})}return n}async cropToBox(e,t){const n=t.points,o=Math.min(...n.map(c=>c[0])),s=Math.max(...n.map(c=>c[0])),r=Math.min(...n.map(c=>c[1])),l=Math.max(...n.map(c=>c[1])),a=s-o,d=l-r;this.canvas.width=a,this.canvas.height=d,this.ctx.drawImage(e,o,r,a,d,0,0,a,d);const h=new Image;return new Promise(c=>{this.canvas.toBlob(u=>{const m=URL.createObjectURL(u);h.onload=()=>{URL.revokeObjectURL(m),c(h)},h.src=m})})}async preprocessForRecognition(e){const n=e.width/e.height;let o=Math.round(48*n);o=Math.max(o,48),this.canvas.width=o,this.canvas.height=48,this.ctx.fillStyle="white",this.ctx.fillRect(0,0,o,48),this.ctx.drawImage(e,0,0,o,48);const r=this.ctx.getImageData(0,0,o,48).data,l=o*48,a=new Float32Array(3*l);for(let d=0;d<l;d++){const h=d*4;a[d]=(r[h]/255-.5)/.5,a[l+d]=(r[h+1]/255-.5)/.5,a[2*l+d]=(r[h+2]/255-.5)/.5}return new ve("float32",a,[1,3,48,o])}async decodeRecognition(e){const[t,n,o]=e.dims,s=e.data,r=[],l=[];for(let c=0;c<n;c++){let u=0,m=s[c*o];for(let y=1;y<o;y++){const v=s[c*o+y];v>m&&(m=v,u=y)}r.push(u),l.push(m)}const a=[],d=[];let h=-1;for(let c=0;c<r.length;c++){const u=r[c];u!==0&&u!==h&&u<this.charDict.length&&(a.push(this.charDict[u]),d.push(l[c])),h=u}return{text:a.join(""),score:d.length>0?d.reduce((c,u)=>c+u)/d.length:0}}async processPDF(e){const t=await e.arrayBuffer(),n=await te.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const l=await n.getPage(r),a=l.getViewport({scale:2}),d=document.createElement("canvas"),h=d.getContext("2d");d.width=a.width,d.height=a.height,await l.render({canvasContext:h,viewport:a}).promise;const c=await new Promise(v=>d.toBlob(v,"image/png")),u=await this.blobToImage(c),m=await this.detectText(u),y=await this.recognizeText(u,m);s.push({page:r,results:y})}return s}async blobToImage(e){return new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n,o.src=URL.createObjectURL(e)})}}const ee=new Je;var Ze={exports:{}};(function(i){var e=function(t){var n=Object.prototype,o=n.hasOwnProperty,s=Object.defineProperty||function(f,g,w){f[g]=w.value},r,l=typeof Symbol=="function"?Symbol:{},a=l.iterator||"@@iterator",d=l.asyncIterator||"@@asyncIterator",h=l.toStringTag||"@@toStringTag";function c(f,g,w){return Object.defineProperty(f,g,{value:w,enumerable:!0,configurable:!0,writable:!0}),f[g]}try{c({},"")}catch{c=function(g,w,b){return g[w]=b}}function u(f,g,w,b){var p=g&&g.prototype instanceof P?g:P,x=Object.create(p.prototype),I=new me(b||[]);return s(x,"_invoke",{value:W(f,w,I)}),x}t.wrap=u;function m(f,g,w){try{return{type:"normal",arg:f.call(g,w)}}catch(b){return{type:"throw",arg:b}}}var y="suspendedStart",v="suspendedYield",E="executing",L="completed",_={};function P(){}function C(){}function O(){}var z={};c(z,a,function(){return this});var F=Object.getPrototypeOf,D=F&&F(F(ge([])));D&&D!==n&&o.call(D,a)&&(z=D);var A=O.prototype=P.prototype=Object.create(z);C.prototype=O,s(A,"constructor",{value:O,configurable:!0}),s(O,"constructor",{value:C,configurable:!0}),C.displayName=c(O,h,"GeneratorFunction");function ce(f){["next","throw","return"].forEach(function(g){c(f,g,function(w){return this._invoke(g,w)})})}t.isGeneratorFunction=function(f){var g=typeof f=="function"&&f.constructor;return g?g===C||(g.displayName||g.name)==="GeneratorFunction":!1},t.mark=function(f){return Object.setPrototypeOf?Object.setPrototypeOf(f,O):(f.__proto__=O,c(f,h,"GeneratorFunction")),f.prototype=Object.create(A),f},t.awrap=function(f){return{__await:f}};function G(f,g){function w(x,I,R,S){var T=m(f[x],f,I);if(T.type==="throw")S(T.arg);else{var Q=T.arg,V=Q.value;return V&&typeof V=="object"&&o.call(V,"__await")?g.resolve(V.__await).then(function(K){w("next",K,R,S)},function(K){w("throw",K,R,S)}):g.resolve(V).then(function(K){Q.value=K,R(Q)},function(K){return w("throw",K,R,S)})}}var b;function p(x,I){function R(){return new g(function(S,T){w(x,I,S,T)})}return b=b?b.then(R,R):R()}s(this,"_invoke",{value:p})}ce(G.prototype),c(G.prototype,d,function(){return this}),t.AsyncIterator=G,t.async=function(f,g,w,b,p){p===void 0&&(p=Promise);var x=new G(u(f,g,w,b),p);return t.isGeneratorFunction(g)?x:x.next().then(function(I){return I.done?I.value:x.next()})};function W(f,g,w){var b=y;return function(x,I){if(b===E)throw new Error("Generator is already running");if(b===L){if(x==="throw")throw I;return fe()}for(w.method=x,w.arg=I;;){var R=w.delegate;if(R){var S=q(R,w);if(S){if(S===_)continue;return S}}if(w.method==="next")w.sent=w._sent=w.arg;else if(w.method==="throw"){if(b===y)throw b=L,w.arg;w.dispatchException(w.arg)}else w.method==="return"&&w.abrupt("return",w.arg);b=E;var T=m(f,g,w);if(T.type==="normal"){if(b=w.done?L:v,T.arg===_)continue;return{value:T.arg,done:w.done}}else T.type==="throw"&&(b=L,w.method="throw",w.arg=T.arg)}}}function q(f,g){var w=g.method,b=f.iterator[w];if(b===r)return g.delegate=null,w==="throw"&&f.iterator.return&&(g.method="return",g.arg=r,q(f,g),g.method==="throw")||w!=="return"&&(g.method="throw",g.arg=new TypeError("The iterator does not provide a '"+w+"' method")),_;var p=m(b,f.iterator,g.arg);if(p.type==="throw")return g.method="throw",g.arg=p.arg,g.delegate=null,_;var x=p.arg;if(!x)return g.method="throw",g.arg=new TypeError("iterator result is not an object"),g.delegate=null,_;if(x.done)g[f.resultName]=x.value,g.next=f.nextLoc,g.method!=="return"&&(g.method="next",g.arg=r);else return x;return g.delegate=null,_}ce(A),c(A,h,"Generator"),c(A,a,function(){return this}),c(A,"toString",function(){return"[object Generator]"});function ue(f){var g={tryLoc:f[0]};1 in f&&(g.catchLoc=f[1]),2 in f&&(g.finallyLoc=f[2],g.afterLoc=f[3]),this.tryEntries.push(g)}function X(f){var g=f.completion||{};g.type="normal",delete g.arg,f.completion=g}function me(f){this.tryEntries=[{tryLoc:"root"}],f.forEach(ue,this),this.reset(!0)}t.keys=function(f){var g=Object(f),w=[];for(var b in g)w.push(b);return w.reverse(),function p(){for(;w.length;){var x=w.pop();if(x in g)return p.value=x,p.done=!1,p}return p.done=!0,p}};function ge(f){if(f){var g=f[a];if(g)return g.call(f);if(typeof f.next=="function")return f;if(!isNaN(f.length)){var w=-1,b=function p(){for(;++w<f.length;)if(o.call(f,w))return p.value=f[w],p.done=!1,p;return p.value=r,p.done=!0,p};return b.next=b}}return{next:fe}}t.values=ge;function fe(){return{value:r,done:!0}}return me.prototype={constructor:me,reset:function(f){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(X),!f)for(var g in this)g.charAt(0)==="t"&&o.call(this,g)&&!isNaN(+g.slice(1))&&(this[g]=r)},stop:function(){this.done=!0;var f=this.tryEntries[0],g=f.completion;if(g.type==="throw")throw g.arg;return this.rval},dispatchException:function(f){if(this.done)throw f;var g=this;function w(S,T){return x.type="throw",x.arg=f,g.next=S,T&&(g.method="next",g.arg=r),!!T}for(var b=this.tryEntries.length-1;b>=0;--b){var p=this.tryEntries[b],x=p.completion;if(p.tryLoc==="root")return w("end");if(p.tryLoc<=this.prev){var I=o.call(p,"catchLoc"),R=o.call(p,"finallyLoc");if(I&&R){if(this.prev<p.catchLoc)return w(p.catchLoc,!0);if(this.prev<p.finallyLoc)return w(p.finallyLoc)}else if(I){if(this.prev<p.catchLoc)return w(p.catchLoc,!0)}else if(R){if(this.prev<p.finallyLoc)return w(p.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(f,g){for(var w=this.tryEntries.length-1;w>=0;--w){var b=this.tryEntries[w];if(b.tryLoc<=this.prev&&o.call(b,"finallyLoc")&&this.prev<b.finallyLoc){var p=b;break}}p&&(f==="break"||f==="continue")&&p.tryLoc<=g&&g<=p.finallyLoc&&(p=null);var x=p?p.completion:{};return x.type=f,x.arg=g,p?(this.method="next",this.next=p.finallyLoc,_):this.complete(x)},complete:function(f,g){if(f.type==="throw")throw f.arg;return f.type==="break"||f.type==="continue"?this.next=f.arg:f.type==="return"?(this.rval=this.arg=f.arg,this.method="return",this.next="end"):f.type==="normal"&&g&&(this.next=g),_},finish:function(f){for(var g=this.tryEntries.length-1;g>=0;--g){var w=this.tryEntries[g];if(w.finallyLoc===f)return this.complete(w.completion,w.afterLoc),X(w),_}},catch:function(f){for(var g=this.tryEntries.length-1;g>=0;--g){var w=this.tryEntries[g];if(w.tryLoc===f){var b=w.completion;if(b.type==="throw"){var p=b.arg;X(w)}return p}}throw new Error("illegal catch attempt")},delegateYield:function(f,g,w){return this.delegate={iterator:ge(f),resultName:g,nextLoc:w},this.method==="next"&&(this.arg=r),_}},t}(i.exports);try{regeneratorRuntime=e}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}})(Ze);var Se=(i,e)=>`${i}-${e}-${Math.random().toString(16).slice(3,8)}`;const Qe=Se;let $e=0;var De=({id:i,action:e,payload:t={}})=>{let n=i;return typeof n>"u"&&(n=Qe("Job",$e),$e+=1),{id:n,action:e,payload:t}},he={};let Ce=!1;he.logging=Ce;he.setLogging=i=>{Ce=i};he.log=(...i)=>Ce?console.log.apply(void 0,i):null;const et=De,{log:we}=he,tt=Se;let Pe=0;var nt=()=>{const i=tt("Scheduler",Pe),e={},t={};let n=[];Pe+=1;const o=()=>n.length,s=()=>Object.keys(e).length,r=()=>{if(n.length!==0){const c=Object.keys(e);for(let u=0;u<c.length;u+=1)if(typeof t[c[u]]>"u"){n[0](e[c[u]]);break}}},l=(c,u)=>new Promise((m,y)=>{const v=et({action:c,payload:u});n.push(async E=>{n.shift(),t[E.id]=v;try{m(await E[c].apply(void 0,[...u,v.id]))}catch(L){y(L)}finally{delete t[E.id],r()}}),we(`[${i}]: Add ${v.id} to JobQueue`),we(`[${i}]: JobQueue length=${n.length}`),r()});return{addWorker:c=>(e[c.id]=c,we(`[${i}]: Add ${c.id}`),we(`[${i}]: Number of workers=${s()}`),r(),c.id),addJob:async(c,...u)=>{if(s()===0)throw Error(`[${i}]: You need to have at least one worker before adding jobs`);return l(c,u)},terminate:async()=>{Object.keys(e).forEach(async c=>{await e[c].terminate()}),n=[]},getQueueLen:o,getNumWorkers:s}};function ot(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var it=ot;const st=it;var rt=i=>{const e={};return typeof WorkerGlobalScope<"u"?e.type="webworker":st()?e.type="electron":typeof document=="object"?e.type="browser":typeof process=="object"&&typeof qe=="function"&&(e.type="node"),typeof i>"u"?e:e[i]};const at=rt("type")==="browser",ct=at?i=>new URL(i,window.location.href).href:i=>i;var dt=i=>{const e={...i};return["corePath","workerPath","langPath"].forEach(t=>{i[t]&&(e[t]=ct(e[t]))}),e},lt=i=>{const e=[],t=[],n=[],o=[],s=[];return i.blocks&&i.blocks.forEach(r=>{r.paragraphs.forEach(l=>{l.lines.forEach(a=>{a.words.forEach(d=>{d.symbols.forEach(h=>{s.push({...h,page:i,block:r,paragraph:l,line:a,word:d})}),o.push({...d,page:i,block:r,paragraph:l,line:a})}),n.push({...a,page:i,block:r,paragraph:l})}),t.push({...l,page:i,block:r})}),e.push({...r,page:i})}),{...i,blocks:e,paragraphs:t,lines:n,words:o,symbols:s}},Ae={TESSERACT_ONLY:0,LSTM_ONLY:1,TESSERACT_LSTM_COMBINED:2,DEFAULT:3};const ht="5.1.1",ut={version:ht};var mt={workerBlobURL:!0,logger:()=>{}};const gt=ut.version,pt=mt;var ft={...pt,workerPath:`https://cdn.jsdelivr.net/npm/tesseract.js@v${gt}/dist/worker.min.js`},wt=({workerPath:i,workerBlobURL:e})=>{let t;if(Blob&&URL&&e){const n=new Blob([`importScripts("${i}");`],{type:"application/javascript"});t=new Worker(URL.createObjectURL(n))}else t=new Worker(i);return t},yt=i=>{i.terminate()},vt=(i,e)=>{i.onmessage=({data:t})=>{e(t)}},xt=async(i,e)=>{i.postMessage(e)};const Ee=i=>new Promise((e,t)=>{const n=new FileReader;n.onload=()=>{e(n.result)},n.onerror=({target:{error:{code:o}}})=>{t(Error(`File could not be read! Code=${o}`))},n.readAsArrayBuffer(i)}),Me=async i=>{let e=i;if(typeof i>"u")return"undefined";if(typeof i=="string")/data:image\/([a-zA-Z]*);base64,([^"]*)/.test(i)?e=atob(i.split(",")[1]).split("").map(t=>t.charCodeAt(0)):e=await(await fetch(i)).arrayBuffer();else if(typeof HTMLElement<"u"&&i instanceof HTMLElement)i.tagName==="IMG"&&(e=await Me(i.src)),i.tagName==="VIDEO"&&(e=await Me(i.poster)),i.tagName==="CANVAS"&&await new Promise(t=>{i.toBlob(async n=>{e=await Ee(n),t()})});else if(typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas){const t=await i.convertToBlob();e=await Ee(t)}else(i instanceof File||i instanceof Blob)&&(e=await Ee(i));return new Uint8Array(e)};var _t=Me;const bt=ft,Et=wt,Ot=yt,Lt=vt,It=xt,Mt=_t;var Rt={defaultOptions:bt,spawnWorker:Et,terminateWorker:Ot,onMessage:Lt,send:It,loadImage:Mt};const St=dt,Ct=lt,k=De,{log:Te}=he,$t=Se,ne=Ae,{defaultOptions:Pt,spawnWorker:Tt,terminateWorker:Ft,onMessage:Nt,loadImage:Fe,send:zt}=Rt;let Ne=0;var Ge=async(i="eng",e=ne.LSTM_ONLY,t={},n={})=>{const o=$t("Worker",Ne),{logger:s,errorHandler:r,...l}=St({...Pt,...t}),a={},d={},h=typeof i=="string"?i.split("+"):i;let c=e,u=n;const m=[ne.DEFAULT,ne.LSTM_ONLY].includes(e)&&!l.legacyCore;let y,v;const E=new Promise((p,x)=>{v=p,y=x}),L=p=>{y(p.message)};let _=Tt(l);_.onerror=L,Ne+=1;const P=(p,x)=>{a[p]=x},C=(p,x)=>{d[p]=x},O=({id:p,action:x,payload:I})=>new Promise((R,S)=>{Te(`[${o}]: Start ${p}, action=${x}`);const T=`${x}-${p}`;P(T,R),C(T,S),zt(_,{workerId:o,jobId:p,action:x,payload:I})}),z=()=>console.warn("`load` is depreciated and should be removed from code (workers now come pre-loaded)"),F=p=>O(k({id:p,action:"load",payload:{options:{lstmOnly:m,corePath:l.corePath,logging:l.logging}}})),D=(p,x,I)=>O(k({id:I,action:"FS",payload:{method:"writeFile",args:[p,x]}})),A=(p,x)=>O(k({id:x,action:"FS",payload:{method:"readFile",args:[p,{encoding:"utf8"}]}})),ce=(p,x)=>O(k({id:x,action:"FS",payload:{method:"unlink",args:[p]}})),G=(p,x,I)=>O(k({id:I,action:"FS",payload:{method:p,args:x}})),W=()=>console.warn("`loadLanguage` is depreciated and should be removed from code (workers now come with language pre-loaded)"),q=(p,x)=>O(k({id:x,action:"loadLanguage",payload:{langs:p,options:{langPath:l.langPath,dataPath:l.dataPath,cachePath:l.cachePath,cacheMethod:l.cacheMethod,gzip:l.gzip,lstmOnly:[ne.DEFAULT,ne.LSTM_ONLY].includes(c)&&!l.legacyLang}}})),ue=()=>console.warn("`initialize` is depreciated and should be removed from code (workers now come pre-initialized)"),X=(p,x,I,R)=>O(k({id:R,action:"initialize",payload:{langs:p,oem:x,config:I}})),me=(p="eng",x,I,R)=>{if(m&&[ne.TESSERACT_ONLY,ne.TESSERACT_LSTM_COMBINED].includes(x))throw Error("Legacy model requested but code missing.");const S=x||c;c=S;const T=I||u;u=T;const V=(typeof p=="string"?p.split("+"):p).filter(K=>!h.includes(K));return h.push(...V),V.length>0?q(V,R).then(()=>X(p,S,T,R)):X(p,S,T,R)},ge=(p={},x)=>O(k({id:x,action:"setParameters",payload:{params:p}})),fe=async(p,x={},I={blocks:!0,text:!0,hocr:!0,tsv:!0},R)=>O(k({id:R,action:"recognize",payload:{image:await Fe(p),options:x,output:I}})),f=(p="Tesseract OCR Result",x=!1,I)=>(console.log("`getPDF` function is depreciated. `recognize` option `savePDF` should be used instead."),O(k({id:I,action:"getPDF",payload:{title:p,textonly:x}}))),g=async(p,x)=>{if(m)throw Error("`worker.detect` requires Legacy model, which was not loaded.");return O(k({id:x,action:"detect",payload:{image:await Fe(p)}}))},w=async()=>(_!==null&&(Ft(_),_=null),Promise.resolve());Nt(_,({workerId:p,jobId:x,status:I,action:R,data:S})=>{const T=`${R}-${x}`;if(I==="resolve"){Te(`[${p}]: Complete ${x}`);let Q=S;R==="recognize"?Q=Ct(S):R==="getPDF"&&(Q=Array.from({...S,length:Object.keys(S).length})),a[T]({jobId:x,data:Q})}else if(I==="reject")if(d[T](S),R==="load"&&y(S),r)r(S);else throw Error(S);else I==="progress"&&s({...S,userJobId:x})});const b={id:o,worker:_,setResolve:P,setReject:C,load:z,writeText:D,readText:A,removeFile:ce,FS:G,loadLanguage:W,initialize:ue,reinitialize:me,setParameters:ge,recognize:fe,getPDF:f,detect:g,terminate:w};return F().then(()=>q(i)).then(()=>X(i,e,n)).then(()=>v(b)).catch(()=>{}),E};const je=Ge,Bt=async(i,e,t)=>{const n=await je(e,1,t);return n.recognize(i).finally(async()=>{await n.terminate()})},Dt=async(i,e)=>{const t=await je("osd",0,e);return t.detect(i).finally(async()=>{await t.terminate()})};var At={recognize:Bt,detect:Dt},Gt={AFR:"afr",AMH:"amh",ARA:"ara",ASM:"asm",AZE:"aze",AZE_CYRL:"aze_cyrl",BEL:"bel",BEN:"ben",BOD:"bod",BOS:"bos",BUL:"bul",CAT:"cat",CEB:"ceb",CES:"ces",CHI_SIM:"chi_sim",CHI_TRA:"chi_tra",CHR:"chr",CYM:"cym",DAN:"dan",DEU:"deu",DZO:"dzo",ELL:"ell",ENG:"eng",ENM:"enm",EPO:"epo",EST:"est",EUS:"eus",FAS:"fas",FIN:"fin",FRA:"fra",FRK:"frk",FRM:"frm",GLE:"gle",GLG:"glg",GRC:"grc",GUJ:"guj",HAT:"hat",HEB:"heb",HIN:"hin",HRV:"hrv",HUN:"hun",IKU:"iku",IND:"ind",ISL:"isl",ITA:"ita",ITA_OLD:"ita_old",JAV:"jav",JPN:"jpn",KAN:"kan",KAT:"kat",KAT_OLD:"kat_old",KAZ:"kaz",KHM:"khm",KIR:"kir",KOR:"kor",KUR:"kur",LAO:"lao",LAT:"lat",LAV:"lav",LIT:"lit",MAL:"mal",MAR:"mar",MKD:"mkd",MLT:"mlt",MSA:"msa",MYA:"mya",NEP:"nep",NLD:"nld",NOR:"nor",ORI:"ori",PAN:"pan",POL:"pol",POR:"por",PUS:"pus",RON:"ron",RUS:"rus",SAN:"san",SIN:"sin",SLK:"slk",SLV:"slv",SPA:"spa",SPA_OLD:"spa_old",SQI:"sqi",SRP:"srp",SRP_LATN:"srp_latn",SWA:"swa",SWE:"swe",SYR:"syr",TAM:"tam",TEL:"tel",TGK:"tgk",TGL:"tgl",THA:"tha",TIR:"tir",TUR:"tur",UIG:"uig",UKR:"ukr",URD:"urd",UZB:"uzb",UZB_CYRL:"uzb_cyrl",VIE:"vie",YID:"yid"},jt={OSD_ONLY:"0",AUTO_OSD:"1",AUTO_ONLY:"2",AUTO:"3",SINGLE_COLUMN:"4",SINGLE_BLOCK_VERT_TEXT:"5",SINGLE_BLOCK:"6",SINGLE_LINE:"7",SINGLE_WORD:"8",CIRCLE_WORD:"9",SINGLE_CHAR:"10",SPARSE_TEXT:"11",SPARSE_TEXT_OSD:"12",RAW_LINE:"13"};const kt=nt,Ut=Ge,Yt=At,Ht=Gt,Wt=Ae,qt=jt,{setLogging:Xt}=he;var Vt={languages:Ht,OEM:Wt,PSM:qt,createScheduler:kt,createWorker:Ut,setLogging:Xt,...Yt};const Oe=Xe(Vt);te.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";class Kt{constructor(){this.initialized=!1,this.worker=null}async initialize(e){if(!this.initialized)try{e==null||e({status:"loading",message:"Loading Tesseract OCR engine...",progress:10}),this.worker=await Oe.createWorker("eng",1,{logger:t=>{t.status==="loading tesseract core"?e==null||e({status:"loading",message:"Loading OCR core...",progress:30}):t.status==="loading language traineddata"?e==null||e({status:"loading",message:"Loading English language model...",progress:60}):t.status==="initialized tesseract"&&(e==null||e({status:"loading",message:"Initializing OCR engine...",progress:90}))},errorHandler:t=>{console.error("Tesseract error:",t)}}),await this.worker.setParameters({tessedit_ocr_engine_mode:Oe.OEM.LSTM_ONLY,preserve_interword_spaces:"1",tessedit_pageseg_mode:Oe.PSM.AUTO}),this.initialized=!0,e==null||e({status:"ready",message:"Tesseract OCR engine loaded successfully!",progress:100})}catch(t){throw console.error("Failed to initialize Tesseract:",t),t}}async process(e){if(!this.initialized)throw new Error("OCR engine not initialized");if(e.type==="application/pdf")return await this.processPDF(e);const t=await this.worker.recognize(e);return this.formatResults(t)}formatResults(e){const t=[];for(const o of e.data.words)o.confidence>30&&t.push({box:[[o.bbox.x0,o.bbox.y0],[o.bbox.x1,o.bbox.y0],[o.bbox.x1,o.bbox.y1],[o.bbox.x0,o.bbox.y1]],text:o.text,confidence:o.confidence/100});return this.groupWordsIntoLines(t)}groupWordsIntoLines(e){if(e.length===0)return[];e.sort((o,s)=>o.box[0][1]-s.box[0][1]);const t=[];let n={words:[e[0]],minY:e[0].box[0][1],maxY:e[0].box[2][1]};for(let o=1;o<e.length;o++){const s=e[o],r=s.box[0][1];r<=n.maxY&&r>=n.minY-5?(n.words.push(s),n.minY=Math.min(n.minY,r),n.maxY=Math.max(n.maxY,s.box[2][1])):(t.push(this.mergeLine(n)),n={words:[s],minY:r,maxY:s.box[2][1]})}return n.words.length>0&&t.push(this.mergeLine(n)),t}mergeLine(e){e.words.sort((a,d)=>a.box[0][0]-d.box[0][0]);const t=Math.min(...e.words.map(a=>a.box[0][0])),n=Math.max(...e.words.map(a=>a.box[1][0])),o=Math.min(...e.words.map(a=>a.box[0][1])),s=Math.max(...e.words.map(a=>a.box[2][1])),r=e.words.map(a=>a.text).join(" "),l=e.words.reduce((a,d)=>a+d.confidence,0)/e.words.length;return{box:[[t,o],[n,o],[n,s],[t,s]],text:r,confidence:l}}async processPDF(e){const t=await e.arrayBuffer(),n=await te.getDocument({data:t}).promise,o=n.numPages,s=[];for(let r=1;r<=o;r++){const l=await n.getPage(r),a=l.getViewport({scale:2}),d=document.createElement("canvas"),h=d.getContext("2d");d.width=a.width,d.height=a.height,await l.render({canvasContext:h,viewport:a}).promise;const c=await new Promise(y=>d.toBlob(y,"image/png")),u=await this.worker.recognize(c),m=this.formatResults(u);s.push({page:r,results:m})}return s}async cleanup(){this.worker&&(await this.worker.terminate(),this.worker=null,this.initialized=!1)}}const oe=new Kt,H={detection:{det_limit_side_len:1920,det_db_thresh:.15,det_db_box_thresh:.2,det_db_unclip_ratio:2,det_db_min_size:5,det_db_max_candidates:3e3,grid_size:8,min_area_thresh:10},recognition:{rec_batch_num:16,drop_score:.3}};function Jt(i){i.CONFIG.det_limit_side_len=H.detection.det_limit_side_len,i.CONFIG.det_db_thresh=H.detection.det_db_thresh,i.CONFIG.det_db_box_thresh=H.detection.det_db_box_thresh,i.CONFIG.det_db_unclip_ratio=H.detection.det_db_unclip_ratio,i.CONFIG.det_db_min_size=H.detection.det_db_min_size,i.CONFIG.det_db_max_candidates=H.detection.det_db_max_candidates,i.CONFIG.grid_size=H.detection.grid_size,i.CONFIG.min_area_thresh=H.detection.min_area_thresh,i.CONFIG.rec_batch_num=H.recognition.rec_batch_num,i.CONFIG.drop_score=H.recognition.drop_score,console.log("PaddleOCR configuration updated for infographic processing")}const ze={detection:{det_limit_side_len:2560,det_db_thresh:.1,det_db_box_thresh:.15,det_db_unclip_ratio:1.6,det_db_min_size:3,det_db_max_candidates:5e3,grid_size:4,min_area_thresh:5},recognition:{rec_batch_num:32,drop_score:.1}},Zt={detection:{det_limit_side_len:1920,det_db_thresh:.08,det_db_box_thresh:.12,det_db_unclip_ratio:1.4,det_db_min_size:2,det_db_max_candidates:4e3,grid_size:8,min_area_thresh:3},recognition:{rec_batch_num:24,drop_score:.15}};function ke(i,e="general"){const t=e==="idcard"?ze:e==="receipt"?Zt:ze;i.CONFIG.det_limit_side_len=t.detection.det_limit_side_len,i.CONFIG.det_db_thresh=t.detection.det_db_thresh,i.CONFIG.det_db_box_thresh=t.detection.det_db_box_thresh,i.CONFIG.det_db_unclip_ratio=t.detection.det_db_unclip_ratio,i.CONFIG.det_db_min_size=t.detection.det_db_min_size,i.CONFIG.det_db_max_candidates=t.detection.det_db_max_candidates,i.CONFIG.grid_size=t.detection.grid_size,i.CONFIG.min_area_thresh=t.detection.min_area_thresh,i.CONFIG.rec_batch_num=t.recognition.rec_batch_num,i.CONFIG.drop_score=t.recognition.drop_score,console.log(`PaddleOCR configuration updated for ${e} processing`)}te.GlobalWorkerOptions.workerSrc="/client-ocr-app/pdf.worker.min.js";let re=null,M="tesseract",B="improved",N=oe,J=!1,Z=!1,pe=!1;Object.defineProperty(window,"currentEngine",{get:()=>M,set:i=>{console.warn("Attempted to set currentEngine directly. Use handleEngineChange instead.")}});const Re=document.getElementById("fileInput"),ie=document.getElementById("uploadArea"),Ue=document.getElementById("previewSection"),U=document.getElementById("previewImage"),Qt=document.getElementById("processBtn"),xe=document.getElementById("resultsSection"),Le=document.getElementById("loadingIndicator"),de=document.getElementById("ocrResults"),en=document.getElementById("copyBtn"),tn=document.getElementById("downloadBtn"),nn=document.getElementById("resetBtn");async function on(){var i,e;console.log("Initializing OCR engines..."),$("Loading OCR engines...","info");try{await Promise.all([ae.initialize(n=>{M==="paddle"&&B==="improved"&&$(n.message,n.status==="ready"?"success":"info");const o=document.querySelector("#loadingIndicator p");o&&n.progress!==void 0&&M==="paddle"&&B==="improved"&&(o.textContent=`${n.message} (${n.progress}%)`)}),ee.initialize(n=>{M==="paddle"&&B==="standard"&&$(n.message,n.status==="ready"?"success":"info")}),oe.initialize(n=>{M==="tesseract"&&$(n.message,n.status==="ready"?"success":"info")})]),console.log("OCR engines loaded successfully!"),$("Ready to process images","success"),sn();const t=document.querySelector('input[name="ocrEngine"]:checked');t&&(M=t.value,M==="paddle"?(N=B==="improved"?ae:ee,document.getElementById("paddleOptions").style.display="block"):(N=oe,document.getElementById("paddleOptions").style.display="none"),console.log("Initial engine set to:",M),console.log("Initial OCR engine object:",N))}catch(t){if(console.error("Failed to initialize OCR engines:",t),(i=t.message)!=null&&i.includes("onnx")||(e=t.message)!=null&&e.includes("ONNX")?Y("Failed to load PaddleOCR models. This may be due to browser compatibility issues. Please try using Tesseract.js instead."):Y("Failed to load OCR engines. Please check your internet connection and refresh the page."),oe.initialized){$("Tesseract.js is ready. PaddleOCR failed to load.","warning"),M="tesseract",N=oe;const n=document.getElementById("engineTesseract");n&&(n.checked=!0)}}}function sn(){ie.addEventListener("click",()=>Re.click()),Re.addEventListener("change",cn),ie.addEventListener("dragover",dn),ie.addEventListener("dragleave",ln),ie.addEventListener("drop",hn),Qt.addEventListener("click",un),en.addEventListener("click",gn),tn.addEventListener("click",pn),nn.addEventListener("click",fn),document.querySelectorAll('input[name="ocrEngine"]').forEach(e=>{console.log("Adding event listener to radio:",e.value,e),e.addEventListener("change",rn)});const i=document.querySelector('input[name="ocrEngine"]:checked');console.log("Initial checked engine:",i==null?void 0:i.value),document.querySelectorAll('input[name="preprocessing"]').forEach(e=>{e.addEventListener("change",an)}),document.getElementById("detectionModel").addEventListener("change",Ie),document.getElementById("recognitionModel").addEventListener("change",Ie),document.getElementById("dictionary").addEventListener("change",Ie),document.getElementById("infographicMode").addEventListener("change",xn),document.getElementById("documentMode").addEventListener("change",_n),document.getElementById("receiptMode").addEventListener("change",bn)}async function rn(i){const e=i.target.value;console.log("Engine change event - new value:",e),console.log("Engine change event - old currentEngine:",M),M=e,M==="paddle"?(N=B==="improved"?ae:ee,console.log("Set currentOCREngine to PaddleOCR:",B),console.log("Verify currentOCREngine:",N)):(N=oe,console.log("Set currentOCREngine to Tesseract"));const t=document.getElementById("paddleOptions");t.style.display=M==="paddle"?"block":"none",$(`Switched to ${M==="paddle"?"PaddleOCR":"Tesseract.js"}`,"info"),console.log("Final currentEngine:",M),console.log("Final currentOCREngine:",N)}async function an(i){if(B=i.target.value,M==="paddle"){if(N=B==="improved"?ae:ee,B==="standard"){const e=document.getElementById("detectionModel").value,t=document.getElementById("recognitionModel").value,n=document.getElementById("dictionary").value;ee.setModelConfig({detection:e,recognition:t,dictionary:n}),$("Loading standard preprocessing models...","info");try{await ee.initialize(o=>{$(o.message,o.status==="ready"?"success":"info")}),$("Standard preprocessing ready!","success")}catch(o){console.error("Failed to initialize standard preprocessing:",o),Y("Failed to load standard preprocessing models"),B="improved",N=ae,document.getElementById("preprocessImproved").checked=!0}}$(`Switched to ${B==="improved"?"Improved (PPU)":"Standard"} preprocessing`,"info")}}async function Ie(){if(M!=="paddle")return;const i=document.getElementById("detectionModel").value,e=document.getElementById("recognitionModel").value,t=document.getElementById("dictionary").value;B==="improved"?ae.setModelConfig({detection:i,recognition:e,dictionary:t}):ee.setModelConfig({detection:i,recognition:e,dictionary:t}),$("Loading new models...","info");try{await N.initialize(n=>{$(n.message,n.status==="ready"?"success":"info")}),$("Models updated successfully!","success")}catch(n){console.error("Failed to load new models:",n),Y("Failed to load new models. Please try again.")}}function cn(i){const e=i.target.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?Ye(e):Y("Please select a valid image or PDF file")}function dn(i){i.preventDefault(),ie.classList.add("dragover")}function ln(i){i.preventDefault(),ie.classList.remove("dragover")}function hn(i){i.preventDefault(),ie.classList.remove("dragover");const e=i.dataTransfer.files[0];e&&(e.type.startsWith("image/")||e.type==="application/pdf")?Ye(e):Y("Please drop a valid image or PDF file")}async function Ye(i){if(re){const e=U.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),re=null}if(de.innerHTML="",xe.style.display="none",re=i,Ue.style.display="block",xe.style.display="none",i.type==="application/pdf"){U.style.display="none";const e=U.parentElement;e.innerHTML="";const t=document.createElement("div");t.className="pdf-preview",t.innerHTML=`
            <div class="pdf-header">
                <h3>${i.name}</h3>
                <p class="pdf-info">Loading PDF preview...</p>
            </div>
            <div class="pdf-pages" id="pdfPages"></div>
        `,e.appendChild(t);try{const n=await i.arrayBuffer(),o=await te.getDocument({data:n}).promise,s=o.numPages,r=t.querySelector(".pdf-info");r.textContent=`${s} page${s>1?"s":""}`;const l=document.getElementById("pdfPages"),a=Math.min(s,3);for(let d=1;d<=a;d++){const h=await o.getPage(d),c=h.getViewport({scale:.5}),u=document.createElement("div");u.className="pdf-page-preview";const m=document.createElement("canvas"),y=m.getContext("2d");m.height=c.height,m.width=c.width;const v={canvasContext:y,viewport:c};await h.render(v).promise,u.innerHTML=`<p>Page ${d}</p>`,u.appendChild(m),l.appendChild(u)}s>3&&(l.innerHTML+=`<p class="more-pages">... and ${s-3} more pages</p>`)}catch(n){console.error("Error rendering PDF preview:",n),t.querySelector(".pdf-info").textContent="Error loading PDF preview"}}else{const e=document.querySelector(".pdf-placeholder");e&&e.remove(),U.style.display="block";const t=URL.createObjectURL(i);U.src=t,U.onload=()=>{$('Image loaded. Click "Extract Text" to process.',"success")},U.onerror=()=>{URL.revokeObjectURL(t),Y("Failed to load image")}}}async function un(){if(!re){Y("Please upload an image first");return}xe.style.display="block",Le.style.display="flex",de.innerHTML="";const i=document.querySelector("#loadingIndicator p");let e=M==="paddle"?"PaddleOCR":"Tesseract.js";M==="paddle"&&(e+=` (${B==="improved"?"Improved PPU":"Standard"})`),i&&(i.textContent=`Processing image with ${e}...`);try{console.log(`Processing image with ${e}...`),console.log("Current engine variable:",M),console.log("Current OCR engine object:",N),console.log("Current OCR engine name:",N.constructor.name),$("Detecting and recognizing text...","info");const t=performance.now();M==="paddle"&&N===oe&&(console.error("Engine mismatch detected! Expected PaddleOCR but got Tesseract"),N=B==="improved"?ae:ee,console.log("Forced engine to:",N));const n=await N.process(re),o=performance.now()-t;console.log(`Processing completed in ${o.toFixed(2)}ms`),console.log("OCR Results:",n),Le.style.display="none",n&&n.length>0?(Be(n,o,e),$(`Text extraction complete! Found ${n.length} text regions.`,"success")):(Be([],o,e),$("No text found in the image","warning"))}catch(t){if(console.error("OCR processing error:",t),console.error("Error code:",t.code),Le.style.display="none",M==="paddle"&&(t.code===30757872||t.message.includes("30757872"))){if(Y("PaddleOCR failed: ONNX Runtime error. The PP-OCRv5 model appears to be incompatible with your browser."),$("Consider using Tesseract.js for better compatibility","warning"),confirm("PaddleOCR failed due to browser compatibility. Would you like to switch to Tesseract.js?")){const o=document.getElementById("engineTesseract");o&&(o.checked=!0,o.dispatchEvent(new Event("change")))}}else Y("Failed to process image: "+t.message)}}function Be(i,e,t="PaddleOCR"){var s;const n=Array.isArray(i)&&((s=i[0])==null?void 0:s.page)!==void 0,o=M==="paddle"&&i.length>0&&i[0]&&i[0].box;if(console.log("Display check - currentEngine:",M,"isPaddleWithBoxes:",o,"results:",i),n){let r="",l=0,a="";i.forEach(d=>{const h=d.results.map(c=>c.text).join(`
`);r+=`
--- Page ${d.page} ---
${h}
`,l+=d.results.length,a+=`
                <div class="page-results">
                    <h4>Page ${d.page}</h4>
                    <ul class="detection-list">
                        ${d.results.map((c,u)=>`
                            <li data-index="${u}">
                                <span class="detection-index">${u+1}.</span>
                                <span class="detection-text">${se(c.text)}</span>
                                <span class="detection-confidence">${(c.confidence*100).toFixed(1)}%</span>
                            </li>
                        `).join("")}
                    </ul>
                </div>
            `}),de.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Pages Processed:</strong> ${i.length}</p>
                <p><strong>Total Text Regions:</strong> ${l}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${se(r||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details by Page:</h3>
                ${a}
            </div>
        `}else if(o)mn(i,e,t);else{const r=i.map(l=>l.text).join(`
`);de.innerHTML=`
            <div class="ocr-stats">
                <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
                <p><strong>Text Regions Found:</strong> ${i.length}</p>
                <p><strong>Engine:</strong> ${t}</p>
            </div>
            <div class="text-result">
                <h3>Extracted Text:</h3>
                <div class="text-content" id="extractedText">${se(r||"No text detected")}</div>
            </div>
            <div class="detection-results">
                <h3>Detection Details:</h3>
                <ul class="detection-list">
                    ${i.map((l,a)=>`
                        <li>
                            <span class="detection-index">${a+1}.</span>
                            <span class="detection-text">${se(l.text)}</span>
                            <span class="detection-confidence">${(l.confidence*100).toFixed(1)}%</span>
                        </li>
                    `).join("")}
                </ul>
            </div>
        `}}function mn(i,e,t){const n=i.map(s=>s.text).join(`
`),o=vn(i);de.innerHTML=`
        <div class="ocr-stats">
            <p><strong>Processing Time:</strong> ${(e/1e3).toFixed(2)}s</p>
            <p><strong>Text Regions Found:</strong> ${i.length}</p>
            <p><strong>Engine:</strong> ${t}</p>
            <p><strong>Average Confidence:</strong> ${yn(i)}%</p>
        </div>
        
        <div class="paddle-results-container">
            <div class="result-tabs">
                <button class="result-tab active" onclick="showResultTab('visual')">Visual Results</button>
                <button class="result-tab" onclick="showResultTab('text')">Text Only</button>
                <button class="result-tab" onclick="showResultTab('grouped')">Grouped by Line</button>
            </div>
            
            <div id="visualResults" class="tab-content active">
                <div class="result-image-container">
                    <img id="resultImage" src="${U.src}" alt="OCR Result">
                    <div class="bounding-box-overlay" id="boundingBoxOverlay"></div>
                </div>
                <div class="detection-results">
                    <h3>Detected Text Regions:</h3>
                    <ul class="detection-list" id="visualDetectionList">
                        ${i.map((s,r)=>{const l=He(s.confidence);return`
                                <li data-index="${r}" onmouseover="highlightBox(${r})" onmouseout="unhighlightBox(${r})" onclick="selectBox(${r})">
                                    <span class="detection-index">${r+1}.</span>
                                    <span class="detection-text">${se(s.text)}</span>
                                    <span class="detection-confidence ${l}">${(s.confidence*100).toFixed(1)}%</span>
                                </li>
                            `}).join("")}
                    </ul>
                </div>
            </div>
            
            <div id="textResults" class="tab-content grouped-results">
                <div class="text-result">
                    <h3>Extracted Text:</h3>
                    <div class="text-content" id="extractedText">${se(n||"No text detected")}</div>
                </div>
            </div>
            
            <div id="groupedResults" class="tab-content grouped-results">
                <h3>Text Grouped by Line:</h3>
                ${o.map((s,r)=>`
                    <div class="text-region-group">
                        <div class="region-header">
                            <span class="region-title">Line ${r+1}</span>
                            <div class="region-confidence">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${s.avgConfidence}%"></div>
                                </div>
                                <span class="confidence-text">${s.avgConfidence.toFixed(1)}%</span>
                            </div>
                        </div>
                        <p>${se(s.text)}</p>
                    </div>
                `).join("")}
            </div>
        </div>
    `,setTimeout(()=>We(i),100)}async function gn(){const i=document.getElementById("extractedText");if(i)try{await navigator.clipboard.writeText(i.textContent),wn("Text copied to clipboard!")}catch{Y("Failed to copy text")}}function pn(){const i=document.getElementById("extractedText");if(i){const e=i.textContent,t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`pp-ocrv5-result-${Date.now()}.txt`,o.click(),URL.revokeObjectURL(n)}}function fn(){if(re){const e=U.src;e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),re=null}Re.value="",Ue.style.display="none",xe.style.display="none",de.innerHTML="",U.src="";const i=U.parentElement;i.innerHTML='<img id="previewImage" alt="Preview">',window.previewImage=document.getElementById("previewImage"),$("Ready to process a new image","info")}function se(i){const e=document.createElement("div");return e.textContent=i,e.innerHTML}function Y(i){$(i,"error");const e=document.createElement("div");e.className="toast error",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},5e3)}function wn(i){const e=document.createElement("div");e.className="toast success",e.textContent=i,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}function $(i,e="info"){console.log(`[${e.toUpperCase()}] ${i}`);const t=document.getElementById("status");t&&(t.textContent=i,t.className=`status ${e}`)}function yn(i){return i.length===0?0:(i.reduce((t,n)=>t+n.confidence,0)/i.length*100).toFixed(1)}function He(i){const e=i*100;return e>=80?"high-confidence":e>=60?"medium-confidence":"low-confidence"}function vn(i){if(i.length===0)return[];const e=[...i].sort((o,s)=>{const r=Math.min(...o.box.map(a=>a[1])),l=Math.min(...s.box.map(a=>a[1]));return r-l}),t=[];let n=[e[0]];for(let o=1;o<e.length;o++){const s=Math.min(...e[o-1].box.map(l=>l[1])),r=Math.min(...e[o].box.map(l=>l[1]));Math.abs(r-s)<20?n.push(e[o]):(t.push(n),n=[e[o]])}return n.length>0&&t.push(n),t.map(o=>{o.sort((l,a)=>{const d=Math.min(...l.box.map(c=>c[0])),h=Math.min(...a.box.map(c=>c[0]));return d-h});const s=o.map(l=>l.text).join(" "),r=o.reduce((l,a)=>l+a.confidence,0)/o.length*100;return{text:s,avgConfidence:r,items:o}})}function We(i){const e=document.getElementById("boundingBoxOverlay"),t=document.getElementById("resultImage");if(!e||!t)return;if(e.innerHTML="",!t.complete){t.onload=()=>We(i);return}const n=t.getBoundingClientRect(),o=t.naturalWidth/n.width,s=t.naturalHeight/n.height;i.forEach((r,l)=>{const a=r.box,d=Math.min(...a.map(v=>v[0]))/o,h=Math.min(...a.map(v=>v[1]))/s,c=Math.max(...a.map(v=>v[0]))/o,u=Math.max(...a.map(v=>v[1]))/s,m=document.createElement("div");m.className=`text-box ${He(r.confidence)}`,m.dataset.index=l,m.style.left=`${d}px`,m.style.top=`${h}px`,m.style.width=`${c-d}px`,m.style.height=`${u-h}px`;const y=document.createElement("div");y.className="text-box-label",y.textContent=`${l+1}: ${(r.confidence*100).toFixed(0)}%`,m.appendChild(y),m.onclick=()=>selectBox(l),e.appendChild(m)})}window.showResultTab=function(i){document.querySelectorAll(".result-tab").forEach(e=>{e.classList.remove("active")}),event.target.classList.add("active"),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")}),i==="visual"?document.getElementById("visualResults").classList.add("active"):i==="text"?document.getElementById("textResults").classList.add("active"):i==="grouped"&&document.getElementById("groupedResults").classList.add("active")};window.highlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.add("hover"),t&&t.classList.add("highlighted")};window.unhighlightBox=function(i){const e=document.querySelector(`.text-box[data-index="${i}"]`),t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);e&&e.classList.remove("hover"),t&&t.classList.remove("highlighted")};window.selectBox=function(i){document.querySelectorAll(".text-box.selected").forEach(t=>{t.classList.remove("selected")});const e=document.querySelector(`.text-box[data-index="${i}"]`);if(e){e.classList.add("selected");const t=document.querySelector(`#visualDetectionList li[data-index="${i}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlighted"),setTimeout(()=>t.classList.remove("highlighted"),2e3))}};function xn(i){J=i.target.checked,console.log("Infographic mode:",J?"enabled":"disabled"),J&&Z&&(Z=!1,document.getElementById("documentMode").checked=!1),J&&M==="paddle"?(Jt(N),$("Infographic mode enabled - optimized for complex layouts","info")):!J&&M==="paddle"&&$("Infographic mode disabled","info")}function _n(i){Z=i.target.checked,console.log("Document mode:",Z?"enabled":"disabled"),Z&&J&&(J=!1,document.getElementById("infographicMode").checked=!1),Z&&M==="paddle"?(ke(N,"general"),$("Document mode enabled - optimized for official documents and ID cards","info")):!Z&&M==="paddle"&&$("Document mode disabled","info")}function bn(i){pe=i.target.checked,console.log("Receipt mode:",pe?"enabled":"disabled"),pe&&(J&&(J=!1,document.getElementById("infographicMode").checked=!1),Z&&(Z=!1,document.getElementById("documentMode").checked=!1)),pe&&M==="paddle"?(ke(N,"receipt"),$("Receipt mode enabled - optimized for thermal receipts and price extraction","info")):!pe&&M==="paddle"&&$("Receipt mode disabled","info")}document.addEventListener("DOMContentLoaded",on);
//# sourceMappingURL=index-BMj3uyOL.js.map
